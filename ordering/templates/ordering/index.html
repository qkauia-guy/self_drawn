<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% load static %}

    <title>ä¸€æŠŠè‘« {{ store.name }}åˆ†åº— - è‡ªåŠ©é»é¤</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="icon" href="{% static 'images/favicon.png' %}" type="image/png">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" 
        integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" 
        crossorigin="anonymous"></script>

    <style>
        :root { --strawberry: #ff4d4d; --bg-pink: #fffafa; }
        body { background-color: var(--bg-pink); font-family: "Microsoft JhengHei", sans-serif; }
        .card { border-radius: 18px; border: none; box-shadow: 0 4px 12px rgba(255, 77, 77, 0.1); }
        .btn-strawberry { background-color: var(--strawberry); color: white; border-radius: 12px; font-weight: bold; padding: 12px; }
        
        .qty-btn { width: 40px; height: 40px; border-radius: 10px; border: 2px solid var(--strawberry); background: white; color: var(--strawberry); font-weight: 900; font-size: 1.2rem; }
        .qty-btn:active { background: var(--strawberry); color: white; }
        
        .order-id-circle { 
            width: 110px; height: 110px; background: var(--strawberry); color: white; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 2.5rem; font-weight: 900; margin: 0 auto 15px; box-shadow: 0 4px 10px rgba(255, 77, 77, 0.3);
        }

        .status-box { font-size: 1.2rem; font-weight: bold; border-radius: 12px; padding: 18px; margin: 10px 0; border: 2px solid transparent; }
        .st-completed { background: #fff3f3; color: #d63031; border: 2px solid #ff4d4d; animation: pulse 1s infinite; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }
        .sticky-footer { position: sticky; bottom: 0; background: white; padding: 15px; border-top: 1px solid #eee; margin: 0 -12px; z-index: 100; }

        .custom-input { background-color: rgba(255, 255, 255, 0.5) !important; border: 1px solid rgba(255, 77, 77, 0.2) !important; color: #d63031 !important; }
        .detail-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #eee; padding: 5px 0; font-size: 0.95rem; }
        
        /* ä»˜æ¬¾æŒ‰éˆ•æ¨£å¼ */
        .btn-check:checked + .btn-outline-danger, .btn-check:checked + .btn-outline-success {
            color: #fff; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transform: translateY(-1px);
        }
        .accordion-button:not(.collapsed) {
            background-color: transparent !important;
            color: var(--strawberry) !important;
            box-shadow: none !important;
        }
        .accordion-button:focus {
            box-shadow: none !important;
            border-color: rgba(0,0,0,.125);
        }
        /* è®“å…§ç¸®çš„å•†å“å¡ç‰‡é‚Šè·ç¨å¾®èª¿æ•´ */
        .accordion-body.ms-3 {
            margin-right: 10px; /* ç¢ºä¿å³é‚Šä¸æœƒå¤ªè²¼ */
        }
        /* ç¢ºä¿æ¨™é¡Œé»æ“Šå€åŸŸæ»¿ç‰ˆ */
        .accordion-header {
            margin-bottom: 0;
        }

        .accordion-button {
            position: relative;
            display: flex;
            align-items: center;
            width: 100%;
            text-align: left;
            overflow-anchor: none;
            transition: all 0.2s;
        }

        /* è®“å…§ç¸®æ›´æ˜é¡¯ */
        .accordion-body.ms-3 {
            border-left: 1px solid rgba(255, 77, 77, 0.1); /* æ·¡æ·¡çš„å‚ç›´ç·šå¢åŠ è¦–è¦ºå¼•å° */
            margin-left: 1rem !important;
            padding-left: 0.5rem;
        }

        /* ä¿®æ­£ Bootstrap ç®­é ­é¡è‰² */
        .accordion-button::after {
            filter: sepia(100%) saturate(10000%) hue-rotate(320deg); /* è®Šæˆç´…è‰²ç®­é ­ */
        }

        /* å”®å®Œå•†å“çš„å¾®èª¿ */
        .product-item.opacity-75 {
            filter: grayscale(0.5);
        }

        /* âœ… å±•é–‹ä¸­çš„ç³»åˆ—ï¼šç”¨ä¸åŒé¡è‰²å€åˆ†ï¼ˆåˆ©ç”¨ Bootstrap ç‹€æ…‹ï¼šnot(.collapsed)ï¼‰ */
        .accordion-button:not(.collapsed) {
            border-radius: 12px;
        }

        /* Drink */
        .accordion-button.cat-drink:not(.collapsed){
            background: rgba(13, 110, 253, 0.10) !important;
            color: #0d6efd !important;
            border-left: 6px solid #0d6efd;
        }

        /* Tanghulu */
        .accordion-button.cat-tanghulu:not(.collapsed){
            background: rgba(255, 77, 77, 0.10) !important;
            color: #ff4d4d !important;
            border-left: 6px solid #ff4d4d;
        }

        /* Mochi */
        .accordion-button.cat-mochi:not(.collapsed){
            background: rgba(255, 193, 7, 0.14) !important;
            color: #b78100 !important;
            border-left: 6px solid #ffc107;
        }

        /* Ichikomochi */
        .accordion-button.cat-ichikomochi:not(.collapsed){
            background: rgba(25, 135, 84, 0.12) !important;
            color: #198754 !important;
            border-left: 6px solid #198754;
        }

        /* Dessert */
        .accordion-button.cat-dessert:not(.collapsed){
            background: rgba(111, 66, 193, 0.12) !important;
            color: #6f42c1 !important;
            border-left: 6px solid #6f42c1;
        }

        /* âœ… ç®­é ­è·Ÿè‘—è®Šè‰²ï¼ˆBootstrap 5 çš„ç®­é ­æ˜¯ ::afterï¼‰ */
        .accordion-button.cat-drink:not(.collapsed)::after { filter: none; }
        .accordion-button.cat-tanghulu:not(.collapsed)::after { filter: none; }
        .accordion-button.cat-mochi:not(.collapsed)::after { filter: none; }
        .accordion-button.cat-ichikomochi:not(.collapsed)::after { filter: none; }
        .accordion-button.cat-dessert:not(.collapsed)::after { filter: none; }
        .accordion-button.has-items {
            border-radius: 12px;
            background: rgba(255, 77, 77, 0.12) !important;  /* æ·¡ç²‰ç´…åº• */
            color: #d63031 !important;
            border-left: 6px solid #ff4d4d;
        }

        /* å¦‚æœä½ è¦ã€Œä¸åŒç³»åˆ—ä¸åŒé¡è‰²ã€ï¼šç”¨ data-cat ä¾†åˆ†è‰²ï¼ˆä¸‹é¢ JS æœƒè£œä¸Š data-catï¼‰ */
        .accordion-button.has-items[data-cat="drink"] { background: rgba(13,110,253,0.10) !important; border-left-color:#0d6efd; color:#0d6efd !important; }
        .accordion-button.has-items[data-cat="tanghulu"] { background: rgba(255,77,77,0.12) !important; border-left-color:#ff4d4d; color:#d63031 !important; }
        .accordion-button.has-items[data-cat="mochi"] { background: rgba(255,193,7,0.16) !important; border-left-color:#ffc107; color:#b78100 !important; }
        .accordion-button.has-items[data-cat="ichikomochi"] { background: rgba(25,135,84,0.14) !important; border-left-color:#198754; color:#198754 !important; }
        .accordion-button.has-items[data-cat="dessert"] { background: rgba(111,66,193,0.14) !important; border-left-color:#6f42c1; color:#6f42c1 !important; }
            </style>
</head>
<body>

<div class="container py-4">
    <!-- ä¸‹å–®å€å¡Š -->
    <div id="orderForm">
        <div class="text-center">
            <h1 class="display-5 fw-bold text-danger">ğŸ“ ä¸€æŠŠè‘«</h1>
            <p class="badge bg-danger rounded-pill px-3">{{ store.name }}åˆ†åº— è‡ªåŠ©é»é¤</p>
        </div>

        <div class="card mb-2 p-3 shadow-sm">
            <label class="form-label fw-bold">1. è¼¸å…¥å®¢æˆ¶ä»£è™Ÿ(å¿…å¡«)</label>
            <input type="text" id="phone_tail" class="form-control form-control-lg text-center fw-bold text-danger custom-input" maxlength="4" inputmode="numeric" placeholder="è«‹è¼¸å…¥æ‰‹æ©Ÿå¾Œ 4 ç¢¼">
        </div>

        <div class="card mb-2 p-3 shadow-sm">
            <label class="form-label fw-bold">2. é¸æ“‡ä»˜æ¬¾æ–¹å¼</label>
            <div class="d-flex gap-2">
                <input type="radio" class="btn-check" name="paymentMethod" id="payCash" value="cash" checked>
                <label class="btn btn-outline-danger flex-grow-1 fw-bold py-3" for="payCash">çª—å£ä»˜ç¾</label>

                <input type="radio" class="btn-check" name="paymentMethod" id="payLine" value="linepay">
                <label class="btn btn-outline-success flex-grow-1 fw-bold py-3" for="payLine"> LINE Pay</label>
            </div>
        </div>

        <label class="form-label fw-bold mb-3 text-secondary text-center w-100">3. é¸æ“‡é¤é»åŠæ•¸é‡</label>
        <div id="productList" class="mb-5 pb-5"></div>

        <div class="sticky-footer shadow-lg text-center">
            <div class="d-flex justify-content-between h4 mb-3 px-2">
                <span>åˆè¨ˆé‡‘é¡ï¼š</span><span id="display_total" class="text-danger fw-bold">$0</span>
            </div>
            <button class="btn btn-strawberry w-100 btn-lg shadow" onclick="handleOrderConfirm()">ç¢ºèªé¤é»ä¸¦é€å‡º</button>
        </div>
    </div>

    <!-- ç‹€æ…‹å€å¡Š -->
    <div id="statusPage" class="d-none animate__animated animate__fadeIn">
        <div class="card p-4 text-center shadow">
            <div class="order-id-circle shadow" id="display_order_id">--</div>
            <h5 class="text-muted fw-bold">æ‚¨çš„è¨‚å–®ç·¨è™Ÿ</h5>
            <p class="small text-muted mb-4">ä¸‹å–®æ™‚é–“: <span id="created_time"></span></p>
            
            <div id="statusBox" class="status-box bg-light text-secondary">âŒ› è¨‚å–®ç™¼é€ä¸­...</div>

            <div id="pickupInfo" class="d-none mt-3 animate__animated animate__shakeX">
                <div class="alert alert-danger py-3 border-danger border-3 shadow-sm">
                    <h4 class="fw-bold mb-2">ğŸ“£ é¤é»å¥½å›‰ï¼</h4>
                    <p class="mb-3 fs-5">è«‹å‘ŠçŸ¥åº—å®¶æ‚¨çš„å–®è™Ÿï¼š<strong>#<span id="info_id"></span></strong></p>
                    <button id="arrivedBtn" class="btn btn-danger w-100 py-3 fw-bold fs-5 shadow-sm mb-2" onclick="stopAlarmAndNotify()">å·²åˆ°æ«ƒæª¯(é€šçŸ¥é ˜å–)</button>
                    <button id="finalBtn" class="btn btn-success w-100 py-3 fw-bold fs-5 shadow-sm d-none" onclick="finishOrder()">å·²é ˜å–é¤é»</button>
                </div>
            </div>

            <div class="bg-light rounded p-3 text-start mt-4">
                <p class="border-bottom pb-2 fw-bold mb-2">ğŸ“‹ æ‚¨çš„è¨‚å–®ç´°é …ï¼š</p>
                <div id="order_details_list" class="mb-3"></div>
                <div class="d-flex justify-content-between mb-1">
                    <span>æ‰‹æ©Ÿæœ«ç¢¼ï¼š</span><strong id="display_phone" class="text-dark"></strong>
                </div>
                <div class="d-flex justify-content-between mb-1">
                    <span>ä»˜æ¬¾æ–¹å¼ï¼š</span><strong id="display_payment" class="text-primary"></strong>
                </div>
                <hr class="my-2">
                <div class="d-flex justify-content-between">
                    <span>æ‡‰ä»˜é‡‘é¡ï¼š</span><strong class="text-danger h4">$<span id="display_final_total"></span></strong>
                </div>
            </div>
            <p class="text-muted small mt-4">â€» è«‹å‹¿é—œé–‰æ­¤é é¢ï¼Œç³»çµ±å°‡è‡ªå‹•æ›´æ–°ç‹€æ…‹</p>
        </div>
    </div>
</div>

<script>
    const currentStoreSlug = window.location.pathname.split('/').filter(p => p)[0];
    let alarmAudio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
    alarmAudio.loop = true;
    // é è¼‰å…¥éŸ³è¨Šï¼Œç¢ºä¿å¯ä»¥æ’­æ”¾
    alarmAudio.preload = 'auto';
    // è™•ç†éŸ³è¨Šè¼‰å…¥éŒ¯èª¤
    alarmAudio.addEventListener('error', (e) => {
        console.error('éŸ³è¨Šè¼‰å…¥å¤±æ•—:', e);
        // å¦‚æœå¤–éƒ¨éŸ³è¨Šè¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨å…§å»ºéŸ³è¨Š
        try {
            alarmAudio = new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU');
            alarmAudio.loop = true;
            alarmAudio.preload = 'auto';
        } catch (err) {
            console.error('ç„¡æ³•å»ºç«‹å‚™ç”¨éŸ³è¨Š:', err);
        }
    });
    let vibrationInterval = null, vibrationTimer = null;
    let audioUnlocked = false;

    // --- åˆå§‹åŒ–: æª¢æŸ¥æ˜¯å¦ç‚º LINE Pay è·³å›ä¾†çš„å®¢äºº ---
    window.onload = function() {
        fetchProducts();

        // å®šç¾©è§£é–éŸ³æ•ˆå‡½å¼ (é€™éƒ¨åˆ†ä¿æŒåŸæœ¬é‚è¼¯ï¼Œä½†æ‹‰å‡ºä¾†å…±ç”¨)
        const unlockAudio = () => {
            if (!audioUnlocked) {
                try {
                    // æ’­æ”¾ä¸€ç¬é–“éœéŸ³ï¼Œé¨™éç€è¦½å™¨å·²ç²å–æ¬Šé™
                    alarmAudio.play().then(() => {
                        alarmAudio.pause();
                        alarmAudio.currentTime = 0;
                        audioUnlocked = true;
                        console.log('éŸ³è¨Šå·²è§£é–');
                    }).catch(e => {
                        console.log('éŸ³è¨Šè§£é–å°šæœªå°±ç·’:', e);
                    });
                } catch (e) { console.log(e); }
            }
        };

        // å…¨åŸŸé»æ“Šè§£é– (ä¿ç•™å‚™ç”¨)
        document.addEventListener('click', unlockAudio, { once: true });
        document.addEventListener('touchstart', unlockAudio, { once: true });

        // è§£æç¶²å€åƒæ•¸
        const urlParams = new URLSearchParams(window.location.search);
        const oid = urlParams.get('oid');
        const error = urlParams.get('error');

        // éŒ¯èª¤è™•ç† (ä¿ç•™åŸæœ¬é‚è¼¯)
        if (error) {
            let errorMsg = 'ç™¼ç”ŸéŒ¯èª¤';
            if (error === 'missing_transaction') errorMsg = 'LINE Pay äº¤æ˜“è³‡è¨Šç¼ºå¤±';
            else if (error === 'payment_failed') errorMsg = 'LINE Pay ä»˜æ¬¾å¤±æ•—';
            else if (error === 'cancelled') errorMsg = 'å·²å–æ¶ˆä»˜æ¬¾';
            else if (error === 'server_error') errorMsg = 'ä¼ºæœå™¨éŒ¯èª¤';
            
            Swal.fire({
                icon: 'error',
                title: 'ä»˜æ¬¾å•é¡Œ',
                text: errorMsg,
                confirmButtonColor: '#ff4d4d'
            }).then(() => {
                window.location.href = window.location.pathname;
            });
            return;
        }

        // --- é—œéµä¿®æ”¹é–‹å§‹ ---
        if (oid) {
            // ä¸ç›´æ¥æŸ¥è©¢ï¼Œå…ˆå½ˆå‡ºè¦–çª—å¼·è¿«ä½¿ç”¨è€…äº’å‹•
            Swal.fire({
                title: 'ğŸ‰ ä»˜æ¬¾æˆåŠŸï¼',
                html: 'è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•<br>ä»¥<b>é–‹å•Ÿå«è™Ÿé€šçŸ¥éŸ³æ•ˆ</b>',
                icon: 'success',
                confirmButtonText: 'é–‹å§‹ç­‰å€™å«è™Ÿ (é–‹å•Ÿé€šçŸ¥)',
                confirmButtonColor: '#ff4d4d',
                allowOutsideClick: false, // ç¦æ­¢é»æ“ŠèƒŒæ™¯é—œé–‰
                allowEscapeKey: false,
                didOpen: () => {
                    // åœ¨å½ˆçª—å‡ºç¾æ™‚å˜—è©¦é è¼‰
                    alarmAudio.load();
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    // 1. åœ¨é€™è£¡åŸ·è¡Œè§£é–ï¼Œé€™æ˜¯ä½¿ç”¨è€…çœŸå¯¦çš„é»æ“Šè¡Œç‚ºï¼Œç€è¦½å™¨æœƒå…è¨±
                    unlockAudio();
                    
                    // 2. ç‚ºäº†ä¿éšªï¼Œå¦‚æœæ˜¯ iOSï¼Œå¯ä»¥åŠ ä¸€å€‹æ¥µçŸ­çš„éœ‡å‹•æ¸¬è©¦
                    if ("vibrate" in navigator) navigator.vibrate(100);

                    // 3. ç¹¼çºŒåŸæœ¬çš„æŸ¥è©¢æµç¨‹
                    fetchOrderAndSwitch(oid);
                }
            });
        }
        // --- é—œéµä¿®æ”¹çµæŸ ---
    };

    // å°‡åŸæœ¬ fetch è¨‚å–®çš„é‚è¼¯æŠ½æˆå‡½å¼ï¼Œæ–¹ä¾¿ä¸Šé¢å‘¼å«
    function fetchOrderAndSwitch(oid) {
        fetch(`/api/orders/${oid}/?t=${Date.now()}`)
            .then(res => {
                if (!res.ok) {
                    if (res.status === 403) {
                        Swal.fire({ icon: 'warning', title: 'ç„¡æ³•æŸ¥è©¢', text: 'è¨‚å–®ç·¨è™ŸéŒ¯èª¤' });
                        return null;
                    }
                    throw new Error(`HTTP ${res.status}`);
                }
                return res.json();
            })
            .then(order => {
                if (order) {
                    switchToStatusPage(oid, order);
                }
            })
            .catch(err => {
                console.error('æŸ¥è©¢è¨‚å–®å¤±æ•—:', err);
                Swal.fire({ icon: 'error', title: 'æŸ¥è©¢å¤±æ•—', text: 'ç„¡æ³•è¼‰å…¥è¨‚å–®' });
            });
    }

    function fetchProducts() {
        fetch(`/api/products/?store=${currentStoreSlug}&t=${Date.now()}`)
            .then(res => res.json())
            .then(data => {
                const list = document.getElementById('productList');
                list.innerHTML = '';

                const categoryMap = {
                    'drink': 'é£²å“ç³»åˆ—',
                    'tanghulu': 'ç³–è‘«è˜†ç³»åˆ—',
                    'mochi': 'Qè»Ÿéº»ç³¬ç³»åˆ—',
                    'ichikomochi': 'å…ƒå¯¶éº»ç³¬ç³»åˆ—',
                    'dessert': 'è‰è“ç”œé»ç³»åˆ—'
                };

                const accordionId = "productAccordion";
                let accordionHTML = `<div class="accordion accordion-flush" id="${accordionId}">`;

                Object.entries(categoryMap).forEach(([catKey, catLabel]) => {
                    const filteredProducts = data.filter(p => p.category === catKey);
                    if (filteredProducts.length === 0) return;

                    const isFirst = catKey === 'drink'; // é£²å“é è¨­å±•é–‹
                    const collapseId = `collapse_${catKey}`;
                    const headerId = `heading_${catKey}`;

                    accordionHTML += `
                    <div class="accordion-item bg-transparent border-0 mb-3">
                        <h2 class="accordion-header" id="${headerId}">
                            <button class="accordion-button cat-${catKey} ${isFirst ? '' : 'collapsed'} bg-transparent fw-bold text-danger fs-5 p-2 shadow-none"
                                    data-cat="${catKey}"
                                    type="button"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#${collapseId}"
                                    aria-expanded="${isFirst ? 'true' : 'false'}"
                                    aria-controls="${collapseId}">
                                <span class="border-start border-4 border-danger ps-2">${catLabel}</span>
                            </button>
                        </h2>

                        <div id="${collapseId}" class="accordion-collapse collapse ${isFirst ? 'show' : ''}"
                            aria-labelledby="${headerId}"
                            data-bs-parent="#${accordionId}">
                            <div class="accordion-body p-0 pt-2 ms-3">
                                ${filteredProducts.map(p => {
                                    const isSoldOut = p.stock <= 0 || !p.is_active;

                                    const statusLabel = isSoldOut
                                        ? `<span class="badge bg-secondary">ä»Šæ—¥å”®å®Œ</span>`
                                        : `<small class="text-muted">å‰©é¤˜åº«å­˜: ${p.stock}</small>`;

                                    return `
                                    <div class="card mb-3 p-1 product-item ${isSoldOut ? 'opacity-75 bg-light' : ''}">
                                        <div class="card-body d-flex justify-content-between align-items-center p-3">
                                            <div class="flex-grow-1">
                                                <div class="fw-bold h6 mb-1">${p.name}</div>
                                                <div class="text-danger fw-bold small">$${p.price}</div>
                                                ${statusLabel}
                                            </div>

                                            <div class="d-flex align-items-center gap-2">
                                                <button class="qty-btn" onclick="changeQty('${p.id}', -1)" ${isSoldOut ? 'disabled' : ''}>-</button>

                                                <input type="number"
                                                    id="qty_${p.id}"
                                                    class="form-control item-qty border-0 bg-transparent text-center fw-bold fs-5"
                                                    style="width: 45px"
                                                    value="0"
                                                    readonly
                                                    data-id="${p.id}"
                                                    data-price="${p.price}"
                                                    data-name="${p.name}"
                                                    data-flavors="${p.flavor_options || ''}">

                                                <button class="qty-btn" onclick="changeQty('${p.id}', 1)" ${isSoldOut ? 'disabled' : ''}>+</button>
                                            </div>
                                        </div>
                                    </div>`;
                                }).join('')}
                            </div>
                        </div>
                    </div>`;
                });

                accordionHTML += `</div>`;
                list.innerHTML = accordionHTML;

                // åˆå§‹åŒ–å‹•æ…‹ç”¢ç”Ÿçš„ Collapseï¼ˆéœ€è¦ bootstrap.bundle.min.jsï¼‰[web:23]
                setTimeout(() => {
                    const accElems = list.querySelectorAll('.accordion-collapse');
                    accElems.forEach(el => {
                        bootstrap.Collapse.getOrCreateInstance(el, { toggle: false });
                    });

                    // âœ… åˆå§‹åŒ–æ™‚å…ˆè·‘ä¸€æ¬¡ï¼šè®“ã€Œå·²é¸ç³»åˆ—ã€ç‹€æ…‹æ­£ç¢ºï¼ˆä¾‹å¦‚ï¼šè¿”å›é é¢æˆ–æœ‰é è¨­å€¼ï¼‰
                    refreshCategoryPickedState();
                }, 50);

                updateTotal(); // é€™è£¡é¢ä¹Ÿæœƒ refreshCategoryPickedState()
            })
            .catch(err => console.error("è¼‰å…¥å•†å“å¤±æ•—:", err));
    }



    function changeQty(id, delta) {
        const input = document.getElementById(`qty_${id}`);
        if (!input) return;
        let val = parseInt(input.value) + delta;
        if (val < 0) val = 0;
        input.value = val;
        updateTotal();
    }

    function updateTotal() {
        let t = 0;
        document.querySelectorAll('.item-qty').forEach(i => t += (parseInt(i.value) || 0) * parseInt(i.dataset.price));
        document.getElementById('display_total').innerText = '$' + t;
        refreshCategoryPickedState();
    }

    function refreshCategoryPickedState() {
        document.querySelectorAll('.accordion-collapse').forEach(collapseEl => {
            const item = collapseEl.closest('.accordion-item');
            if (!item) return;

            const btn = item.querySelector('.accordion-button');
            if (!btn) return;

            const hasPicked = Array.from(collapseEl.querySelectorAll('.item-qty'))
                .some(input => (parseInt(input.value, 10) || 0) > 0);

            btn.classList.toggle('has-items', hasPicked);
        });
    }


    function renderOrderDetailList(items) {
        let html = "";
        items.forEach(i => {
            const q = i.quantity || i.qty;
            const price = i.price;
            const sub = q * price;
            html += `
                <div class="detail-row d-flex justify-content-between border-bottom py-2">
                    <span>
                        <div class="fw-bold">${i.name}</div>
                        <small class="text-muted">$${price} x ${q}</small>
                    </span>
                    <span class="fw-bold align-self-center">$${sub}</span>
                </div>`;
        });
        const container = document.getElementById('order_details_list');
        if (container) container.innerHTML = html;
    }

    async function handleOrderConfirm() {
        const phone = document.getElementById('phone_tail').value;
        const paymentRadio = document.querySelector('input[name="paymentMethod"]:checked');
        const paymentMethod = paymentRadio ? paymentRadio.value : 'cash';
        const paymentLabel = paymentRadio ? document.querySelector(`label[for="${paymentRadio.id}"]`).innerText : 'ç¾é‡‘';

        if (phone.length !== 4) {
            return Swal.fire({ icon: 'warning', title: 'æ ¼å¼éŒ¯èª¤', text: 'è«‹è¼¸å…¥æ‰‹æ©Ÿå¾Œ 4 ç¢¼ï¼', confirmButtonColor: '#ff4d4d' });
        }

        let finalItems = [];
        let totalAmount = 0;
        let tableRowsHtml = ""; 
        const inputs = document.querySelectorAll('.item-qty');

        // éæ­·æ‰€æœ‰å·²é»å•†å“
        for (let input of inputs) {
            const q = parseInt(input.value);
            if (q <= 0) continue;

            const baseName = input.dataset.name;
            const price = parseInt(input.dataset.price);
            const flavorsStr = input.dataset.flavors;

            // å¦‚æœæœ‰å£å‘³é¸é …ï¼Œå½ˆå‡º Select é¸å–®
            if (flavorsStr && flavorsStr.trim() !== "") {
                const flavorArray = flavorsStr.split(',');
                const selectOptions = {};
                flavorArray.forEach(f => {
                    const fName = f.trim();
                    if(fName) selectOptions[fName] = fName;
                });

                const { value: selectedFlavor } = await Swal.fire({
                    title: `è«‹é¸æ“‡å£å‘³`,
                    html: `é»è³¼å•†å“ï¼š<b>${baseName}</b>`,
                    input: 'select',
                    inputOptions: selectOptions,
                    inputPlaceholder: '-- è«‹é¸æ“‡ä¸€å€‹å£å‘³ --',
                    showCancelButton: true,
                    confirmButtonColor: '#ff4d4d',
                    inputValidator: (value) => !value && 'æ‚¨å¿…é ˆé¸æ“‡ä¸€å€‹å£å‘³æ‰èƒ½ä¸‹å–®å–”ï¼'
                });

                if (!selectedFlavor) return; // å®¢äººæŒ‰å–æ¶ˆå‰‡çµ‚æ­¢æµç¨‹

                const finalName = `${baseName} (${selectedFlavor})`;
                finalItems.push({ id: input.dataset.id, name: finalName, quantity: q, price: price });
                tableRowsHtml += `<tr><td class="text-start">${finalName}</td><td>x${q}</td><td class="text-end">$${q * price}</td></tr>`;
                totalAmount += (q * price);

            } else {
                // ä¸€èˆ¬å•†å“
                finalItems.push({ id: input.dataset.id, name: baseName, quantity: q, price: price });
                tableRowsHtml += `<tr><td class="text-start">${baseName}</td><td>x${q}</td><td class="text-end">$${q * price}</td></tr>`;
                totalAmount += (q * price);
            }
        }

        if (finalItems.length === 0) {
            return Swal.fire({ icon: 'info', title: 'è³¼ç‰©è»Šç©ºç©ºçš„', text: 'æ‚¨é‚„æ²’é¸æ“‡å•†å“å–”ï¼', confirmButtonColor: '#ff4d4d' });
        }

        // æœ€å¾Œç¢ºèªè¦–çª—
        Swal.fire({
            title: 'è¨‚å–®ç¢ºèª',
            html: `
                <div class="mb-2 text-start bg-light p-2 rounded border">
                    <span class="text-muted small">ä»˜æ¬¾æ–¹å¼ï¼š</span>
                    <span class="badge ${paymentMethod==='linepay'?'bg-success':'bg-danger'} fs-6">${paymentLabel}</span>
                </div>
                <table class="table table-sm border-top mt-2" style="font-size: 0.85rem;">
                    <thead><tr class="table-light"><th class="text-start">å“å</th><th>æ•¸é‡</th><th class="text-end">å°è¨ˆ</th></tr></thead>
                    <tbody>${tableRowsHtml}</tbody>
                    <tfoot><tr class="table-warning"><td colspan="2" class="text-end fw-bold">ç¸½è¨ˆé‡‘é¡ï¼š</td><td class="text-end fw-bold text-danger">$${totalAmount}</td></tr></tfoot>
                </table>`,
            showCancelButton: true,
            confirmButtonColor: paymentMethod==='linepay' ? '#2db400' : '#ff4d4d',
            confirmButtonText: paymentMethod==='linepay' ? 'å‰å¾€ LINE Pay ä»˜æ¬¾' : 'ç¢ºå®šä¸‹å–®',
            cancelButtonText: 'è¿”å›ä¿®æ”¹'
        }).then((result) => {
            if (result.isConfirmed) {
                if (paymentMethod === 'linepay') {
                    Swal.fire({ title: 'æ­£åœ¨é€£æ¥ LINE Pay...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });
                }
                submitOrder(phone, finalItems, totalAmount, paymentMethod);
            }
        });
    }

    function submitOrder(phone, items, total, paymentMethod) {
        fetch('/api/orders/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
            body: JSON.stringify({
                store_slug: currentStoreSlug,
                phone_tail: phone,
                items: items,
                subtotal: total,
                total: total,
                payment_method: paymentMethod
            })
        })
        .then(res => {
            if (!res.ok) return res.json().then(err => { throw new Error(err.error || 'ä¼ºæœå™¨ç™¼ç”ŸéŒ¯èª¤'); });
            return res.json();
        })
        .then(order => {
            Swal.close();
            if (order.payment_method === 'linepay' && order.payment_url) {
                window.location.href = order.payment_url;
                return;
            }
            switchToStatusPage(order.id, order);
        })
        .catch(err => {
            Swal.close();
            Swal.fire({ icon: 'error', title: 'ä¸‹å–®å¤±æ•—', text: err.message, confirmButtonColor: '#ff4d4d' });
        });
    }


    // å°‡åˆ‡æ›é é¢çš„é‚è¼¯ç¨ç«‹å‡ºä¾†
    function switchToStatusPage(oid, orderData = null) {
        document.getElementById('orderForm').classList.add('d-none');
        document.getElementById('statusPage').classList.remove('d-none');
        document.getElementById('display_order_id').innerText = oid;
        
        startPolling(oid);
        
        // å¦‚æœæœ‰å‚³å…¥ç¾æˆè³‡æ–™å°±ç›´æ¥é¡¯ç¤ºï¼Œä¸ç„¶è¼ªè©¢æœƒè‡ªå·±æŠ“
        if (orderData) {
            document.getElementById('display_phone').innerText = orderData.phone_tail || '';
            document.getElementById('display_final_total').innerText = orderData.total || 0;
            
            // [FIXED] é€™è£¡ä¿®å¾©äº† undefined å•é¡Œ
            const pMethodMap = {'cash': 'ç¾é‡‘', 'linepay': 'LINE Pay'};
            document.getElementById('display_payment').innerText = pMethodMap[orderData.payment_method] || orderData.payment_method || 'æœªæŒ‡å®š';
            
            document.getElementById('created_time').innerText = new Date().toLocaleTimeString();
            renderOrderDetailList(orderData.items);
        }
    }

    function startPolling(oid) {
        const fetchStatus = () => {
            fetch(`/api/orders/${oid}/?t=${Date.now()}`)
                .then(res => {
                    if (!res.ok) {
                        // å¦‚æœæ˜¯ 403 æˆ– 404ï¼Œå¯èƒ½æ˜¯æ¬Šé™å•é¡Œæˆ–è¨‚å–®ä¸å­˜åœ¨
                        if (res.status === 403 || res.status === 404) {
                            console.error('ç„¡æ³•æŸ¥è©¢è¨‚å–®ï¼Œå¯èƒ½å·²éæœŸæˆ–ç„¡æ¬Šé™');
                            return;
                        }
                        throw new Error(`HTTP ${res.status}`);
                    }
                    return res.json();
                })
                .then(order => {
                    if (order) {
                        updateStatusUI(order);
                    }
                })
                .catch(err => {
                    console.error('æŸ¥è©¢è¨‚å–®ç‹€æ…‹å¤±æ•—:', err);
                    // ä¸ä¸­æ–·è¼ªè©¢ï¼Œç¹¼çºŒå˜—è©¦
                });
        };
        fetchStatus(); 
        const timer = setInterval(fetchStatus, 4000);
        // å„²å­˜ timer ID ä»¥ä¾¿éœ€è¦æ™‚æ¸…é™¤
        window.pollingTimer = timer;
    }

    let hasNotified = false;    // ç´€éŒ„æ˜¯å¦å·²ç¶“ç™¼å‡ºéè²éŸ³/éœ‡å‹•
    let lastStatus = null;      // ç´€éŒ„ä¸Šä¸€æ¬¡çš„è¨‚å–®ç‹€æ…‹

    function updateStatusUI(order) {
        const box = document.getElementById('statusBox');
        const pickupInfo = document.getElementById('pickupInfo');
        const arrivedBtn = document.getElementById('arrivedBtn');
        const finalBtn = document.getElementById('finalBtn');

        // 1. åŸºæœ¬è³‡è¨Šæ›´æ–°
        document.getElementById('display_final_total').innerText = order.total;
        document.getElementById('display_phone').innerText = order.phone_tail;
        const pMethodMap = { 'cash': 'ç¾é‡‘', 'linepay': 'LINE Pay' };
        document.getElementById('display_payment').innerText = pMethodMap[order.payment_method] || 'æœªæŒ‡å®š';
        renderOrderDetailList(order.items);

        // 2. ç‹€æ…‹æª¢æŸ¥ï¼šå¦‚æœç‹€æ…‹æ”¹è®Šäº†ï¼Œå°±é‡ç½®é€šçŸ¥æ——æ¨™
        if (lastStatus !== order.status) {
            if (order.status !== 'completed') {
                hasNotified = false; // é›¢é–‹å®Œæˆç‹€æ…‹å°±é‡ç½®
                stopAllAlerts();     // ç‹€æ…‹æ”¹è®Šï¼ˆå¦‚è®Šæˆ arrivedï¼‰ï¼Œç«‹å³åœæ­¢éœ‡å‹•
            }
            lastStatus = order.status;
        }

        // --- 3. ç‹€æ…‹é‚è¼¯åˆ†æµ ---

        // A. è¨‚å–®çµæŸ (çµæ¡ˆæˆ–å–æ¶ˆ)
        if (order.status === 'final' || order.status === 'cancelled') {
            box.innerHTML = order.status === 'final' ? "ğŸ“ ç¥æ‚¨ç”¨é¤æ„‰å¿«ï¼" : "âŒ è¨‚å–®å·²è¢«å–æ¶ˆ";
            box.className = "status-box bg-dark text-white shadow-sm";
            
            pickupInfo.classList.add('d-none'); // å¾¹åº•éš±è—æŒ‰éˆ•å€å¡Š
            stopAllAlerts();

            // 3ç§’å¾Œè‡ªå‹•å°å›é»é¤é 
            if (order.status === 'final' && !window.autoRedirectTimer) {
                window.autoRedirectTimer = setTimeout(() => {
                    window.autoRedirectTimer = null;
                    resetToOrderForm();
                }, 3000);
            }
            return;
        }

        // B. é¤é»è£½ä½œå®Œæˆ (é€šçŸ¥é ˜å–)
        if (order.status === 'completed') {
            box.innerHTML = "âœ… é¤é»å·²å®Œæˆï¼è«‹å–é¤";
            box.className = "status-box st-completed";
            pickupInfo.classList.remove('d-none');
            document.getElementById('info_id').innerText = order.id;

            // æŒ‰éˆ•åˆ‡æ›ï¼šé¡¯ç¤ºã€Œæˆ‘å·²åˆ°æ«ƒæª¯ã€
            arrivedBtn.classList.remove('d-none');
            finalBtn.classList.add('d-none');

            // é—œéµï¼šåªæœ‰ã€Œç¬¬ä¸€æ¬¡ã€é€²å…¥ completed ç‹€æ…‹æ‰è§¸ç™¼é€šçŸ¥
            if (!hasNotified) {
                playAlarmAndVibrate();
                hasNotified = true;
            }
            return;
        }

        // C. ä½¿ç”¨è€…é»æ“Šã€Œæˆ‘å·²åˆ°æ«ƒæª¯ã€å¾Œ (ç­‰å¾…åº—å“¡äº¤ä»˜)
        if (order.status === 'arrived') {
            box.innerHTML = 'ğŸ”” å·²é€šçŸ¥åº—å®¶æ‚¨åœ¨æ«ƒæª¯';
            box.className = "status-box bg-info text-white shadow-sm";
            pickupInfo.classList.remove('d-none');
            
            // æŒ‰éˆ•åˆ‡æ›ï¼šéš±è—ã€Œæˆ‘å·²åˆ°ã€ï¼Œé¡¯ç¤ºã€Œç¢ºèªé ˜å–ã€
            arrivedBtn.classList.add('d-none');
            finalBtn.classList.remove('d-none');
            
            stopAllAlerts(); // æ—¢ç„¶å®¢äººéƒ½åˆ°æ«ƒæª¯äº†ï¼Œå°±åœæ‰è²éŸ³éœ‡å‹•
            return;
        }

        // D. è£½ä½œä¸­æˆ–å…¶ä»–ç‹€æ…‹
        const statusMap = {
            'confirmed': { text: 'ğŸ’° å·²ä»˜æ¬¾ï¼è«‹ç­‰å€™è£½ä½œ', class: 'bg-primary text-white shadow-sm' },
            'preparing': { text: 'ğŸ“ è€é—†æ­£åœ¨åŠªåŠ›è£½ä½œä¸­...', class: 'bg-warning text-dark shadow-sm' },
            'pending': { text: 'â³ ç­‰å€™ä»˜æ¬¾ä¸­...', class: 'bg-secondary text-white' }
        };

        if (statusMap[order.status]) {
            box.innerHTML = statusMap[order.status].text;
            box.className = `status-box ${statusMap[order.status].class}`;
            pickupInfo.classList.add('d-none'); // æ²’åšå®Œä¸é¡¯ç¤ºæŒ‰éˆ•
            stopAllAlerts();
        }
    }


    function playAlarmAndVibrate() {
        // æ’­æ”¾éŸ³è¨Š
        try {
            alarmAudio.currentTime = 0;
            const playPromise = alarmAudio.play();
            if (playPromise !== undefined) {
                playPromise
                    .then(() => {
                        console.log('æç¤ºéŸ³æ’­æ”¾æˆåŠŸ');
                        audioUnlocked = true;
                    })
                    .catch(error => {
                        console.error('æç¤ºéŸ³æ’­æ”¾å¤±æ•—:', error);
                        // å¦‚æœæ’­æ”¾å¤±æ•—ï¼Œå˜—è©¦ä½¿ç”¨ Web Audio API æˆ–èªéŸ³åˆæˆ
                        if ('speechSynthesis' in window) {
                            const utterance = new SpeechSynthesisUtterance('å®å’š');
                            utterance.lang = 'zh-TW';
                            utterance.volume = 1.0;
                            window.speechSynthesis.speak(utterance);
                        }
                    });
            }
        } catch (e) {
            console.error('æ’­æ”¾éŸ³è¨Šç•°å¸¸:', e);
            // ä½¿ç”¨èªéŸ³åˆæˆä½œç‚ºå‚™æ´
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance('å®å’š');
                utterance.lang = 'zh-TW';
                utterance.volume = 1.0;
                window.speechSynthesis.speak(utterance);
            }
        }
        
        // è§¸ç™¼éœ‡å‹•
        triggerStrongVibrate();
    }
    
    function triggerStrongVibrate() {
        if (!("vibrate" in navigator)) return;
        
        // å…ˆåœæ­¢ä¹‹å‰çš„ï¼Œé¿å…é‡è¤‡ç–ŠåŠ 
        stopVibrationOnly();

        const pattern = [2000, 500]; // éœ‡å‹• 2 ç§’ï¼Œåœ 0.5 ç§’
        navigator.vibrate(pattern);

        // æ¯ 2.5 ç§’å¾ªç’°ä¸€æ¬¡
        vibrationInterval = setInterval(() => {
            navigator.vibrate(pattern);
        }, 2500);

        // 15 ç§’å¾Œè‡ªå‹•å¼·åˆ¶åœæ­¢ï¼Œé¿å…æ‰‹æ©Ÿéœ‡å‹•éä¹…å—æ
        vibrationTimer = setTimeout(stopVibrationOnly, 15000);
    }

    function stopVibrationOnly() {
        // 1. æ¸…é™¤æ‰€æœ‰çš„ JavaScript è¨ˆæ™‚å™¨
        if (vibrationInterval) {
            clearInterval(vibrationInterval);
            vibrationInterval = null;
        }
        if (vibrationTimer) {
            clearTimeout(vibrationTimer);
            vibrationTimer = null;
        }
        // 2. ç›´æ¥ä¸‹é” 0 æ¯«ç§’éœ‡å‹•æŒ‡ä»¤ï¼Œå¼·åˆ¶ä¸­æ­¢ç›®å‰ç¡¬é«”é‹ä½œ
        if ("vibrate" in navigator) {
            navigator.vibrate(0);
        }
    }

    function stopAllAlerts() {
        // åœæ­¢éŸ³æ•ˆ
        if (alarmAudio) {
            alarmAudio.pause();
            alarmAudio.currentTime = 0;
        }
        // åœæ­¢éœ‡å‹•
        stopVibrationOnly();
    }
    
    function resetToOrderForm() {
        // åœæ­¢æ‰€æœ‰è¼ªè©¢å’Œæé†’
        if (window.pollingTimer) {
            clearInterval(window.pollingTimer);
            window.pollingTimer = null;
        }
        stopAllAlerts();
        
        // åˆ‡æ›å›è¨‚è³¼ç•«é¢
        document.getElementById('statusPage').classList.add('d-none');
        document.getElementById('orderForm').classList.remove('d-none');
        
        // é‡ç½®è¡¨å–®
        document.getElementById('phone_tail').value = '';
        const cashRadio = document.querySelector('input[name="paymentMethod"][value="cash"]');
        if (cashRadio) cashRadio.checked = true;
        
        // é‡ç½®æ‰€æœ‰å•†å“æ•¸é‡ç‚º 0
        document.querySelectorAll('.item-qty').forEach(input => {
            input.value = 0;
        });
        
        // é‡ç½®ç¸½é¡
        updateTotal();
        
        // æ¸…é™¤ URL åƒæ•¸ï¼ˆå¦‚æœæœ‰ï¼‰
        if (window.location.search) {
            window.history.replaceState({}, document.title, window.location.pathname);
        }
        
        // é‡æ–°è¼‰å…¥å•†å“åˆ—è¡¨ï¼ˆç¢ºä¿åº«å­˜æ˜¯æœ€æ–°çš„ï¼‰
        fetchProducts();
    }

    function stopAlarmAndNotify() {
        stopAllAlerts();
        const oid = document.getElementById('display_order_id').innerText;
        const phoneTail = document.getElementById('display_phone').innerText;
        
        if (!phoneTail || phoneTail.length !== 4) {
            Swal.fire({
                icon: 'error',
                title: 'ç„¡æ³•é€šçŸ¥',
                text: 'ç¼ºå°‘æ‰‹æ©Ÿå¾Œ4ç¢¼è³‡è¨Š',
                confirmButtonColor: '#ff4d4d'
            });
            return;
        }
        
        // ç™¼é€ PATCH è«‹æ±‚æ›´æ–°ç‹€æ…‹ç‚º arrived
        fetch(`/api/orders/${oid}/`, {
            method: 'PATCH',
            headers: { 
                'Content-Type': 'application/json', 
                'X-CSRFToken': getCookie('csrftoken') 
            },
            body: JSON.stringify({ 
                status: 'arrived',
                phone_tail: phoneTail
            })
        })
        .then(res => {
            if (!res.ok) {
                return res.json().then(err => {
                    throw new Error(err.error || err.detail || `HTTP ${res.status}`);
                });
            }
            return res.json();
        })
        .then(() => {
            // æ›´æ–° UI
            document.getElementById('arrivedBtn').className = "btn btn-secondary w-100 py-3 disabled mb-2";
            document.getElementById('finalBtn').classList.remove('d-none');
            // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
            const statusBox = document.getElementById('statusBox');
            statusBox.innerHTML = 'ğŸ”” å·²é€šçŸ¥åº—å®¶æ‚¨åœ¨æ«ƒæª¯';
            statusBox.className = "status-box bg-info text-white shadow-sm";
        })
        .catch(err => {
            console.error('é€šçŸ¥å¤±æ•—:', err);
            Swal.fire({
                icon: 'error',
                title: 'é€šçŸ¥å¤±æ•—',
                text: err.message || 'è«‹ç¨å¾Œå†è©¦',
                confirmButtonColor: '#ff4d4d'
            });
        });
    }

    function finishOrder() {
        Swal.fire({
            title: 'é ˜å–ç¢ºèª',
            text: "ç¢ºå®šå·²æ‹¿åˆ°é¤é»äº†å—ï¼Ÿ",
            icon: 'success',
            showCancelButton: true,
            confirmButtonColor: '#198754',
            confirmButtonText: 'ç¢ºå®š',
            cancelButtonText: 'å–æ¶ˆ'
        }).then((result) => {
            if (result.isConfirmed) {
                const oid = document.getElementById('display_order_id').innerText;
                const phoneTail = document.getElementById('display_phone').innerText;
                
                if (!phoneTail || phoneTail.length !== 4) {
                    Swal.fire({
                        icon: 'error',
                        title: 'ç„¡æ³•å®Œæˆ',
                        text: 'ç¼ºå°‘æ‰‹æ©Ÿå¾Œ4ç¢¼è³‡è¨Š',
                        confirmButtonColor: '#ff4d4d'
                    });
                    return;
                }
                
                // ç™¼é€ PATCH è«‹æ±‚æ›´æ–°ç‹€æ…‹ç‚º final
                fetch(`/api/orders/${oid}/`, {
                    method: 'PATCH',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'X-CSRFToken': getCookie('csrftoken') 
                    },
                    body: JSON.stringify({ 
                        status: 'final',
                        phone_tail: phoneTail
                    })
                })
                .then(res => {
                    if (!res.ok) {
                        return res.json().then(err => {
                            throw new Error(err.error || err.detail || `HTTP ${res.status}`);
                        });
                    }
                    return res.json();
                })
                .then(() => {
                    // åœæ­¢è¼ªè©¢
                    if (window.pollingTimer) {
                        clearInterval(window.pollingTimer);
                        window.pollingTimer = null;
                    }
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'å®Œæˆ',
                        text: 'æ„Ÿè¬æ‚¨çš„ä½¿ç”¨ï¼Œç¥æ‚¨ç”¨é¤æ„‰å¿«ï¼',
                        timer: 2000,
                        showConfirmButton: false
                    }).then(() => {
                        // é‡ç½®é é¢åˆ°åˆå§‹è¨‚è³¼ç•«é¢
                        resetToOrderForm();
                    });
                })
                .catch(err => {
                    console.error('å®Œæˆè¨‚å–®å¤±æ•—:', err);
                    Swal.fire({
                        icon: 'error',
                        title: 'æ“ä½œå¤±æ•—',
                        text: err.message || 'è«‹ç¨å¾Œå†è©¦',
                        confirmButtonColor: '#ff4d4d'
                    });
                });
            }
        });
    }

    function getCookie(n) { 
        let v = document.cookie.match('(^|;) ?' + n + '=([^;]*)(;|$)'); 
        return v ? decodeURIComponent(v[2]) : null; 
    }
</script>
</body>
</html>
