<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% load static %}

    <title>ä¸€æŠŠè‘« {{ store.name }}åˆ†åº— - è‡ªåŠ©é»é¤</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="icon" href="{% static 'images/favicon2.png' %}" type="image/png">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" 
        integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" 
        crossorigin="anonymous"></script>

    <style>

/* è®“åˆ†é¡æ¨™é¡Œ / accordion item æ²å‹•æ™‚ï¼Œæœƒè‡ªå‹•ä¿ç•™é ‚éƒ¨ç©ºé–“ */
        
        :root { --strawberry: #ff4d4d; --bg-pink: #fffafa; --sticky-offset: 84px; }
        .accordion-header,
        .accordion-item,
        .accordion-collapse{
            scroll-margin-top: var(--sticky-offset);
        }
        body {
            background-color: var(--bg-pink);
            font-family: "Microsoft JhengHei", sans-serif;
            
            /* ğŸ”¥ æ–°å¢ï¼šåŠ å…¥å…©å€‹æ·¡æ·¡çš„æ¼¸å±¤å…‰æšˆèƒŒæ™¯ï¼Œè®“ç»ç’ƒæœ‰æ±è¥¿å¯ä»¥æ¨¡ç³Š */
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(255, 77, 77, 0.1) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(255, 193, 7, 0.15) 0%, transparent 40%);
            background-attachment: fixed; /* è®“èƒŒæ™¯å›ºå®šï¼Œæ»¾å‹•æ™‚æ›´æœ‰è³ªæ„Ÿ */
        }
        .card { border-radius: 18px; border: none; box-shadow: 0 4px 12px rgba(255, 77, 77, 0.1); }
        .btn-strawberry { background-color: var(--strawberry); color: white; border-radius: 12px; font-weight: bold; padding: 12px; }
        
        .qty-btn { width: 40px; height: 40px; border-radius: 10px; border: 2px solid var(--strawberry); background: white; color: var(--strawberry); font-weight: 900; font-size: 1.2rem; }
        .qty-btn:active { background: var(--strawberry); color: white; }
        
        .order-id-circle { 
            width: 110px; height: 110px; background: var(--strawberry); color: white; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 2.5rem; font-weight: 900; margin: 0 auto 15px; box-shadow: 0 4px 10px rgba(255, 77, 77, 0.3);
        }

        /* âœ… ä¿®æ”¹è™• 1: åŠ å…¥ position å’Œ z-index ç¢ºä¿å±¤ç´š */
        .status-box { 
            font-size: 1.2rem; 
            font-weight: bold; 
            border-radius: 12px; 
            padding: 18px; 
            margin: 10px 0; 
            border: 2px solid transparent; 
            position: relative; 
            z-index: 1; /* å±¤ç´šè¼ƒä½ï¼Œé¿å…è“‹ä½æŒ‰éˆ• */
        }
        .st-completed { background: #fff3f3; color: #d63031; border: 2px solid #ff4d4d; animation: pulse 1s infinite; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }
        .sticky-footer { position: sticky; bottom: 0; background: white; padding: 15px; border-top: 1px solid #eee; margin: 0 -12px; z-index: 100; }

        .custom-input { background-color: rgba(255, 255, 255, 0.5) !important; border: 1px solid rgba(255, 77, 77, 0.2) !important; color: #d63031 !important; }
        .detail-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #eee; padding: 5px 0; font-size: 0.95rem; }
        
        /* ä»˜æ¬¾æŒ‰éˆ•æ¨£å¼ */
        .btn-check:checked + .btn-outline-danger, .btn-check:checked + .btn-outline-success {
            color: #fff; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transform: translateY(-1px);
        }
        .accordion-button:not(.collapsed) {
            background-color: transparent !important;
            color: var(--strawberry) !important;
            box-shadow: none !important;
        }
        .accordion-button:focus {
            box-shadow: none !important;
            border-color: rgba(0,0,0,.125);
        }
        .accordion-body.ms-3 {
            margin-right: 10px; 
        }
        .accordion-header {
            margin-bottom: 0;
        }

        .accordion-button {
            position: relative;
            display: flex;
            align-items: center;
            width: 100%;
            text-align: left;
            overflow-anchor: none;
            transition: all 0.2s;
        }

        .accordion-body.ms-3 {
            border-left: 1px solid rgba(255, 77, 77, 0.1); 
            margin-left: 1rem !important;
            padding-left: 0.5rem;
        }

        .accordion-button::after {
            filter: sepia(100%) saturate(10000%) hue-rotate(320deg); 
        }

        .product-item.opacity-75 {
            filter: grayscale(0.5);
        }

        .accordion-button:not(.collapsed) {
            border-radius: 12px;
        }

        /* Drink */
        .accordion-button.cat-drink:not(.collapsed){ background: rgba(13, 110, 253, 0.10) !important; color: #0d6efd !important; border-left: 6px solid #0d6efd; }
        /* Tanghulu */
        .accordion-button.cat-tanghulu:not(.collapsed){ background: rgba(255, 77, 77, 0.10) !important; color: #ff4d4d !important; border-left: 6px solid #ff4d4d; }
        /* Mochi */
        .accordion-button.cat-mochi:not(.collapsed){ background: rgba(255, 193, 7, 0.14) !important; color: #b78100 !important; border-left: 6px solid #ffc107; }
        /* Ichikomochi */
        .accordion-button.cat-ichikomochi:not(.collapsed){ background: rgba(25, 135, 84, 0.12) !important; color: #198754 !important; border-left: 6px solid #198754; }
        /* Dessert */
        .accordion-button.cat-dessert:not(.collapsed){ background: rgba(111, 66, 193, 0.12) !important; color: #6f42c1 !important; border-left: 6px solid #6f42c1; }
        
        /* âœ… ä¿®æ”¹è™• 2: ç¢ºä¿æŒ‰éˆ•å±¤ç´šé«˜æ–¼å‹•ç•« */
        #pickupInfo {
            position: relative;
            z-index: 10; /* å±¤ç´šè¼ƒé«˜ï¼Œç¢ºä¿æŒ‰éˆ•å¯ä»¥è¢«é»åˆ° */
        }

        .accordion-button.cat-drink:not(.collapsed)::after { filter: none; }
        .accordion-button.cat-tanghulu:not(.collapsed)::after { filter: none; }
        .accordion-button.cat-mochi:not(.collapsed)::after { filter: none; }
        .accordion-button.cat-ichikomochi:not(.collapsed)::after { filter: none; }
        .accordion-button.cat-dessert:not(.collapsed)::after { filter: none; }
        .accordion-button.has-items {
            border-radius: 12px;
            background: rgba(255, 77, 77, 0.12) !important; 
            color: #d63031 !important;
            border-left: 6px solid #ff4d4d;
        }

        .accordion-button.has-items[data-cat="drink"] { background: rgba(13,110,253,0.10) !important; border-left-color:#0d6efd; color:#0d6efd !important; }
        .accordion-button.has-items[data-cat="tanghulu"] { background: rgba(255,77,77,0.12) !important; border-left-color:#ff4d4d; color:#d63031 !important; }
        .accordion-button.has-items[data-cat="mochi"] { background: rgba(255,193,7,0.16) !important; border-left-color:#ffc107; color:#b78100 !important; }
        .accordion-button.has-items[data-cat="ichikomochi"] { background: rgba(25,135,84,0.14) !important; border-left-color:#198754; color:#198754 !important; }
        .accordion-button.has-items[data-cat="dessert"] { background: rgba(111,66,193,0.14) !important; border-left-color:#6f42c1; color:#6f42c1 !important; }

        /* =========================================
       æ–°å¢ï¼šå¾Œå°ä¿®æ”¹è¨‚å–® Modal çš„åˆ†é¡æ¨£å¼
       ========================================= */
    .accordion-button:not(.collapsed) {
        background-color: transparent !important;
        box-shadow: none !important;
    }
    .accordion-button { font-weight: bold; font-size: 1.1rem; }
    .accordion-button::after { filter: sepia(100%) saturate(10000%) hue-rotate(320deg); }
    
    /* å„åˆ†é¡é¡è‰² (ä»¿ç…§å‰å°) */
    .cat-drink { color: #0d6efd !important; border-left: 5px solid #0d6efd; background: rgba(13, 110, 253, 0.05); }
    .cat-tanghulu { color: #ff4d4d !important; border-left: 5px solid #ff4d4d; background: rgba(255, 77, 77, 0.05); }
    .cat-mochi { color: #b78100 !important; border-left: 5px solid #ffc107; background: rgba(255, 193, 7, 0.05); }
    .cat-ichikomochi { color: #198754 !important; border-left: 5px solid #198754; background: rgba(25, 135, 84, 0.05); }
    .cat-dessert { color: #6f42c1 !important; border-left: 5px solid #6f42c1; background: rgba(111, 66, 193, 0.05); }
    
    /* å•†å“åˆ—æ¨£å¼å¾®èª¿ */
    .edit-item-row { transition: background-color 0.2s; border-bottom: 1px dashed #eee; }
    .edit-item-row:last-child { border-bottom: none; }
    /* --- ğŸ“ éœ§é¢ç»ç’ƒæ”¶æ“šå¡ç‰‡ --- */
    .glass-receipt {
        /* æ ¸å¿ƒï¼šåŠé€æ˜èƒŒæ™¯ + æ¨¡ç³Šæ¿¾é¡ */
        background: rgba(255, 255, 255, 0.65);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px); /* æ”¯æ´ Safari */
        
        /* é‚Šæ¡†ï¼šä½¿ç”¨å¾®æ¼¸å±¤æˆ–åŠé€æ˜ç™½ç·šï¼Œç‡Ÿé€ ç»ç’ƒåšåº¦æ„Ÿ */
        border: 1px solid rgba(255, 255, 255, 0.8);
        border-radius: 20px;
        
        /* é™°å½±ï¼šæ·¡æ·¡çš„ç´…è‰²å…‰æšˆï¼Œè®“å¡ç‰‡æµ®èµ·ä¾† */
        box-shadow: 0 8px 32px 0 rgba(255, 77, 77, 0.15);
        
        padding: 25px;
        margin-top: 1.5rem;
        position: relative;
        overflow: hidden;
    }

    /* é ‚éƒ¨è£é£¾æ¢ (è‰è“ç´…) */
    .glass-receipt::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0;
        height: 6px;
        background: linear-gradient(90deg, #ff9a9e 0%, #ff4d4d 100%);
    }

    /* åˆ†éš”è™›ç·šå„ªåŒ– */
    .receipt-divider {
        border: 0;
        border-bottom: 2px dashed rgba(255, 77, 77, 0.2);
        background: none;
        margin: 15px 0;
        position: relative;
    }

    /* å…©å´çš„åŠåœ“ç¼ºå£ (ç‡Ÿé€ æ’•ç¥¨æ ¹çš„æ„Ÿè¦º) */
    .receipt-divider::before, .receipt-divider::after {
        content: '';
        position: absolute;
        bottom: -6px;
        width: 12px;
        height: 12px;
        background-color: var(--bg-pink, #fffafa); /* éœ€å°æ‡‰æ‚¨çš„ç¶²é èƒŒæ™¯è‰² */
        border-radius: 50%;
        box-shadow: inset 2px 2px 5px rgba(0,0,0,0.05);
    }
    .receipt-divider::before { left: -30px; }
    .receipt-divider::after { right: -30px; }

    /* è³‡è¨Šåˆ—å„ªåŒ– */
    .info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.95rem;
        color: #555;
        margin-bottom: 8px;
    }
    .info-label {
        display: flex;
        align-items: center;
        gap: 6px;
        font-weight: bold;
        color: #888;
    }

    /* ç¸½é‡‘é¡å€å¡Š */
    .total-section {
        background: rgba(255, 77, 77, 0.08);
        border-radius: 12px;
        padding: 12px 15px;
        margin-top: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: #d63031;
    }

    /* é‡å° JS ç”¢ç”Ÿçš„åˆ—è¡¨å…§å®¹é€²è¡Œå¾®èª¿ (å¦‚æœæ‚¨æ˜¯ç”¨ä¹‹å‰çš„ detail-row class) */
    #order_details_list .detail-row {
        border-bottom: 1px dashed rgba(0,0,0,0.05) !important;
        padding: 8px 0;
    }
    #order_details_list .detail-row:last-child {
        border-bottom: none !important;
    }
    </style>
</head>
<body>

<div class="container py-4">
    <div id="orderForm">
        <div class="text-center">
            <h1 class="display-5 fw-bold text-danger">ğŸ“ ä¸€æŠŠè‘«</h1>
            <p class="badge bg-danger rounded-pill px-3">{{ store.name }}åˆ†åº— è‡ªåŠ©é»é¤</p>
        </div>

        <div class="card mb-2 p-3 shadow-sm">
            <label class="form-label fw-bold">1. è¼¸å…¥å®¢æˆ¶ä»£è™Ÿ(å¿…å¡«)</label>
            <input type="text" id="phone_tail" class="form-control form-control-lg text-center fw-bold text-danger custom-input" maxlength="4" inputmode="numeric" placeholder="è«‹è¼¸å…¥æ‰‹æ©Ÿå¾Œ 4 ç¢¼">
        </div>

        <div class="card mb-2 p-3 shadow-sm">
            <label class="form-label fw-bold">2. é¸æ“‡ä»˜æ¬¾æ–¹å¼</label>
            <div class="d-flex gap-2">
                <input type="radio" class="btn-check" name="paymentMethod" id="payCash" value="cash" checked>
                <label class="btn btn-outline-danger flex-grow-1 fw-bold py-3" for="payCash">ç¾é‡‘</label>

                {% if store.enable_linepay %}
                <input type="radio" class="btn-check" name="paymentMethod" id="payLine" value="linepay">
                <label class="btn btn-outline-success flex-grow-1 fw-bold py-3" for="payLine">LINE Pay</label>
                {% endif %}
            </div>
        </div>

        <label class="form-label fw-bold mb-3 text-secondary text-center w-100">3. é¸æ“‡é¤é»åŠæ•¸é‡</label>
        <div id="productList" class="mb-5 pb-5"></div>

        <div class="sticky-footer shadow-lg text-center">
            <div class="d-flex justify-content-between h4 mb-3 px-2">
                <span>åˆè¨ˆé‡‘é¡ï¼š</span><span id="display_total" class="text-danger fw-bold">$0</span>
            </div>
            <button class="btn btn-strawberry w-100 btn-lg shadow" onclick="handleOrderConfirm()">é€å‡ºè¨‚å–®</button>
        </div>
    </div>

    <div id="statusPage" class="d-none animate__animated animate__fadeIn">
        <div class="card p-4 text-center shadow">
            <div class="order-id-circle shadow" id="display_order_id">--</div>
            <h5 class="text-muted fw-bold">æ‚¨çš„è¨‚å–®ç·¨è™Ÿ</h5>
            <p class="small text-muted mb-4">ä¸‹å–®æ™‚é–“: <span id="created_time"></span></p>
            
            <div id="statusBox" class="status-box bg-light text-secondary">âŒ› è¨‚å–®ç™¼é€ä¸­...</div>

            <div id="pickupInfo" class="d-none mt-3 animate__animated animate__shakeX">
                <div class="alert alert-danger py-3 border-danger border-3 shadow-sm">
                    <h4 class="fw-bold mb-2">ğŸ“£ é¤é»å¥½å›‰ï¼</h4>
                    <p class="mb-3 fs-5">è«‹å‘ŠçŸ¥åº—å®¶æ‚¨çš„å–®è™Ÿï¼š<strong>#<span id="info_id"></span></strong></p>
                    <button id="arrivedBtn" class="btn btn-danger w-100 py-3 fw-bold fs-5 shadow-sm mb-2" onclick="stopAlarmAndNotify()">å·²åˆ°æ«ƒæª¯(é€šçŸ¥é ˜å–)</button>
                    <button id="finalBtn" class="btn btn-success w-100 py-3 fw-bold fs-5 shadow-sm d-none" onclick="finishOrder()">å·²é ˜å–é¤é»</button>
                </div>
            </div>

            <div class="glass-receipt text-start animate__animated animate__fadeInUp">
    
    <div class="text-center mb-3">
        <h5 class="fw-bold text-danger" style="letter-spacing: 1px;">
            è¨‚å–®æ˜ç´°
        </h5>
        <small class="text-muted" style="font-size: 0.8rem;">Thank you for your order</small>
    </div>

    <div id="order_details_list" class="mb-3 px-1">
        </div>

    <div class="receipt-divider"></div>

        <div class="px-1">
            <div class="info-row">
                <span class="info-label">æ‰‹æ©Ÿæœ«ç¢¼</span>
                <strong id="display_phone" class="text-dark fs-5 font-monospace"></strong>
            </div>
            <div class="info-row">
                <span class="info-label">ä»˜æ¬¾æ–¹å¼</span>
                <strong id="display_payment" class="text-primary"></strong>
            </div>
        </div>

        <div class="total-section mt-3">
            <span class="fw-bold small text-uppercase">ç¸½é‡‘é¡</span>
            <div class="d-flex align-items-baseline">
                <span class="fs-6 me-1">$</span>
                <strong class="fs-2" id="display_final_total"></strong>
            </div>
        </div>
    </div>
            <p class="text-muted small mt-4">â€» è«‹å‹¿é—œé–‰æ­¤é é¢ï¼Œç³»çµ±å°‡è‡ªå‹•æ›´æ–°ç‹€æ…‹</p>
        </div>
    </div>
</div>

<script>
    const currentStoreSlug = window.location.pathname.split('/').filter(p => p)[0];
    
    // âœ… ä¿®æ”¹è™• 3: å®šç¾©å…¨åŸŸè®Šæ•¸å­˜æ­£ç¢ºçš„æ‰‹æ©Ÿè™Ÿç¢¼ï¼Œé¿å… UI å»¶é²å°è‡´æŠ“ä¸åˆ°
    let cachedPhoneTail = ""; 
    let alarmAudio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
    alarmAudio.loop = true;
    alarmAudio.preload = 'auto';
    
    alarmAudio.addEventListener('error', (e) => {
        console.error('éŸ³è¨Šè¼‰å…¥å¤±æ•—:', e);
        try {
            alarmAudio = new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU');
            alarmAudio.loop = true;
            alarmAudio.preload = 'auto';
        } catch (err) {
            console.error('ç„¡æ³•å»ºç«‹å‚™ç”¨éŸ³è¨Š:', err);
        }
    });

    let vibrationInterval = null, vibrationTimer = null;
    let audioUnlocked = false;

    window.onload = function() {
        fetchProducts();

        const unlockAudio = () => {
            if (!audioUnlocked) {
                try {
                    alarmAudio.play().then(() => {
                        alarmAudio.pause();
                        alarmAudio.currentTime = 0;
                        audioUnlocked = true;
                        console.log('éŸ³è¨Šå·²è§£é–');
                    }).catch(e => {
                        console.log('éŸ³è¨Šè§£é–å°šæœªå°±ç·’:', e);
                    });
                } catch (e) { console.log(e); }
            }
        };

        document.addEventListener('click', unlockAudio, { once: true });
        document.addEventListener('touchstart', unlockAudio, { once: true });

        const urlParams = new URLSearchParams(window.location.search);
        const oid = urlParams.get('oid');
        const error = urlParams.get('error');

        if (error) {
            let errorMsg = 'ç™¼ç”ŸéŒ¯èª¤';
            if (error === 'missing_transaction') errorMsg = 'LINE Pay äº¤æ˜“è³‡è¨Šç¼ºå¤±';
            else if (error === 'payment_failed') errorMsg = 'LINE Pay ä»˜æ¬¾å¤±æ•—';
            else if (error === 'cancelled') errorMsg = 'å·²å–æ¶ˆä»˜æ¬¾';
            else if (error === 'server_error') errorMsg = 'ä¼ºæœå™¨éŒ¯èª¤';
            
            Swal.fire({
                icon: 'error',
                title: 'ä»˜æ¬¾å•é¡Œ',
                text: errorMsg,
                confirmButtonColor: '#ff4d4d'
            }).then(() => {
                window.location.href = window.location.pathname;
            });
            return;
        }

        if (oid) {
            Swal.fire({
                title: 'ğŸ‰ ä»˜æ¬¾æˆåŠŸï¼',
                html: 'è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•<br>ä»¥<b>é–‹å•Ÿå«è™Ÿé€šçŸ¥éŸ³æ•ˆ</b>',
                icon: 'success',
                confirmButtonText: 'é–‹å§‹ç­‰å€™å«è™Ÿ (é–‹å•Ÿé€šçŸ¥)',
                confirmButtonColor: '#ff4d4d',
                allowOutsideClick: false, 
                allowEscapeKey: false,
                didOpen: () => {
                    alarmAudio.load();
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    unlockAudio();
                    if ("vibrate" in navigator) navigator.vibrate(100);
                    fetchOrderAndSwitch(oid);
                }
            });
        }
    };

    function fetchOrderAndSwitch(oid) {
        // ä½¿ç”¨ t=Date.now() é˜²æ­¢ç€è¦½å™¨å¿«å–èˆŠç‹€æ…‹
        fetch(`/api/orders/${oid}/?t=${Date.now()}`)
            .then(res => {
                if (!res.ok) {
                    // 403: ç„¡æ¬Šé™ (æ‰‹æ©Ÿè™Ÿç¢¼ä¸å°), 404: è¨‚å–®ä¸å­˜åœ¨
                    if (res.status === 403 || res.status === 404) {
                        Swal.fire({ 
                            icon: 'warning', 
                            title: 'ç„¡æ³•æŸ¥è©¢', 
                            text: 'è¨‚å–®é€£çµç„¡æ•ˆæˆ–å·²éæœŸ' 
                        }).then(() => {
                            // å¦‚æœæŸ¥ä¸åˆ°ï¼Œè‡ªå‹•æ¸…é™¤ç¶²å€åƒæ•¸ï¼Œå›é¦–é 
                            window.history.replaceState({}, document.title, window.location.pathname);
                            window.location.reload();
                        });
                        return null;
                    }
                    throw new Error(`HTTP ${res.status}`);
                }
                return res.json();
            })
            .then(order => {
                if (order) {
                    // æˆåŠŸæ’ˆåˆ°è³‡æ–™ï¼
                    // å‚³å…¥ order ç‰©ä»¶ï¼ŒswitchToStatusPage æœƒè‡ªå‹•å„ªå…ˆé¡¯ç¤º daily_serial
                    switchToStatusPage(oid, order);
                }
            })
            .catch(err => {
                console.error('æŸ¥è©¢è¨‚å–®å¤±æ•—:', err);
                Swal.fire({ 
                    icon: 'error', 
                    title: 'æŸ¥è©¢å¤±æ•—', 
                    text: 'ç„¡æ³•è¼‰å…¥è¨‚å–®è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦' 
                });
            });
    }

    function fetchProducts(savedCart = null) {
        fetch(`/api/products/?store=${currentStoreSlug}&t=${Date.now()}`)
            .then(res => res.json())
            .then(data => {
                const list = document.getElementById('productList');
                list.innerHTML = '';

                // 1. è³‡æ–™åˆ†çµ„
                const groups = {};
                data.forEach(p => {
                    const catSlug = p.category; 
                    if (!groups[catSlug]) {
                        groups[catSlug] = {
                            slug: catSlug,
                            name: p.category_name || catSlug, 
                            order: p.category_sort_order !== undefined ? p.category_sort_order : 999,
                            products: []
                        };
                    }
                    groups[catSlug].products.push(p);
                });
                const sortedCategories = Object.values(groups).sort((a, b) => a.order - b.order);

                // 2. éæ¿¾æ‰ã€Œå®Œå…¨æ²’åº«å­˜ã€çš„åˆ†é¡ (éš±è—ç©ºåˆ†é¡)
                const visibleCategories = sortedCategories.filter(cat => {
                    return cat.products.some(p => p.stock > 0 && p.is_active);
                });

                // ğŸ”¥ 3. (æ–°åŠŸèƒ½) å°åˆ†é¡å…§çš„å•†å“æ’åºï¼šæœ‰åº«å­˜ç½®é ‚ï¼Œå”®å®Œæ²‰åº•
                visibleCategories.forEach(cat => {
                    cat.products.sort((a, b) => {
                        const aSoldOut = a.stock <= 0 || !a.is_active;
                        const bSoldOut = b.stock <= 0 || !b.is_active;

                        // ç‹€æ…‹ç›¸åŒç¶­æŒåŸé †åºï¼Œç‹€æ…‹ä¸åŒå‰‡ "å”®å®Œè€…" å¾€å¾Œæ’
                        return (aSoldOut === bSoldOut) ? 0 : (aSoldOut ? 1 : -1);
                    });
                });
                
                // å¦‚æœå…¨éƒ¨è³£å…‰
                if (visibleCategories.length === 0) {
                    list.innerHTML = `<div class="text-center py-5 text-muted"><h3>âŒ</h3><p>ä»Šæ—¥å•†å“å·²å…¨æ•¸å”®å®Œï¼Œæ˜æ—¥è«‹æ—©ï¼</p></div>`;
                    updateTotal();
                    return;
                }

                // 4. é–‹å§‹æ¸²æŸ“ HTML
                const accordionId = "productAccordion";
                let accordionHTML = `<div class="accordion accordion-flush" id="${accordionId}">`;

                visibleCategories.forEach((cat, index) => {
                    const catSlug = cat.slug;
                    const catLabel = cat.name;
                    const filteredProducts = cat.products; // é€™è£¡å·²ç¶“æ˜¯æ’å¥½åºçš„äº†
                    const isFirst = index === 0; 
                    const collapseId = `collapse_${catSlug}`;
                    const headerId = `heading_${catSlug}`;

                    accordionHTML += `
                    <div class="accordion-item bg-transparent border-0 mb-3">
                        <h2 class="accordion-header" id="${headerId}">
                            <button class="accordion-button cat-${catSlug} ${isFirst ? '' : 'collapsed'} bg-transparent fw-bold text-danger fs-5 p-2 shadow-none" 
                                    type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}" 
                                    data-cat="${catSlug}" aria-expanded="${isFirst ? 'true' : 'false'}" aria-controls="${collapseId}">
                                <span class="border-start border-4 border-danger ps-2">${catLabel}</span>
                            </button>
                        </h2>
                        <div id="${collapseId}" class="accordion-collapse collapse ${isFirst ? 'show' : ''}" aria-labelledby="${headerId}" data-bs-parent="#${accordionId}">
                            <div class="accordion-body p-0 pt-2 ms-3">`;

                    filteredProducts.forEach(p => {
                        const isSoldOut = p.stock <= 0 || !p.is_active;
                        const statusLabel = isSoldOut ? 
                            `<span class="badge bg-secondary">ä»Šæ—¥å”®å®Œ</span>` : 
                            `<small class="text-muted">å‰©é¤˜åº«å­˜: ${p.stock}</small>`;
                        const descHTML = p.description ? `<div class="small text-muted mb-1" style="font-size: 0.8rem;">${p.description}</div>` : '';

                        let actionButtonsHtml = '';
                        if (!isSoldOut) {
                            actionButtonsHtml = `
                            <div class="d-flex align-items-center gap-2">
                                <button class="qty-btn" onclick="changeQty('${p.id}', -1)">-</button>
                                <input type="number" id="qty_${p.id}" class="form-control item-qty border-0 bg-transparent text-center fw-bold fs-5" 
                                    style="width: 45px" value="0" readonly 
                                    data-id="${p.id}" data-price="${p.price}" 
                                    data-name="${p.name}" data-flavors="${p.flavor_options || ''}"
                                    data-stock="${p.stock}" data-active="${p.is_active}">
                                <button class="qty-btn" onclick="changeQty('${p.id}', 1)">+</button>
                            </div>`;
                        }

                        accordionHTML += `
                        <div class="card mb-3 p-1 product-item ${isSoldOut ? 'opacity-75 bg-light' : ''}">
                            <div class="card-body d-flex justify-content-between align-items-center p-3">
                                <div class="flex-grow-1">
                                    <div class="fw-bold h6 mb-1">${p.name}</div>
                                    ${descHTML} <div class="text-danger fw-bold small">$${p.price}</div>
                                    ${statusLabel}
                                </div>
                                ${actionButtonsHtml}
                            </div>
                        </div>`;
                    });

                    accordionHTML += `</div></div></div>`;
                });
                accordionHTML += `</div>`;
                list.innerHTML = accordionHTML;

                // 5. åˆå§‹åŒ–èˆ‡é‚„åŸè³¼ç‰©è»Š
                setTimeout(() => {
                    list.querySelectorAll('.accordion-collapse').forEach(el => {
                        if (!bootstrap.Collapse.getInstance(el)) new bootstrap.Collapse(el, { toggle: false });
                    });
                    bindAccordionAutoScroll();
                }, 80);

                if (savedCart && typeof savedCart === 'object') {
                    for (const [pid, qty] of Object.entries(savedCart)) {
                        const input = document.getElementById(`qty_${pid}`);
                        if (input) {
                            const stock = parseInt(input.dataset.stock || 0, 10);
                            const isActive = (input.dataset.active == 'true' || input.dataset.active == '1');
                            if (stock > 0 && isActive) {
                                input.value = Math.min(parseInt(qty, 10), stock);
                            }
                        }
                    }
                }
                updateTotal();
            })
            .catch(err => console.error("è¼‰å…¥å•†å“å¤±æ•—:", err));
    }

    function getStickyOffset(){
        const header = document.querySelector('.sticky-header');
        const h = header ? header.getBoundingClientRect().height : 0;

        // iPhone å®‰å…¨å€ï¼ˆæœ‰äº›æ©Ÿå‹æœƒç”¨åˆ°ï¼›æ²’æœ‰å°± 0ï¼‰
        const safeTop = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--sat')) || 0;

        return Math.ceil(h + safeTop);
        }

        function syncStickyOffsetVar(){
        const off = getStickyOffset();
        document.documentElement.style.setProperty('--sticky-offset', (off + 10) + 'px'); // +10 ç•™ä¸€é»å‘¼å¸
        return off + 10;
        }

        function scrollCategoryHeaderIntoTop(btn){
        if(!btn) return;
        const off = syncStickyOffsetVar();

        // æ²åˆ°ã€Œé€™å€‹ buttonã€çš„ä½ç½® - sticky header é«˜åº¦
        const top = window.scrollY + btn.getBoundingClientRect().top - off;
        window.scrollTo({ top, behavior: 'smooth' });
        }

        function bindAccordionAutoScroll(){
        syncStickyOffsetVar();
        window.addEventListener('resize', syncStickyOffsetVar, { passive:true });

        document.querySelectorAll('#productAccordion .accordion-collapse').forEach(collapseEl => {
            collapseEl.addEventListener('shown.bs.collapse', function(){
            const item = collapseEl.closest('.accordion-item');
            const btn = item ? item.querySelector('.accordion-button') : null;
            // å±•é–‹å®Œå†æ²ï¼Œé¿å…é«˜åº¦è®Šå‹•é€ æˆç®—éŒ¯
            setTimeout(() => scrollCategoryHeaderIntoTop(btn), 30);
            });
        });
    }


    function changeQty(id, delta) {
        const input = document.getElementById(`qty_${id}`);
        if (!input) return;
        let val = parseInt(input.value) + delta;
        if (val < 0) val = 0;
        input.value = val;
        updateTotal();
    }

    function updateTotal() {
        let t = 0;
        document.querySelectorAll('.item-qty').forEach(i => t += (parseInt(i.value) || 0) * parseInt(i.dataset.price));
        document.getElementById('display_total').innerText = '$' + t;
        refreshCategoryPickedState();
    }

    function refreshCategoryPickedState() {
        document.querySelectorAll('.accordion-collapse').forEach(collapseEl => {
            const item = collapseEl.closest('.accordion-item');
            if (!item) return;
            const btn = item.querySelector('.accordion-button');
            if (!btn) return;
            const hasPicked = Array.from(collapseEl.querySelectorAll('.item-qty'))
                .some(input => (parseInt(input.value, 10) || 0) > 0);
            btn.classList.toggle('has-items', hasPicked);
        });
    }

    function renderOrderDetailList(items) {
        let html = "";
        items.forEach(i => {
            const q = i.quantity || i.qty;
            const price = i.price;
            const sub = q * price;
            html += `
                <div class="detail-row d-flex justify-content-between border-bottom py-2">
                    <span>
                        <div class="fw-bold">${i.name}</div>
                        <small class="text-muted">$${price} x ${q}</small>
                    </span>
                    <span class="fw-bold align-self-center">$${sub}</span>
                </div>`;
        });
        const container = document.getElementById('order_details_list');
        if (container) container.innerHTML = html;
    }

    async function handleOrderConfirm() {
        const phone = document.getElementById('phone_tail').value;
        const paymentRadio = document.querySelector('input[name="paymentMethod"]:checked');
        const paymentMethod = paymentRadio ? paymentRadio.value : 'cash';
        const paymentLabel = paymentRadio ? document.querySelector(`label[for="${paymentRadio.id}"]`).innerText : 'ç¾é‡‘';

        if (phone.length !== 4) {
            return Swal.fire({ icon: 'warning', title: 'æ ¼å¼éŒ¯èª¤', text: 'è«‹è¼¸å…¥æ‰‹æ©Ÿå¾Œ 4 ç¢¼ï¼', confirmButtonColor: '#ff4d4d' });
        }

        let finalItems = [];
        let totalAmount = 0;
        let tableRowsHtml = ""; 
        const inputs = document.querySelectorAll('.item-qty');

        for (let input of inputs) {
            const q = parseInt(input.value);
            if (q <= 0) continue;

            const baseName = input.dataset.name;
            const price = parseInt(input.dataset.price);
            const flavorsStr = input.dataset.flavors;

            // è™•ç†å£å‘³é¸æ“‡ (é‚è¼¯ä¸è®Š)
            let finalName = baseName;
            if (flavorsStr && flavorsStr.trim() !== "") {
                const flavorArray = flavorsStr.split(',');
                const selectOptions = {};
                flavorArray.forEach(f => {
                    const fName = f.trim();
                    if(fName) selectOptions[fName] = fName;
                });

                const { value: selectedFlavor } = await Swal.fire({
                    title: `è«‹é¸æ“‡å£å‘³`,
                    html: `é»è³¼å•†å“ï¼š<b>${baseName}</b>`,
                    input: 'select',
                    inputOptions: selectOptions,
                    inputPlaceholder: '-- è«‹é¸æ“‡ä¸€å€‹å£å‘³ --',
                    showCancelButton: true,
                    confirmButtonColor: '#ff4d4d',
                    inputValidator: (value) => !value && 'æ‚¨å¿…é ˆé¸æ“‡ä¸€å€‹å£å‘³æ‰èƒ½ä¸‹å–®å–”ï¼'
                });

                if (!selectedFlavor) return; 
                finalName = `${baseName} (${selectedFlavor})`;
            }

            finalItems.push({ id: input.dataset.id, name: finalName, quantity: q, price: price });
            totalAmount += (q * price);

            // âœ¨ ç¾åŒ–é‡é» 1ï¼šç‚ºæ¯ä¸€åˆ—åŠ å…¥ç²‰ç´…è™›ç·šå’Œå…§è·ï¼Œçœ‹èµ·ä¾†æ›´åƒæ˜ç´° âœ¨
            tableRowsHtml += `
                <tr style="border-bottom: 1px dashed rgba(255, 77, 77, 0.2);">
                    <td class="text-start py-2 text-dark fw-bold" style="font-size: 0.95rem;">${finalName}</td>
                    <td class="text-center py-2 text-secondary">x${q}</td>
                    <td class="text-end py-2 fw-bold text-danger">$${q * price}</td>
                </tr>`;
        }

        if (finalItems.length === 0) {
            return Swal.fire({ icon: 'info', title: 'è³¼ç‰©è»Šç©ºç©ºçš„', text: 'æ‚¨é‚„æ²’é¸æ“‡å•†å“å–”ï¼', confirmButtonColor: '#ff4d4d' });
        }

        // âœ¨ ç¾åŒ–é‡é» 2ï¼šé‡æ§‹ SweetAlert çš„ HTMLï¼Œä½¿ç”¨ç²‰ç´…ä¸»é¡Œè‰² âœ¨
        Swal.fire({
            title: '<span class="text-danger fw-bold">ğŸ“ è¨‚å–®ç¢ºèª</span>',
            html: `
                <div class="p-2">
                    <div class="d-flex justify-content-between align-items-center mb-3 bg-light rounded-pill p-2 px-3 border border-danger border-opacity-10">
                        <span class="text-secondary small fw-bold">ä»˜æ¬¾æ–¹å¼</span>
                        <span class="badge ${paymentMethod==='linepay'?'bg-success':'bg-danger'} rounded-pill">${paymentLabel}</span>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-borderless align-middle mb-0">
                            <thead style="background-color: #fff0f0; color: #d63031;">
                                <tr>
                                    <th class="text-start ps-3 py-2 rounded-start">å“å</th>
                                    <th class="text-center py-2">æ•¸é‡</th>
                                    <th class="text-end pe-3 py-2 rounded-end">å°è¨ˆ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRowsHtml}
                            </tbody>
                            <tfoot>
                                <tr><td colspan="3" class="py-1"></td></tr>
                                <tr style="border-top: 2px solid #ff4d4d; background-color: #fffafa;">
                                    <td colspan="2" class="text-end fw-bold text-dark py-3 align-middle">ç¸½é‡‘é¡</td>
                                    
                                    <td class="text-end fw-bold text-danger fs-3 py-3 text-nowrap align-middle">$${totalAmount}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>`,
            showCancelButton: true,
            confirmButtonColor: paymentMethod==='linepay' ? '#2db400' : '#ff4d4d',
            confirmButtonText: paymentMethod==='linepay' ? 'å‰å¾€ LINE Pay ä»˜æ¬¾' : 'ç¢ºèªé€å‡º',
            cancelButtonText: 'è¿”å›ä¿®æ”¹',
            width: '400px', // ç¨å¾®é™åˆ¶å¯¬åº¦ï¼Œè®“æ”¶æ“šçœ‹èµ·ä¾†æ›´é•·æ¢
            customClass: {
                popup: 'rounded-4 shadow-lg' // è®“å½ˆè·³è¦–çª—æ›´åœ“æ½¤
            }
        }).then((result) => {
            if (result.isConfirmed) {
                if (paymentMethod === 'linepay') {
                    Swal.fire({ title: 'æ­£åœ¨é€£æ¥ LINE Pay...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });
                }
                submitOrder(phone, finalItems, totalAmount, paymentMethod);
            }
        });
    }

    function submitOrder(phone, items, total, paymentMethod) {
        // é¡¯ç¤ºè®€å–ä¸­ï¼Œé¿å…é‡è¤‡é»æ“Š
        Swal.fire({ title: 'è¨‚å–®è™•ç†ä¸­...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

        fetch('/api/orders/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
            body: JSON.stringify({
                store_slug: currentStoreSlug,
                phone_tail: phone,
                items: items,
                subtotal: total,
                total: total,
                payment_method: paymentMethod
            })
        })
        .then(async res => {
            // ğŸ”¥ æ”¹é€² 1: å…ˆæª¢æŸ¥æ˜¯ä¸æ˜¯ 200 OKï¼Œä¸ç®¡å…§å®¹æ˜¯ä»€éº¼å…ˆè®€æˆæ–‡å­—
            const text = await res.text();
            
            try {
                // å˜—è©¦æŠŠæ–‡å­—è½‰æˆ JSON
                const data = JSON.parse(text);
                
                // å¦‚æœå¾Œç«¯å›å‚³éŒ¯èª¤ç‹€æ…‹ (ä¾‹å¦‚ 400, 500)
                if (!res.ok) {
                    // å„ªå…ˆæŠ“å– error æˆ– detail æ¬„ä½
                    const errorMsg = data.error || data.detail || 'ä¼ºæœå™¨ç™¼ç”ŸæœªçŸ¥çš„éŒ¯èª¤';
                    throw new Error(errorMsg);
                }
                
                return data; // æˆåŠŸï¼Œå›å‚³ JSON è³‡æ–™
                
            } catch (e) {
                // å¦‚æœè§£æ JSON å¤±æ•— (ä»£è¡¨å¾Œç«¯å›å‚³äº† HTML éŒ¯èª¤é é¢)
                // æˆ–è€…æ˜¯æˆ‘å€‘ä¸Šé¢è‡ªå·± throw çš„ Error
                if (!res.ok) {
                    // å¦‚æœæ˜¯æˆ‘å€‘è‡ªå·± throw çš„ï¼Œe.message å°±æ˜¯éŒ¯èª¤è¨Šæ¯
                    // å¦‚æœæ˜¯ JSON è§£æå¤±æ•—ï¼Œé€šå¸¸æ˜¯ 500 Error
                    if (e.message && e.message.includes('JSON')) {
                        console.error("å¾Œç«¯å›å‚³äº†é JSON çš„å…§å®¹:", text);
                        throw new Error('ä¼ºæœå™¨å…§éƒ¨éŒ¯èª¤ (è«‹æª¢æŸ¥å¾Œç«¯ Console)');
                    }
                    throw e; 
                }
                // å¦‚æœç‹€æ…‹æ˜¯ 200 ä½† JSON è§£æå¤±æ•—...
                throw new Error('ä¼ºæœå™¨å›å‚³æ ¼å¼éŒ¯èª¤');
            }
        })
        .then(order => {
            Swal.close();
            if (order.payment_method === 'linepay' && order.payment_url) {
                window.location.href = order.payment_url;
                return;
            }
            switchToStatusPage(order.id, order);
        })
        .catch(err => {
            console.error("æ•æ‰åˆ°ä¸‹å–®éŒ¯èª¤:", err); // ğŸ”¥ è«‹æŒ‰ F12 çœ‹é€™è£¡å°å‡ºä»€éº¼
            Swal.close();
            
            // ğŸ”¥ æ”¹é€² 2: å®‰å…¨åœ°å‚™ä»½è³¼ç‰©è»Š (ç”¨ try-catch åŒ…èµ·ä¾†)
            let currentCart = {};
            try {
                document.querySelectorAll('.item-qty').forEach(input => {
                    const val = parseInt(input.value);
                    if (val > 0) {
                        currentCart[input.dataset.id] = val;
                    }
                });
            } catch (backupError) {
                console.warn("è³¼ç‰©è»Šå‚™ä»½å¤±æ•—ï¼Œä½†ä¸å½±éŸ¿éŒ¯èª¤é¡¯ç¤º", backupError);
            }

            // é¡¯ç¤ºéŒ¯èª¤è¦–çª—
            Swal.fire({ 
                icon: 'error', 
                title: 'ä¸‹å–®å¤±æ•—', 
                text: err.message, // é€™è£¡æœƒé¡¯ç¤ºå¾Œç«¯çš„éŒ¯èª¤è¨Šæ¯
                confirmButtonText: 'é‡æ–°æ•´ç†èœå–®',
                confirmButtonColor: '#ff4d4d' 
            }).then(() => {
                // å‘¼å«é‡æ•´
                fetchProducts(currentCart); 
            });
        });
    }

    function switchToStatusPage(oid, orderData = null) {
        // 1. åˆ‡æ›ç•«é¢ï¼šéš±è—é»é¤è¡¨å–®ï¼Œé¡¯ç¤ºç‹€æ…‹é 
        document.getElementById('orderForm').classList.add('d-none');
        document.getElementById('statusPage').classList.remove('d-none');
        
        const displayEl = document.getElementById('display_order_id');

        // 2. âœ¨âœ¨âœ¨ é—œéµé‚è¼¯ï¼šæ±ºå®šé¡¯ç¤ºè™Ÿç¢¼ âœ¨âœ¨âœ¨
        // å¦‚æœå¾Œç«¯å›å‚³äº† daily_serial (æµæ°´è™Ÿ)ï¼Œå„ªå…ˆé¡¯ç¤ºæµæ°´è™Ÿï¼›å¦å‰‡é¡¯ç¤ºè³‡æ–™åº« ID
        const displayId = (orderData && orderData.daily_serial) ? orderData.daily_serial : oid;
        displayEl.innerText = displayId;
        
        // 3. âœ¨âœ¨âœ¨ é—œéµé‚è¼¯ï¼šä¿å­˜çœŸå¯¦ ID âœ¨âœ¨âœ¨
        // æŠŠçœŸå¯¦è³‡æ–™åº« ID (oid) è—åœ¨ dataset å±¬æ€§è£¡
        // é€™æ¨£å³ä½¿ç•«é¢ä¸Šé¡¯ç¤º "1è™Ÿ"ï¼Œå¾ŒçºŒç¨‹å¼ç¢¼ä¹Ÿèƒ½é€é dataset.realId æŠ“åˆ° "5002" ä¾†ç™¼é€ API
        displayEl.dataset.realId = oid; 
        
        // 4. é–‹å§‹è¼ªè©¢ç‹€æ…‹ (å¿…é ˆä½¿ç”¨çœŸå¯¦ ID)
        startPolling(oid);
        
        // 5. æ›´æ–°è©³ç´°è³‡è¨Š
        if (orderData) {
            document.getElementById('display_phone').innerText = orderData.phone_tail || '';
            document.getElementById('display_final_total').innerText = orderData.total || 0;
            
            const pMethodMap = {'cash': 'ç¾é‡‘', 'linepay': 'LINE Pay'};
            document.getElementById('display_payment').innerText = pMethodMap[orderData.payment_method] || orderData.payment_method || 'æœªæŒ‡å®š';
            
            // å˜—è©¦ä½¿ç”¨è¨‚å–®å»ºç«‹æ™‚é–“ï¼Œå¦‚æœæ²’æœ‰å‰‡é¡¯ç¤ºç•¶ä¸‹æ™‚é–“
            const timeStr = orderData.created_at ? new Date(orderData.created_at).toLocaleTimeString() : new Date().toLocaleTimeString();
            document.getElementById('created_time').innerText = timeStr;
            
            renderOrderDetailList(orderData.items);
            
            // 6. æ›´æ–°å…¨åŸŸè®Šæ•¸ (ä¿®å¾©é©—è­‰ Bug)
            cachedPhoneTail = orderData.phone_tail;
        }
    }

    function startPolling(oid) {
        const fetchStatus = () => {
            fetch(`/api/orders/${oid}/?t=${Date.now()}`)
                .then(res => {
                    if (!res.ok) {
                        if (res.status === 403 || res.status === 404) {
                            console.error('ç„¡æ³•æŸ¥è©¢è¨‚å–®ï¼Œå¯èƒ½å·²éæœŸæˆ–ç„¡æ¬Šé™');
                            return;
                        }
                        throw new Error(`HTTP ${res.status}`);
                    }
                    return res.json();
                })
                .then(order => {
                    if (order) {
                        updateStatusUI(order);
                    }
                })
                .catch(err => {
                    console.error('æŸ¥è©¢è¨‚å–®ç‹€æ…‹å¤±æ•—:', err);
                });
        };
        fetchStatus(); 
        const timer = setInterval(fetchStatus, 4000);
        window.pollingTimer = timer;
    }

    let hasNotified = false;   
    let lastStatus = null;     

    function updateStatusUI(order) {
        // 1. é‡è¦ï¼šå°‡ API å›å‚³çš„æ­£ç¢ºè™Ÿç¢¼å­˜å…¥å…¨åŸŸè®Šæ•¸ (ä¿®å¾©é©—è­‰ Bug)
        cachedPhoneTail = order.phone_tail;

        // âœ¨âœ¨âœ¨ é—œéµæ–°å¢ï¼šæ±ºå®šé¡¯ç¤ºè™Ÿç¢¼ (å„ªå…ˆé¡¯ç¤ºæµæ°´è™Ÿ) âœ¨âœ¨âœ¨
        const displayId = order.daily_serial || order.id;

        // æ›´æ–°å¤§åœ“åœˆé¡¯ç¤ºï¼Œä¸¦æ›´æ–° dataset çš„çœŸå¯¦ ID
        const displayEl = document.getElementById('display_order_id');
        displayEl.innerText = displayId;
        displayEl.dataset.realId = order.id; 

        const box = document.getElementById('statusBox');
        const pickupInfo = document.getElementById('pickupInfo');
        const arrivedBtn = document.getElementById('arrivedBtn');
        const finalBtn = document.getElementById('finalBtn');

        // 2. æ›´æ–°åŸºæœ¬æ–‡å­—è³‡è¨Š
        document.getElementById('display_final_total').innerText = order.total;
        
        const phoneEl = document.getElementById('display_phone');
        if (phoneEl) phoneEl.textContent = order.phone_tail;
        
        const pMethodMap = { 'cash': 'ç¾é‡‘', 'linepay': 'LINE Pay' };
        document.getElementById('display_payment').innerText = pMethodMap[order.payment_method] || 'æœªæŒ‡å®š';
        renderOrderDetailList(order.items);

        // 3. ç‹€æ…‹æ”¹è®Šæ™‚çš„è™•ç† (é‡ç½®é€šçŸ¥ç‹€æ…‹)
        if (lastStatus !== order.status) {
            // å¦‚æœé›¢é–‹äº† completed ç‹€æ…‹ï¼Œå°±åœæ­¢è­¦ç¤ºéŸ³
            if (order.status !== 'completed') {
                hasNotified = false; 
                stopAllAlerts();    
            }
            lastStatus = order.status;
        }

        // --- 4. ç‹€æ…‹é‚è¼¯åˆ†æµ ---

        // A. è¨‚å–®çµæŸ (çµæ¡ˆæˆ–å–æ¶ˆ)
        if (order.status === 'final' || order.status === 'cancelled') {
            box.innerHTML = order.status === 'final' ? "ğŸ“ ç¥æ‚¨ç”¨é¤æ„‰å¿«ï¼" : "è¨‚å–®å·²å–æ¶ˆï¼Œè½‰å›é»é¤é é¢...";
            // æ ¹æ“šç‹€æ…‹æ›é¡è‰²ï¼šå–æ¶ˆç”¨é»‘è‰²/ç°è‰²ï¼Œå®Œæˆç”¨ç´…è‰²/æ·±è‰²
            box.className = order.status === 'final' 
                ? "status-box bg-dark text-white shadow-sm" 
                : "status-box bg-secondary text-white shadow-sm";
            
            pickupInfo.classList.add('d-none'); 
            stopAllAlerts();

            // ğŸ”¥ ä¿®æ”¹è™•ï¼šåŸæœ¬åªæœ‰ final æœƒè§¸ç™¼ï¼Œç¾åœ¨åŠ å…¥ || order.status === 'cancelled'
            if ((order.status === 'final' || order.status === 'cancelled') && !window.autoRedirectTimer) {
                console.log("è¨‚å–®çµæŸï¼Œ3ç§’å¾Œè¿”å›é¦–é ...");
                window.autoRedirectTimer = setTimeout(() => {
                    window.autoRedirectTimer = null;
                    
                    // å‘¼å«åŸæœ¬å°±å¯«å¥½çš„é‡ç½®å‡½å¼ï¼Œé€™æœƒæ¸…ç©º URL çš„ oid ä¸¦åˆ‡æ›å› #orderForm
                    resetToOrderForm(); 
                }, 3000);
            }
            return;
        }

        // B. é¤é»è£½ä½œå®Œæˆ (é€šçŸ¥é ˜å–)
        if (order.status === 'completed') {
            box.innerHTML = "ğŸ¥¹è®“æ‚¨ä¹…ç­‰äº†ï¼é¤é»å·²å®Œæˆï¼éº»ç…©è«‹è‡³çª—å£å–é¤";
            box.className = "status-box st-completed";
            pickupInfo.classList.remove('d-none');
            
            // âœ¨âœ¨âœ¨ ä¿®æ”¹é€™è£¡ï¼šé¡¯ç¤ºæµæ°´è™Ÿ (ä¾‹å¦‚ 1è™Ÿ) âœ¨âœ¨âœ¨
            document.getElementById('info_id').innerText = displayId;

            arrivedBtn.classList.remove('d-none');
            finalBtn.classList.add('d-none');

            // ğŸ”¥ğŸ”¥ğŸ”¥ã€é—œéµä¿®æ­£ï¼šå¼·åˆ¶é‡ç½®æŒ‰éˆ•ç‚ºç´…è‰²å¯æŒ‰ç‹€æ…‹ã€‘ğŸ”¥ğŸ”¥ğŸ”¥
            // é¿å…ä¸Šä¸€å¼µè¨‚å–®é»éå¾Œï¼ŒæŒ‰éˆ•æ®˜ç•™ç°è‰² disabled ç‹€æ…‹
            arrivedBtn.className = "btn btn-danger w-100 py-3 fw-bold fs-5 shadow-sm mb-2";
            arrivedBtn.innerText = "ğŸ«°é€šçŸ¥åº—å®¶æˆ‘è¦å–é¤";
            arrivedBtn.disabled = false;
            // ğŸ”¥ğŸ”¥ğŸ”¥ ä¿®æ­£çµæŸ ğŸ”¥ğŸ”¥ğŸ”¥

            // åªæœ‰ç¬¬ä¸€æ¬¡é€²å…¥æ­¤ç‹€æ…‹æ‰ç™¼å‡ºè²éŸ³
            if (!hasNotified) {
                playAlarmAndVibrate();
                hasNotified = true;
            }
            return;
        }

        // C. å®¢äººå·²æŒ‰é€šçŸ¥ (ç­‰å¾…åº—å“¡)
        if (order.status === 'arrived') {
            box.innerHTML = 'ğŸ”” å·²é€šçŸ¥åº—å®¶æ‚¨è¦å–é¤';
            box.className = "status-box bg-info text-white shadow-sm";
            pickupInfo.classList.remove('d-none');
            
            arrivedBtn.classList.add('d-none');
            finalBtn.classList.remove('d-none');
            
            stopAllAlerts(); 
            return;
        }

        // D. å…¶ä»–ç‹€æ…‹ (è£½ä½œä¸­/å¾…ä»˜æ¬¾)
        const statusMap = {
            'confirmed': { text: 'ğŸ’° å·²ä»˜æ¬¾ï¼è«‹ç­‰å€™è£½ä½œ', class: 'bg-primary text-white shadow-sm' },
            'preparing': { text: 'ğŸ“ è€é—†æ­£åœ¨åŠªåŠ›è£½ä½œä¸­...', class: 'bg-warning text-dark shadow-sm' },
            'pending': { text: 'â³ ç­‰å€™ä»˜æ¬¾ä¸­...', class: 'bg-secondary text-white' }
        };

        if (statusMap[order.status]) {
            box.innerHTML = statusMap[order.status].text;
            box.className = `status-box ${statusMap[order.status].class}`;
            pickupInfo.classList.add('d-none'); 
            stopAllAlerts();
        }
    }


    function playAlarmAndVibrate() {
        try {
            alarmAudio.currentTime = 0;
            const playPromise = alarmAudio.play();
            if (playPromise !== undefined) {
                playPromise
                    .then(() => {
                        console.log('æç¤ºéŸ³æ’­æ”¾æˆåŠŸ');
                        audioUnlocked = true;
                    })
                    .catch(error => {
                        console.error('æç¤ºéŸ³æ’­æ”¾å¤±æ•—:', error);
                        if ('speechSynthesis' in window) {
                            const utterance = new SpeechSynthesisUtterance('å®å’š');
                            utterance.lang = 'zh-TW';
                            utterance.volume = 1.0;
                            window.speechSynthesis.speak(utterance);
                        }
                    });
            }
        } catch (e) {
            console.error('æ’­æ”¾éŸ³è¨Šç•°å¸¸:', e);
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance('å®å’š');
                utterance.lang = 'zh-TW';
                utterance.volume = 1.0;
                window.speechSynthesis.speak(utterance);
            }
        }
        
        triggerStrongVibrate();
    }
    
    function triggerStrongVibrate() {
        if (!("vibrate" in navigator)) return;
        stopVibrationOnly();

        const pattern = [2000, 500]; 
        navigator.vibrate(pattern);

        vibrationInterval = setInterval(() => {
            navigator.vibrate(pattern);
        }, 2500);

        vibrationTimer = setTimeout(stopVibrationOnly, 15000);
    }

    function stopVibrationOnly() {
        if (vibrationInterval) {
            clearInterval(vibrationInterval);
            vibrationInterval = null;
        }
        if (vibrationTimer) {
            clearTimeout(vibrationTimer);
            vibrationTimer = null;
        }
        if ("vibrate" in navigator) {
            navigator.vibrate(0);
        }
    }

    function stopAllAlerts() {
        if (alarmAudio) {
            alarmAudio.pause();
            alarmAudio.currentTime = 0;
        }
        stopVibrationOnly();
    }
    
    function resetToOrderForm() {
        if (window.pollingTimer) {
            clearInterval(window.pollingTimer);
            window.pollingTimer = null;
        }
        stopAllAlerts();
        
        document.getElementById('statusPage').classList.add('d-none');
        document.getElementById('orderForm').classList.remove('d-none');
        
        document.getElementById('phone_tail').value = '';
        const cashRadio = document.querySelector('input[name="paymentMethod"][value="cash"]');
        if (cashRadio) cashRadio.checked = true;
        
        document.querySelectorAll('.item-qty').forEach(input => {
            input.value = 0;
        });
        
        updateTotal();
        
        if (window.location.search) {
            window.history.replaceState({}, document.title, window.location.pathname);
        }
        
        fetchProducts();
    }

    function stopAlarmAndNotify() {
        stopAllAlerts();
        
        // 1. å–å¾—æ‰‹æ©Ÿæœ«ç¢¼ (å¾å…¨åŸŸè®Šæ•¸ï¼Œç¢ºä¿ç²¾æº–)
        const phoneTail = cachedPhoneTail; 
        
        // âœ¨âœ¨âœ¨ é—œéµä¿®æ­£ï¼šå–å¾—çœŸå¯¦è³‡æ–™åº« ID (oid) âœ¨âœ¨âœ¨
        // å„ªå…ˆå¾ dataset æŠ“ (ç”± switchToStatusPage å¯«å…¥)
        let oid = document.getElementById('display_order_id').dataset.realId;
        
        // å¦‚æœ dataset æ²’è³‡æ–™ (ä¾‹å¦‚ç›´æ¥ F5 åˆ·æ–°é é¢)ï¼Œå‰‡å¾ URL åƒæ•¸æŠ“
        if (!oid) {
            const urlParams = new URLSearchParams(window.location.search);
            oid = urlParams.get('oid');
        }
        
        console.log("é©—è­‰è³‡æ–™:", { oid, phoneTail });

        // 2. é©—è­‰è³‡æ–™å®Œæ•´æ€§
        if (!phoneTail || phoneTail.length !== 4) {
            Swal.fire({
                icon: 'error',
                title: 'é©—è­‰å¤±æ•—',
                text: 'ç„¡æ³•è®€å–æ‰‹æ©Ÿæœ«ç¢¼ï¼Œè«‹é‡æ–°æ•´ç†ç¶²é å¾Œå†è©¦',
                confirmButtonColor: '#ff4d4d'
            });
            return;
        }

        if (!oid) {
            Swal.fire({
                icon: 'error',
                title: 'ç³»çµ±éŒ¯èª¤',
                text: 'ç„¡æ³•è­˜åˆ¥è¨‚å–®ç·¨è™Ÿ (ID éºå¤±)ï¼Œè«‹é‡æ–°æƒæ QRCode',
                confirmButtonColor: '#ff4d4d'
            });
            return;
        }
        
        // 3. UI é–å®š (é˜²æ­¢é‡è¤‡é»æ“Š)
        const btn = document.getElementById('arrivedBtn');
        btn.disabled = true;
        btn.innerText = "è™•ç†ä¸­...";

        // 4. ç™¼é€ API è«‹æ±‚
        fetch(`/api/orders/${oid}/`, {
            method: 'PATCH',
            headers: { 
                'Content-Type': 'application/json', 
                'X-CSRFToken': getCookie('csrftoken') 
            },
            body: JSON.stringify({ 
                status: 'arrived',
                phone_tail: phoneTail
            })
        })
        .then(res => {
            if (!res.ok) {
                return res.json().then(err => {
                    throw new Error(err.error || `é©—è­‰éŒ¯èª¤ (${res.status})`);
                });
            }
            return res.json();
        })
        .then(() => {
            // 5. æˆåŠŸç‹€æ…‹æ›´æ–°
            btn.className = "btn btn-secondary w-100 py-3 disabled mb-2";
            btn.innerText = "å·²é€šçŸ¥ (ç­‰å¾…åº—å“¡)";
            document.getElementById('finalBtn').classList.remove('d-none');
            
            const statusBox = document.getElementById('statusBox');
            statusBox.innerHTML = 'ğŸ”” å·²é€šçŸ¥åº—å®¶æ‚¨åœ¨æ«ƒæª¯';
            statusBox.className = "status-box bg-info text-white shadow-sm";
        })
        .catch(err => {
            // 6. å¤±æ•—è™•ç† (æ¢å¾©æŒ‰éˆ•)
            console.error('é€šçŸ¥å¤±æ•—:', err);
            btn.disabled = false;
            btn.innerText = "å·²åˆ°æ«ƒæª¯(é€šçŸ¥é ˜å–)";
            
            Swal.fire({
                icon: 'error',
                title: 'ç„¡æ³•é€šçŸ¥',
                text: err.message,
                confirmButtonColor: '#ff4d4d'
            });
        });
    }

    function finishOrder() {
        Swal.fire({
            title: 'é ˜å–ç¢ºèª',
            text: "ç¢ºå®šå·²æ‹¿åˆ°é¤é»äº†å—ï¼Ÿ",
            icon: 'success',
            showCancelButton: true,
            confirmButtonColor: '#198754',
            confirmButtonText: 'ç¢ºå®š',
            cancelButtonText: 'å–æ¶ˆ'
        }).then((result) => {
            if (result.isConfirmed) {
                // ğŸ”¥ é—œéµä¿®æ­£ï¼šé€™è£¡ä¸èƒ½æŠ“ innerText (å› ç‚ºé‚£æ˜¯æµæ°´è™Ÿ)ï¼Œè¦æŠ“ dataset.realId (çœŸå¯¦ ID)
                let oid = document.getElementById('display_order_id').dataset.realId;
                
                // å‚™ç”¨æ–¹æ¡ˆï¼šå¦‚æœ dataset æ²’è³‡æ–™ (ä¾‹å¦‚ä½¿ç”¨è€…æŒ‰äº† F5 åˆ·æ–°)ï¼Œå˜—è©¦å¾ URL æŠ“
                if (!oid) {
                    const urlParams = new URLSearchParams(window.location.search);
                    oid = urlParams.get('oid');
                }
                
                // âœ… å¾å…¨åŸŸè®Šæ•¸è®€å–æ­£ç¢ºçš„æ‰‹æ©Ÿç¢¼
                const phoneTail = cachedPhoneTail;
                
                if (!phoneTail || phoneTail.length !== 4) {
                    Swal.fire({
                        icon: 'error',
                        title: 'ç„¡æ³•å®Œæˆ',
                        text: 'ç¼ºå°‘æ‰‹æ©Ÿå¾Œ4ç¢¼è³‡è¨Š',
                        confirmButtonColor: '#ff4d4d'
                    });
                    return;
                }

                if (!oid) {
                    Swal.fire({
                        icon: 'error',
                        title: 'ç³»çµ±éŒ¯èª¤',
                        text: 'æ‰¾ä¸åˆ°è¨‚å–® IDï¼Œè«‹é‡æ–°æƒæ QRCode',
                        confirmButtonColor: '#ff4d4d'
                    });
                    return;
                }
                
                fetch(`/api/orders/${oid}/`, {
                    method: 'PATCH',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'X-CSRFToken': getCookie('csrftoken') 
                    },
                    body: JSON.stringify({ 
                        status: 'final',
                        phone_tail: phoneTail
                    })
                })
                .then(res => {
                    if (!res.ok) {
                        return res.json().then(err => {
                            throw new Error(err.error || err.detail || `HTTP ${res.status}`);
                        });
                    }
                    return res.json();
                })
                .then(() => {
                    if (window.pollingTimer) {
                        clearInterval(window.pollingTimer);
                        window.pollingTimer = null;
                    }
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'å®Œæˆ',
                        text: 'æ„Ÿè¬æ‚¨çš„å…‰è‡¨ï¼Œç¥æ‚¨ç”¨é¤æ„‰å¿«ï¼',
                        timer: 2000,
                        showConfirmButton: false
                    }).then(() => {
                        resetToOrderForm();
                    });
                })
                .catch(err => {
                    console.error('å®Œæˆè¨‚å–®å¤±æ•—:', err);
                    Swal.fire({
                        icon: 'error',
                        title: 'æ“ä½œå¤±æ•—',
                        text: err.message || 'è«‹ç¨å¾Œå†è©¦',
                        confirmButtonColor: '#ff4d4d'
                    });
                });
            }
        });
    }

    function getCookie(n) { 
        let v = document.cookie.match('(^|;) ?' + n + '=([^;]*)(;|$)'); 
        return v ? decodeURIComponent(v[2]) : null; 
    }
</script>
</body>
</html>