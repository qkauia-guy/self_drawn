<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% load static %}

    <title>ä¸€æŠŠè‘« {{ store.name }}åˆ†åº— - è‡ªåŠ©é»é¤</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="icon" href="{% static 'images/favicon.png' %}" type="image/png">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { --strawberry: #ff4d4d; --bg-pink: #fffafa; }
        body { background-color: var(--bg-pink); font-family: "Microsoft JhengHei", sans-serif; }
        .card { border-radius: 18px; border: none; box-shadow: 0 4px 12px rgba(255, 77, 77, 0.1); }
        .btn-strawberry { background-color: var(--strawberry); color: white; border-radius: 12px; font-weight: bold; padding: 12px; }
        
        .qty-btn { width: 40px; height: 40px; border-radius: 10px; border: 2px solid var(--strawberry); background: white; color: var(--strawberry); font-weight: 900; font-size: 1.2rem; }
        .qty-btn:active { background: var(--strawberry); color: white; }
        
        .order-id-circle { 
            width: 110px; height: 110px; background: var(--strawberry); color: white; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 2.5rem; font-weight: 900; margin: 0 auto 15px; box-shadow: 0 4px 10px rgba(255, 77, 77, 0.3);
        }

        .status-box { font-size: 1.2rem; font-weight: bold; border-radius: 12px; padding: 18px; margin: 10px 0; border: 2px solid transparent; }
        .st-completed { background: #fff3f3; color: #d63031; border: 2px solid #ff4d4d; animation: pulse 1s infinite; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }
        .sticky-footer { position: sticky; bottom: 0; background: white; padding: 15px; border-top: 1px solid #eee; margin: 0 -12px; z-index: 100; }

        .custom-input { background-color: rgba(255, 255, 255, 0.5) !important; border: 1px solid rgba(255, 77, 77, 0.2) !important; color: #d63031 !important; }
        .detail-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #eee; padding: 5px 0; font-size: 0.95rem; }
        
        /* ä»˜æ¬¾æŒ‰éˆ•æ¨£å¼ */
        .btn-check:checked + .btn-outline-danger, .btn-check:checked + .btn-outline-success {
            color: #fff; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transform: translateY(-1px);
        }
    </style>
</head>
<body>

<div class="container py-4">
    <!-- ä¸‹å–®å€å¡Š -->
    <div id="orderForm">
        <div class="text-center">
            <h1 class="display-5 fw-bold text-danger">ğŸ“ ä¸€æŠŠè‘«</h1>
            <p class="badge bg-danger rounded-pill px-3">{{ store.name }}åˆ†åº— è‡ªåŠ©é»é¤</p>
        </div>

        <div class="card mb-2 p-3 shadow-sm">
            <label class="form-label fw-bold">1. è¼¸å…¥å®¢æˆ¶ä»£è™Ÿ(å¿…å¡«)</label>
            <input type="text" id="phone_tail" class="form-control form-control-lg text-center fw-bold text-danger custom-input" maxlength="4" inputmode="numeric" placeholder="è«‹è¼¸å…¥æ‰‹æ©Ÿå¾Œ 4 ç¢¼">
        </div>

        <div class="card mb-2 p-3 shadow-sm">
            <label class="form-label fw-bold">2. é¸æ“‡ä»˜æ¬¾æ–¹å¼</label>
            <div class="d-flex gap-2">
                <input type="radio" class="btn-check" name="paymentMethod" id="payCash" value="cash" checked>
                <label class="btn btn-outline-danger flex-grow-1 fw-bold py-3" for="payCash">çª—å£ä»˜ç¾</label>

                <input type="radio" class="btn-check" name="paymentMethod" id="payLine" value="linepay">
                <label class="btn btn-outline-success flex-grow-1 fw-bold py-3" for="payLine"> LINE Pay</label>
            </div>
        </div>

        <label class="form-label fw-bold mb-3 text-secondary text-center w-100">3. é¸æ“‡é¤é»åŠæ•¸é‡</label>
        <div id="productList" class="mb-5 pb-5"></div>

        <div class="sticky-footer shadow-lg text-center">
            <div class="d-flex justify-content-between h4 mb-3 px-2">
                <span>åˆè¨ˆé‡‘é¡ï¼š</span><span id="display_total" class="text-danger fw-bold">$0</span>
            </div>
            <button class="btn btn-strawberry w-100 btn-lg shadow" onclick="handleOrderConfirm()">ç¢ºèªé¤é»ä¸¦é€å‡º</button>
        </div>
    </div>

    <!-- ç‹€æ…‹å€å¡Š -->
    <div id="statusPage" class="d-none animate__animated animate__fadeIn">
        <div class="card p-4 text-center shadow">
            <div class="order-id-circle shadow" id="display_order_id">--</div>
            <h5 class="text-muted fw-bold">æ‚¨çš„è¨‚å–®ç·¨è™Ÿ</h5>
            <p class="small text-muted mb-4">ä¸‹å–®æ™‚é–“: <span id="created_time"></span></p>
            
            <div id="statusBox" class="status-box bg-light text-secondary">âŒ› è¨‚å–®ç™¼é€ä¸­...</div>

            <div id="pickupInfo" class="d-none mt-3 animate__animated animate__shakeX">
                <div class="alert alert-danger py-3 border-danger border-3 shadow-sm">
                    <h4 class="fw-bold mb-2">ğŸ“£ é¤é»å¥½å›‰ï¼</h4>
                    <p class="mb-3 fs-5">è«‹å‘ŠçŸ¥åº—å®¶æ‚¨çš„å–®è™Ÿï¼š<strong>#<span id="info_id"></span></strong></p>
                    <button id="arrivedBtn" class="btn btn-danger w-100 py-3 fw-bold fs-5 shadow-sm mb-2" onclick="stopAlarmAndNotify()">ğŸ“ æˆ‘å·²åˆ°æ«ƒæª¯ (é€šçŸ¥é ˜å–)</button>
                    <button id="finalBtn" class="btn btn-success w-100 py-3 fw-bold fs-5 shadow-sm d-none" onclick="finishOrder()">âœ… æˆ‘å·²æ‹¿åˆ°é¤é» (å®Œæˆ)</button>
                </div>
            </div>

            <div class="bg-light rounded p-3 text-start mt-4">
                <p class="border-bottom pb-2 fw-bold mb-2">ğŸ“‹ æ‚¨çš„è¨‚å–®ç´°é …ï¼š</p>
                <div id="order_details_list" class="mb-3"></div>
                <div class="d-flex justify-content-between mb-1">
                    <span>æ‰‹æ©Ÿæœ«ç¢¼ï¼š</span><strong id="display_phone" class="text-dark"></strong>
                </div>
                <div class="d-flex justify-content-between mb-1">
                    <span>ä»˜æ¬¾æ–¹å¼ï¼š</span><strong id="display_payment" class="text-primary"></strong>
                </div>
                <hr class="my-2">
                <div class="d-flex justify-content-between">
                    <span>æ‡‰ä»˜é‡‘é¡ï¼š</span><strong class="text-danger h4">$<span id="display_final_total"></span></strong>
                </div>
            </div>
            <p class="text-muted small mt-4">â€» è«‹å‹¿é—œé–‰æ­¤é é¢ï¼Œç³»çµ±å°‡è‡ªå‹•æ›´æ–°ç‹€æ…‹</p>
        </div>
    </div>
</div>

<script>
    const currentStoreSlug = window.location.pathname.split('/').filter(p => p)[0];
    let alarmAudio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
    alarmAudio.loop = true;
    // é è¼‰å…¥éŸ³è¨Šï¼Œç¢ºä¿å¯ä»¥æ’­æ”¾
    alarmAudio.preload = 'auto';
    // è™•ç†éŸ³è¨Šè¼‰å…¥éŒ¯èª¤
    alarmAudio.addEventListener('error', (e) => {
        console.error('éŸ³è¨Šè¼‰å…¥å¤±æ•—:', e);
        // å¦‚æœå¤–éƒ¨éŸ³è¨Šè¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨å…§å»ºéŸ³è¨Š
        try {
            alarmAudio = new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU');
            alarmAudio.loop = true;
            alarmAudio.preload = 'auto';
        } catch (err) {
            console.error('ç„¡æ³•å»ºç«‹å‚™ç”¨éŸ³è¨Š:', err);
        }
    });
    let vibrationInterval = null, vibrationTimer = null;
    let audioUnlocked = false;

    // --- åˆå§‹åŒ–: æª¢æŸ¥æ˜¯å¦ç‚º LINE Pay è·³å›ä¾†çš„å®¢äºº ---
    window.onload = function() {
        fetchProducts();
        
        // è§£é–éŸ³è¨Šæ’­æ”¾ï¼ˆéœ€è¦ç”¨æˆ¶äº¤äº’ï¼‰
        // åœ¨é é¢è¼‰å…¥æ™‚å˜—è©¦è§£é–ï¼Œå¦‚æœå¤±æ•—å‰‡åœ¨ç”¨æˆ¶ç¬¬ä¸€æ¬¡é»æ“Šæ™‚è§£é–
        const unlockAudio = () => {
            if (!audioUnlocked) {
                try {
                    // å˜—è©¦æ’­æ”¾ä¸¦ç«‹å³æš«åœï¼Œä»¥è§£é–éŸ³è¨Š
                    alarmAudio.play().then(() => {
                        alarmAudio.pause();
                        alarmAudio.currentTime = 0;
                        audioUnlocked = true;
                        console.log('éŸ³è¨Šå·²è§£é–');
                    }).catch(e => {
                        console.log('éŸ³è¨Šè§£é–å¤±æ•—ï¼Œå°‡åœ¨ç”¨æˆ¶äº¤äº’æ™‚é‡è©¦:', e);
                    });
                } catch (e) {
                    console.log('éŸ³è¨Šè§£é–ç•°å¸¸:', e);
                }
            }
        };
        
        // å˜—è©¦è§£é–éŸ³è¨Š
        unlockAudio();
        
        // åœ¨ç”¨æˆ¶ç¬¬ä¸€æ¬¡é»æ“Šæ™‚ä¹Ÿå˜—è©¦è§£é–
        document.addEventListener('click', unlockAudio, { once: true });
        document.addEventListener('touchstart', unlockAudio, { once: true });
        
        // è§£æç¶²å€åƒæ•¸ï¼Œä¾‹å¦‚: ?oid=15
        const urlParams = new URLSearchParams(window.location.search);
        const oid = urlParams.get('oid');
        const error = urlParams.get('error');
        
        if (error) {
            // è™•ç†éŒ¯èª¤æƒ…æ³
            let errorMsg = 'ç™¼ç”ŸéŒ¯èª¤';
            if (error === 'missing_transaction') errorMsg = 'LINE Pay äº¤æ˜“è³‡è¨Šç¼ºå¤±';
            else if (error === 'payment_failed') errorMsg = 'LINE Pay ä»˜æ¬¾å¤±æ•—';
            else if (error === 'cancelled') errorMsg = 'å·²å–æ¶ˆä»˜æ¬¾';
            else if (error === 'server_error') errorMsg = 'ä¼ºæœå™¨éŒ¯èª¤';
            
            Swal.fire({
                icon: 'error',
                title: 'ä»˜æ¬¾å•é¡Œ',
                text: errorMsg,
                confirmButtonColor: '#ff4d4d'
            }).then(() => {
                // æ¸…é™¤éŒ¯èª¤åƒæ•¸ï¼Œé‡æ–°è¼‰å…¥é é¢
                window.location.href = window.location.pathname;
            });
            return;
        }
        
        if (oid) {
            // å¦‚æœæœ‰ oidï¼Œå…ˆæŸ¥è©¢è¨‚å–®è³‡æ–™ï¼Œå†åˆ‡æ›åˆ°ç‹€æ…‹é é¢
            fetch(`/api/orders/${oid}/?t=${Date.now()}`)
                .then(res => {
                    if (!res.ok) {
                        if (res.status === 403) {
                            Swal.fire({
                                icon: 'warning',
                                title: 'ç„¡æ³•æŸ¥è©¢è¨‚å–®',
                                text: 'è«‹ç¢ºèªè¨‚å–®ç·¨è™Ÿæ˜¯å¦æ­£ç¢º',
                                confirmButtonColor: '#ff4d4d'
                            });
                            return null;
                        }
                        throw new Error(`HTTP ${res.status}`);
                    }
                    return res.json();
                })
                .then(order => {
                    if (order) {
                        switchToStatusPage(oid, order);
                    }
                })
                .catch(err => {
                    console.error('æŸ¥è©¢è¨‚å–®å¤±æ•—:', err);
                    Swal.fire({
                        icon: 'error',
                        title: 'æŸ¥è©¢å¤±æ•—',
                        text: 'ç„¡æ³•è¼‰å…¥è¨‚å–®è³‡è¨Šï¼Œè«‹ç¨å¾Œå†è©¦',
                        confirmButtonColor: '#ff4d4d'
                    });
                });
        }
    };

    function fetchProducts() {
        fetch(`/api/products/?store=${currentStoreSlug}&t=${Date.now()}`)
            .then(res => res.json())
            .then(data => {
                const list = document.getElementById('productList');
                list.innerHTML = '';
                data.forEach(p => {
                    const isSoldOut = p.stock <= 0 || !p.is_active;
                    const statusLabel = isSoldOut ? 
                        `<span class="badge bg-secondary">ä»Šæ—¥å”®å®Œ</span>` : 
                        `<small class="text-muted">åº«å­˜æ•¸é‡: ${p.stock}</small>`;

                    list.innerHTML += `
                    <div class="card mb-3 p-1 product-item ${isSoldOut ? 'opacity-75 bg-light' : ''}">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <div class="flex-grow-1">
                                <div class="fw-bold h5 mb-0">${p.name}</div>
                                <div class="text-danger fw-bold">$${p.price}</div>
                                ${statusLabel}
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <button class="qty-btn" onclick="changeQty('${p.id}', -1)" ${isSoldOut ? 'disabled' : ''}>-</button>
                                <input type="number" id="qty_${p.id}" class="form-control item-qty border-0 bg-transparent text-center fw-bold fs-4" 
                                       style="width: 50px" value="0" readonly 
                                       data-id="${p.id}" data-price="${p.price}" data-name="${p.name}">
                                <button class="qty-btn" onclick="changeQty('${p.id}', 1)" ${isSoldOut ? 'disabled' : ''}>+</button>
                            </div>
                        </div>
                    </div>`;
                });
                updateTotal();
            });
    }

    function changeQty(id, delta) {
        const input = document.getElementById(`qty_${id}`);
        if (!input) return;
        let val = parseInt(input.value) + delta;
        if (val < 0) val = 0;
        input.value = val;
        updateTotal();
    }

    function updateTotal() {
        let t = 0;
        document.querySelectorAll('.item-qty').forEach(i => t += (parseInt(i.value) || 0) * parseInt(i.dataset.price));
        document.getElementById('display_total').innerText = '$' + t;
    }

    function renderOrderDetailList(items) {
        let html = "";
        items.forEach(i => {
            const q = i.quantity || i.qty;
            const price = i.price;
            const sub = q * price;
            html += `
                <div class="detail-row d-flex justify-content-between border-bottom py-2">
                    <span>
                        <div class="fw-bold">${i.name}</div>
                        <small class="text-muted">$${price} x ${q}</small>
                    </span>
                    <span class="fw-bold align-self-center">$${sub}</span>
                </div>`;
        });
        const container = document.getElementById('order_details_list');
        if (container) container.innerHTML = html;
    }

    function handleOrderConfirm() {
        const phone = document.getElementById('phone_tail').value;
        const paymentRadio = document.querySelector('input[name="paymentMethod"]:checked');
        const paymentMethod = paymentRadio ? paymentRadio.value : 'cash';
        const paymentLabel = paymentRadio ? document.querySelector(`label[for="${paymentRadio.id}"]`).innerText : 'ç¾é‡‘';

        if (phone.length !== 4) return Swal.fire({ icon: 'warning', title: 'æ ¼å¼éŒ¯èª¤', text: 'è«‹è¼¸å…¥æ‰‹æ©Ÿå¾Œ 4 ç¢¼ä»¥ä¾›æ ¸å°ï¼', confirmButtonColor: '#ff4d4d' });

        let items = [], total = 0, tableRowsHtml = ""; 
        document.querySelectorAll('.item-qty').forEach(input => {
            const q = parseInt(input.value);
            if (q > 0) {
                const name = input.dataset.name, price = parseInt(input.dataset.price), sub = q * price;
                items.push({ id: input.dataset.id, name: name, quantity: q, price: price });
                total += sub;
                tableRowsHtml += `<tr><td class="text-start">${name}</td><td>x${q}</td><td class="text-end">$${sub}</td></tr>`;
            }
        });

        if (total === 0) return Swal.fire({ icon: 'info', title: 'è³¼ç‰©è»Šç©ºç©ºçš„', text: 'æ‚¨é‚„æ²’é¸æ“‡å•†å“å–”ï¼', confirmButtonColor: '#ff4d4d' });

        Swal.fire({
            title: 'è¨‚å–®ç¢ºèª',
            html: `
                <div class="mb-2 text-start bg-light p-2 rounded border">
                    <span class="text-muted small">ä»˜æ¬¾æ–¹å¼ï¼š</span>
                    <span class="badge ${paymentMethod==='linepay'?'bg-success':'bg-danger'} fs-6">${paymentLabel}</span>
                    ${paymentMethod==='linepay' ? '<div class="text-success small mt-1">â€» é»æ“Šå¾Œå°‡è½‰è·³è‡³ LINE Pay ä»˜æ¬¾</div>' : ''}
                </div>
                <table class="table table-sm border-top mt-2" style="font-size: 0.9rem;">
                    <thead><tr class="table-light"><th class="text-start">å“å</th><th>æ•¸é‡</th><th class="text-end">å°è¨ˆ</th></tr></thead>
                    <tbody>${tableRowsHtml}</tbody>
                    <tfoot><tr class="table-warning"><td colspan="2" class="text-end fw-bold">ç¸½è¨ˆé‡‘é¡ï¼š</td><td class="text-end fw-bold text-danger">$${total}</td></tr></tfoot>
                </table>`,
            showCancelButton: true,
            confirmButtonColor: paymentMethod==='linepay' ? '#2db400' : '#ff4d4d',
            cancelButtonColor: '#6c757d',
            confirmButtonText: paymentMethod==='linepay' ? 'å‰å¾€ LINE Pay ä»˜æ¬¾' : 'ç¢ºå®šä¸‹å–®',
            cancelButtonText: 'æ€è€ƒä¸€ä¸‹'
        }).then((result) => {
            if (result.isConfirmed) {
                // å¦‚æœæ˜¯ LINE Payï¼Œå…ˆé¡¯ç¤º loading
                if (paymentMethod === 'linepay') {
                    Swal.fire({ title: 'æ­£åœ¨é€£æ¥ LINE Pay...', text: 'è«‹ç¨å€™ï¼Œæº–å‚™è½‰è·³ä¸­', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });
                }
                submitOrder(phone, items, total, paymentMethod);
            }
        });
    }

    function submitOrder(phone, items, total, paymentMethod) {
    fetch('/api/orders/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        body: JSON.stringify({
        store_slug: currentStoreSlug,
        phone_tail: phone,
        items: items,
        subtotal: total,
        total: total,
        payment_method: paymentMethod
        })
    })
    .then(res => {
        if (!res.ok) {
        return res.json().then(err => { throw new Error(err.error || 'ä¼ºæœå™¨ç™¼ç”ŸéŒ¯èª¤'); });
        }
        return res.json();
    })
    .then(order => {
        // ä¸ç®¡ç¾é‡‘/LINE Payï¼Œå…ˆæŠŠ loading/confirm Swal é—œæ‰
        Swal.close();

        // LINE Payï¼šè½‰è·³ä»˜æ¬¾é 
        if (order.payment_method === 'linepay' && order.payment_url) {
        window.location.href = order.payment_url;
        return;
        }

        // ç¾é‡‘ï¼šç›´æ¥é€²ç­‰å¾…ç‹€æ…‹é 
        switchToStatusPage(order.id, order);
    })
    .catch(err => {
        Swal.close();
        console.error(err);
        Swal.fire({ icon: 'error', title: 'ä¸‹å–®å¤±æ•—', text: err.message || 'è«‹ç¨å¾Œå†è©¦', confirmButtonColor: '#ff4d4d' });
    });
    }


    // å°‡åˆ‡æ›é é¢çš„é‚è¼¯ç¨ç«‹å‡ºä¾†
    function switchToStatusPage(oid, orderData = null) {
        document.getElementById('orderForm').classList.add('d-none');
        document.getElementById('statusPage').classList.remove('d-none');
        document.getElementById('display_order_id').innerText = oid;
        
        startPolling(oid);
        
        // å¦‚æœæœ‰å‚³å…¥ç¾æˆè³‡æ–™å°±ç›´æ¥é¡¯ç¤ºï¼Œä¸ç„¶è¼ªè©¢æœƒè‡ªå·±æŠ“
        if (orderData) {
            document.getElementById('display_phone').innerText = orderData.phone_tail || '';
            document.getElementById('display_final_total').innerText = orderData.total || 0;
            
            // [FIXED] é€™è£¡ä¿®å¾©äº† undefined å•é¡Œ
            const pMethodMap = {'cash': 'ç¾é‡‘', 'linepay': 'LINE Pay'};
            document.getElementById('display_payment').innerText = pMethodMap[orderData.payment_method] || orderData.payment_method || 'æœªæŒ‡å®š';
            
            document.getElementById('created_time').innerText = new Date().toLocaleTimeString();
            renderOrderDetailList(orderData.items);
        }
    }

    function startPolling(oid) {
        const fetchStatus = () => {
            fetch(`/api/orders/${oid}/?t=${Date.now()}`)
                .then(res => {
                    if (!res.ok) {
                        // å¦‚æœæ˜¯ 403 æˆ– 404ï¼Œå¯èƒ½æ˜¯æ¬Šé™å•é¡Œæˆ–è¨‚å–®ä¸å­˜åœ¨
                        if (res.status === 403 || res.status === 404) {
                            console.error('ç„¡æ³•æŸ¥è©¢è¨‚å–®ï¼Œå¯èƒ½å·²éæœŸæˆ–ç„¡æ¬Šé™');
                            return;
                        }
                        throw new Error(`HTTP ${res.status}`);
                    }
                    return res.json();
                })
                .then(order => {
                    if (order) {
                        updateStatusUI(order);
                    }
                })
                .catch(err => {
                    console.error('æŸ¥è©¢è¨‚å–®ç‹€æ…‹å¤±æ•—:', err);
                    // ä¸ä¸­æ–·è¼ªè©¢ï¼Œç¹¼çºŒå˜—è©¦
                });
        };
        fetchStatus(); 
        const timer = setInterval(fetchStatus, 4000);
        // å„²å­˜ timer ID ä»¥ä¾¿éœ€è¦æ™‚æ¸…é™¤
        window.pollingTimer = timer;
    }

    function updateStatusUI(order) {
        const box = document.getElementById('statusBox');
        const pickupInfo = document.getElementById('pickupInfo');

        document.getElementById('display_final_total').innerText = order.total;
        document.getElementById('display_phone').innerText = order.phone_tail;

        const pMethodMap = {'cash': 'ç¾é‡‘ (æœªä»˜)', 'linepay': 'LINE Pay (å·²ä»˜)'};
        let payText = pMethodMap[order.payment_method] || order.payment_method || 'æœªæŒ‡å®š';
        if (order.status === 'confirmed' && order.payment_method === 'linepay') {
            payText = 'LINE Pay (ä»˜æ¬¾æˆåŠŸ)';
        }
        document.getElementById('display_payment').innerText = payText;

        renderOrderDetailList(order.items);

        // âœ… åªè¦è¢«é€€å› pendingï¼ˆé€šå¸¸ä»£è¡¨ã€Œé€€å›ä»˜æ¬¾å‰/æ”¹æ”¯ä»˜æ–¹å¼ã€ï¼‰
        // å°±è®“å®¢äººå›åˆ°æ–°çš„è¨‚è³¼ç•«é¢ï¼ˆä¸å¸¶ oidï¼‰
        if (order.status === 'pending') {
        stopAllAlerts();

        if (order.payment_method === 'cash') {
            box.innerHTML = "ğŸ’° è«‹è‡³æ«ƒæª¯ä»˜ç¾ï¼Œåº—å®¶ç¢ºèªæ”¶æ¬¾å¾Œå°‡é–‹å§‹è£½ä½œ";
            box.className = "status-box bg-secondary text-white shadow-sm";
            pickupInfo.classList.add('d-none');
            return;
        }

        // LINE Pay pendingï¼ˆå°šæœªå®Œæˆä»˜æ¬¾ï¼‰
        box.innerHTML = "â³ LINE Pay å°šæœªå®Œæˆä»˜æ¬¾ï¼Œè«‹å›åˆ° LINE Pay å®Œæˆä»˜æ¬¾";
        box.className = "status-box bg-warning text-dark shadow-sm";
        pickupInfo.classList.add('d-none');
        return;
        }

        const statusMap = {
            'confirmed': { text: 'ğŸ’° å·²ä»˜æ¬¾ï¼è«‹ç­‰å€™è£½ä½œ', class: 'bg-primary text-white shadow-sm' },
            'preparing': { text: 'ğŸ“ è€é—†æ­£åœ¨åŠªåŠ›è£½ä½œä¸­...', class: 'bg-warning text-dark shadow-sm' },
            'arrived': { text: 'ğŸ”” å·²é€šçŸ¥åº—å®¶æ‚¨åœ¨æ«ƒæª¯', class: 'bg-info text-white shadow-sm' }
        };

        if (order.status === 'completed') {
            if (pickupInfo.classList.contains('d-none')) {
                box.innerHTML = "âœ… é¤é»å·²å®Œæˆï¼è«‹å–é¤";
                box.className = "status-box st-completed";
                pickupInfo.classList.remove('d-none');
                document.getElementById('info_id').innerText = order.id;
                
                // æ’­æ”¾éŸ³è¨Šå’Œéœ‡å‹•
                playAlarmAndVibrate();
            }
        } else if (order.status === 'final' || order.status === 'cancelled') {
            box.innerHTML = order.status === 'final' ? "ğŸ“ ç¥æ‚¨ç”¨é¤æ„‰å¿«ï¼" : "âŒ è¨‚å–®å·²è¢«å–æ¶ˆ";
            box.className = "status-box bg-dark text-white shadow-sm";
            stopAllAlerts();
        } else if (statusMap[order.status]) {
            box.innerHTML = statusMap[order.status].text;
            box.className = `status-box ${statusMap[order.status].class}`;
        }
    }


    function playAlarmAndVibrate() {
        // æ’­æ”¾éŸ³è¨Š
        try {
            alarmAudio.currentTime = 0;
            const playPromise = alarmAudio.play();
            if (playPromise !== undefined) {
                playPromise
                    .then(() => {
                        console.log('æç¤ºéŸ³æ’­æ”¾æˆåŠŸ');
                        audioUnlocked = true;
                    })
                    .catch(error => {
                        console.error('æç¤ºéŸ³æ’­æ”¾å¤±æ•—:', error);
                        // å¦‚æœæ’­æ”¾å¤±æ•—ï¼Œå˜—è©¦ä½¿ç”¨ Web Audio API æˆ–èªéŸ³åˆæˆ
                        if ('speechSynthesis' in window) {
                            const utterance = new SpeechSynthesisUtterance('å®å’š');
                            utterance.lang = 'zh-TW';
                            utterance.volume = 1.0;
                            window.speechSynthesis.speak(utterance);
                        }
                    });
            }
        } catch (e) {
            console.error('æ’­æ”¾éŸ³è¨Šç•°å¸¸:', e);
            // ä½¿ç”¨èªéŸ³åˆæˆä½œç‚ºå‚™æ´
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance('å®å’š');
                utterance.lang = 'zh-TW';
                utterance.volume = 1.0;
                window.speechSynthesis.speak(utterance);
            }
        }
        
        // è§¸ç™¼éœ‡å‹•
        triggerStrongVibrate();
    }
    
    function triggerStrongVibrate() {
        if (!("vibrate" in navigator)) {
            console.log('è£ç½®ä¸æ”¯æ´éœ‡å‹•åŠŸèƒ½');
            return;
        }
        try {
            const pattern = [2000, 500]; 
            navigator.vibrate(pattern);
            vibrationInterval = setInterval(() => { 
                navigator.vibrate(pattern); 
            }, 2500);
            vibrationTimer = setTimeout(() => { stopVibrationOnly(); }, 15000);
        } catch (e) {
            console.error('éœ‡å‹•åŠŸèƒ½ç•°å¸¸:', e);
        }
    }

    function stopVibrationOnly() {
        if (vibrationInterval) clearInterval(vibrationInterval);
        if (vibrationTimer) clearTimeout(vibrationTimer);
        if ("vibrate" in navigator) navigator.vibrate(0);
        vibrationInterval = null; vibrationTimer = null;
    }

    function stopAllAlerts() {
        alarmAudio.pause(); alarmAudio.currentTime = 0;
        stopVibrationOnly();
    }
    
    function resetToOrderForm() {
        // åœæ­¢æ‰€æœ‰è¼ªè©¢å’Œæé†’
        if (window.pollingTimer) {
            clearInterval(window.pollingTimer);
            window.pollingTimer = null;
        }
        stopAllAlerts();
        
        // åˆ‡æ›å›è¨‚è³¼ç•«é¢
        document.getElementById('statusPage').classList.add('d-none');
        document.getElementById('orderForm').classList.remove('d-none');
        
        // é‡ç½®è¡¨å–®
        document.getElementById('phone_tail').value = '';
        const cashRadio = document.querySelector('input[name="paymentMethod"][value="cash"]');
        if (cashRadio) cashRadio.checked = true;
        
        // é‡ç½®æ‰€æœ‰å•†å“æ•¸é‡ç‚º 0
        document.querySelectorAll('.item-qty').forEach(input => {
            input.value = 0;
        });
        
        // é‡ç½®ç¸½é¡
        updateTotal();
        
        // æ¸…é™¤ URL åƒæ•¸ï¼ˆå¦‚æœæœ‰ï¼‰
        if (window.location.search) {
            window.history.replaceState({}, document.title, window.location.pathname);
        }
        
        // é‡æ–°è¼‰å…¥å•†å“åˆ—è¡¨ï¼ˆç¢ºä¿åº«å­˜æ˜¯æœ€æ–°çš„ï¼‰
        fetchProducts();
    }

    function stopAlarmAndNotify() {
        stopAllAlerts();
        const oid = document.getElementById('display_order_id').innerText;
        const phoneTail = document.getElementById('display_phone').innerText;
        
        if (!phoneTail || phoneTail.length !== 4) {
            Swal.fire({
                icon: 'error',
                title: 'ç„¡æ³•é€šçŸ¥',
                text: 'ç¼ºå°‘æ‰‹æ©Ÿå¾Œ4ç¢¼è³‡è¨Š',
                confirmButtonColor: '#ff4d4d'
            });
            return;
        }
        
        // ç™¼é€ PATCH è«‹æ±‚æ›´æ–°ç‹€æ…‹ç‚º arrived
        fetch(`/api/orders/${oid}/`, {
            method: 'PATCH',
            headers: { 
                'Content-Type': 'application/json', 
                'X-CSRFToken': getCookie('csrftoken') 
            },
            body: JSON.stringify({ 
                status: 'arrived',
                phone_tail: phoneTail
            })
        })
        .then(res => {
            if (!res.ok) {
                return res.json().then(err => {
                    throw new Error(err.error || err.detail || `HTTP ${res.status}`);
                });
            }
            return res.json();
        })
        .then(() => {
            // æ›´æ–° UI
            document.getElementById('arrivedBtn').className = "btn btn-secondary w-100 py-3 disabled mb-2";
            document.getElementById('finalBtn').classList.remove('d-none');
            // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
            const statusBox = document.getElementById('statusBox');
            statusBox.innerHTML = 'ğŸ”” å·²é€šçŸ¥åº—å®¶æ‚¨åœ¨æ«ƒæª¯';
            statusBox.className = "status-box bg-info text-white shadow-sm";
        })
        .catch(err => {
            console.error('é€šçŸ¥å¤±æ•—:', err);
            Swal.fire({
                icon: 'error',
                title: 'é€šçŸ¥å¤±æ•—',
                text: err.message || 'è«‹ç¨å¾Œå†è©¦',
                confirmButtonColor: '#ff4d4d'
            });
        });
    }

    function finishOrder() {
        Swal.fire({
            title: 'é ˜å–ç¢ºèª',
            text: "ç¢ºå®šå·²æ‹¿åˆ°é¤é»äº†å—ï¼Ÿ",
            icon: 'success',
            showCancelButton: true,
            confirmButtonColor: '#198754',
            confirmButtonText: 'ç¢ºå®š',
            cancelButtonText: 'å–æ¶ˆ'
        }).then((result) => {
            if (result.isConfirmed) {
                const oid = document.getElementById('display_order_id').innerText;
                const phoneTail = document.getElementById('display_phone').innerText;
                
                if (!phoneTail || phoneTail.length !== 4) {
                    Swal.fire({
                        icon: 'error',
                        title: 'ç„¡æ³•å®Œæˆ',
                        text: 'ç¼ºå°‘æ‰‹æ©Ÿå¾Œ4ç¢¼è³‡è¨Š',
                        confirmButtonColor: '#ff4d4d'
                    });
                    return;
                }
                
                // ç™¼é€ PATCH è«‹æ±‚æ›´æ–°ç‹€æ…‹ç‚º final
                fetch(`/api/orders/${oid}/`, {
                    method: 'PATCH',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'X-CSRFToken': getCookie('csrftoken') 
                    },
                    body: JSON.stringify({ 
                        status: 'final',
                        phone_tail: phoneTail
                    })
                })
                .then(res => {
                    if (!res.ok) {
                        return res.json().then(err => {
                            throw new Error(err.error || err.detail || `HTTP ${res.status}`);
                        });
                    }
                    return res.json();
                })
                .then(() => {
                    // åœæ­¢è¼ªè©¢
                    if (window.pollingTimer) {
                        clearInterval(window.pollingTimer);
                        window.pollingTimer = null;
                    }
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'å®Œæˆ',
                        text: 'æ„Ÿè¬æ‚¨çš„ä½¿ç”¨ï¼Œç¥æ‚¨ç”¨é¤æ„‰å¿«ï¼',
                        timer: 2000,
                        showConfirmButton: false
                    }).then(() => {
                        // é‡ç½®é é¢åˆ°åˆå§‹è¨‚è³¼ç•«é¢
                        resetToOrderForm();
                    });
                })
                .catch(err => {
                    console.error('å®Œæˆè¨‚å–®å¤±æ•—:', err);
                    Swal.fire({
                        icon: 'error',
                        title: 'æ“ä½œå¤±æ•—',
                        text: err.message || 'è«‹ç¨å¾Œå†è©¦',
                        confirmButtonColor: '#ff4d4d'
                    });
                });
            }
        });
    }

    function getCookie(n) { 
        let v = document.cookie.match('(^|;) ?' + n + '=([^;]*)(;|$)'); 
        return v ? decodeURIComponent(v[2]) : null; 
    }
</script>
</body>
</html>
