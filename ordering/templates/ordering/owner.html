<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  {% load static %}
  <title>ä¸€æŠŠè‘«ç®¡ç†å¾Œå° - å³æ™‚è¨‚å–®</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <link rel="icon" href="{% static 'images/favicon3.png' %}" type="image/png">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    /* =========================================
       1. å…¨åŸŸèˆ‡åŸºç¤è¨­å®š
       ========================================= */
    body { 
        background-color: #f0f2f5; 
        font-family: "Microsoft JhengHei", sans-serif; 
        /* ç‚ºäº†é¿å…æ‰‹æ©Ÿç‰ˆæ‡¸æµ®æŒ‰éˆ•æ“‹ä½æœ€å¾Œä¸€å¼µå–®ï¼Œåº•éƒ¨ç•™ç™½åŠ å¤§ */
        padding-bottom: 100px; 
    }
    
    /* å°è¦½åˆ— */
    .navbar { 
        background-color: #d63031 !important; 
        box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
    }

    .store-selector-nav {
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.3);
        color: white; 
        border-radius: 8px; 
        padding: 2px 10px; 
        font-weight: bold;
    }

    /* =========================================
       2. âœ¨ è²æ§æŒ‰éˆ• (æ¡Œé¢/æ‰‹æ©Ÿ RWD æ•´åˆç‰ˆ)
       ========================================= */
    #navVoiceBtn {
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        cursor: pointer;
        outline: none !important;
    }

    /* SVG åœ–ç¤ºé€šç”¨è¨­å®š */
    #navVoiceBtn svg {
        width: 24px;
        height: 24px;
        transition: transform 0.3s ease;
    }

    /* è¼”åŠ©é¡åˆ¥ï¼šéš±è—åœ–ç¤ºç”¨ */
    .d-none { display: none !important; }

    /* --- ğŸ’» é›»è…¦ç‰ˆæ¨£å¼ (åµŒåœ¨ Navbar å…§) --- */
    @media (min-width: 769px) {
        #navVoiceBtn {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            margin-right: 15px;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            position: static;
            transform: none;
            box-shadow: none;
        }
        
        #navVoiceBtn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        /* é›»è…¦ç‰ˆå•Ÿå‹•ç‹€æ…‹ */
        #navVoiceBtn.voice-active {
            background: white !important;
            color: #d63031 !important;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.6);
        }
    }

    /* --- ğŸ“± æ‰‹æ©Ÿç‰ˆæ¨£å¼ (å³ä¸‹è§’æ‡¸æµ® FAB) --- */
    @media (max-width: 768px) {
        #navVoiceBtn {
            position: fixed;
            bottom: 90px; /* è·é›¢åº•éƒ¨ */
            right: 15px;  /* è·é›¢å³å´ */
            z-index: 2000; /* ç¢ºä¿æµ®åœ¨æœ€ä¸Šå±¤ */
            
            width: 65px;
            height: 65px;
            border-radius: 50%; /* åœ“å½¢ */
            
            /* å¼·çƒˆçš„é™°å½±è®“å®ƒæµ®èµ·ä¾† */
            box-shadow: 0 8px 20px rgba(214, 48, 49, 0.3);
        }

        /* åŠ å¤§åœ–ç¤ºè®“æ‰‹æŒ‡å¥½é» */
        #navVoiceBtn svg {
            width: 32px;
            height: 32px;
        }
    }

    /* --- ğŸ¨ æŒ‰éˆ•ç‹€æ…‹é¡è‰²èˆ‡å‹•ç•« --- */

    /* ç‹€æ…‹ï¼šå¾…æ©Ÿ (Inactive) */
    .voice-inactive {
        background-color: #ffffff !important;
        color: #d63031 !important;
        border: 1px solid rgba(0,0,0,0.05);
    }
    /* æ‰‹æ©Ÿç‰ˆæŒ‰ä¸‹å»çš„å¾®äº’å‹• */
    @media (max-width: 768px) {
        .voice-inactive:active { transform: scale(0.95); }
    }

    /* ç‹€æ…‹ï¼šå•Ÿå‹• (Active) */
    .voice-active {
        background-color: #ff4757 !important;
        color: #ffffff !important;
        box-shadow: 0 10px 30px rgba(255, 71, 87, 0.5) !important;
        animation: float-pulse 2s infinite; /* å‘¼å¸å‹•ç•« */
    }

    /* å•Ÿå‹•æ™‚åœ–ç¤ºç¨å¾®æ”¾å¤§ */
    .voice-active svg { transform: scale(1.1); }

    /* ç²¾ç·»çš„å‘¼å¸å‹•ç•« Keyframes */
    @keyframes float-pulse {
        0% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); transform: scale(1); }
        50% { box-shadow: 0 0 0 15px rgba(255, 71, 87, 0); transform: scale(1.05); }
        100% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); transform: scale(1); }
    }

    /* =========================================
       3. è¨‚å–®å¡ç‰‡èˆ‡åˆ—è¡¨æ¨£å¼
       ========================================= */
    .order-card {
        border: none; 
        border-radius: 12px; 
        margin-bottom: 12px;
        overflow: hidden; 
        border-left: 8px solid #ccc; /* é è¨­å·¦é‚Šæ¢é¡è‰² */
        transition: transform 0.12s ease, box-shadow 0.12s ease;
        background: white;
        box-shadow: 0 4px 10px rgba(0,0,0,0.06);
    }
    .order-card:hover { transform: translateY(-1px); box-shadow: 0 6px 14px rgba(0,0,0,0.08); }

    /* ç‹€æ…‹å°æ‡‰çš„å·¦é‚Šæ¢é¡è‰² */
    .status-pending { border-left-color: #636e72; }
    .status-confirmed { border-left-color: #0984e3; }
    .status-preparing { border-left-color: #fdcb6e; }
    .status-completed { border-left-color: #00b894; }
    .status-arrived { border-left-color: #d63031; animation: pulse-red-border 1s infinite; }
    .status-final { border-left-color: #2ecc71; opacity: 0.65; }
    .status-cancelled { border-left-color: #b2bec3; opacity: 0.65; }

    @keyframes pulse-red-border {
        0% { border-left-width: 8px; } 50% { border-left-width: 14px; } 100% { border-left-width: 8px; }
    }

    /* å¡ç‰‡é ­éƒ¨æ’ç‰ˆ */
    .card-header-clickable {
        padding: 14px 14px; 
        cursor: pointer;
        display: grid; 
        grid-template-columns: 1fr auto; 
        align-items: center; 
        gap: 10px; 
        user-select: none;
    }
    .order-head-left { display: flex; align-items: center; gap: 8px; min-width: 0; flex-wrap: nowrap; width: 100%; }

    /* RWD å¡ç‰‡é ­éƒ¨èª¿æ•´ */
    @media (min-width: 992px) { .order-head-left > * { flex: 1 1 0; display: inline-flex; justify-content: center; min-width: 0; } }
    @media (max-width: 991.98px) { .order-head-left > * { flex: 0 0 auto; } }
    @media (max-width: 576px) {
        .order-head-left { flex-wrap: wrap; gap: 5px; } /* æ‰‹æ©Ÿå…è¨±æ›è¡Œ */
    }

    /* =========================================
       4. æ¨™ç±¤ (Pills/Tags) æ¨£å¼
       ========================================= */
    /* æ‰‹æ©Ÿè™Ÿç¢¼èˆ‡ ID ä¸¸å­ */
    .order-pill {
        display: inline-flex; align-items: center; justify-content: center; height: 32px; padding: 0 10px;
        border-radius: 10px; font-weight: 800; font-size: 0.95rem; line-height: 1; white-space: nowrap;
    }
    .pill-phone { background: #ffecec; color: #d63031; border: 1px solid rgba(214,48,49,0.25); }
    .pill-id { background: #f7f7f7; color: #2d3436; border: 1px solid rgba(0,0,0,0.08); }

    /* ä»˜æ¬¾æ–¹å¼æ¨™ç±¤ */
    .pay-tag-line, .pay-tag-cash {
        display: inline-flex; align-items: center; justify-content: center; width: 64px; height: 32px;
        padding: 0 10px; border-radius: 10px; font-weight: 800; font-size: 0.85rem; line-height: 1; white-space: nowrap;
    }
    .pay-tag-line { background-color: #06c755; color: #fff; border: 1px solid rgba(0,0,0,0.08); }
    .pay-tag-cash { background-color: #ffcccc; color: #d63031; border: 1px solid rgba(214,48,49,0.18); }

    /* ç‹€æ…‹æ–‡å­—æ¨™ç±¤ */
    .status-tag {
        display: inline-flex; align-items: center; justify-content: center; height: 32px; padding: 0 12px;
        border-radius: 10px; font-weight: 900; font-size: 0.85rem; white-space: nowrap;
    }
    .tag-pending { background: #ecf0f1; color: #2d3436; border: 1px solid rgba(0,0,0,0.08); }
    .tag-confirmed { background: #dbeafe; color: #1d4ed8; border: 1px solid rgba(29,78,216,0.2); }
    .tag-preparing { background: #fff3cd; color: #7a5a00; border: 1px solid rgba(122,90,0,0.18); }
    .tag-completed { background: #d1fae5; color: #047857; border: 1px solid rgba(4,120,87,0.18); }
    .tag-arrived { background: #ffecec; color: #d63031; border: 1px solid rgba(214,48,49,0.25); }
    .tag-final { background: #e5e7eb; color: #111827; border: 1px solid rgba(17,24,39,0.12); }
    .tag-cancelled { background: #f1f5f9; color: #64748b; border: 1px solid rgba(100,116,139,0.18); }

    /* å¡ç‰‡å…§å®¹ç´°é … */
    .arrow {
        width: 28px; height: 28px; display: inline-flex; align-items: center; justify-content: center;
        border-radius: 8px; background: #f3f4f6; color: #374151; border: 1px solid rgba(0,0,0,0.06);
    }
    .detail-content { padding: 15px; border-top: 1px solid #eee; display: block; }
    .hide-detail { display: none; }
    
    .item-badge {
        background: #fff5f5; border: 1px solid #ffcccc; color: #d63031; padding: 6px 10px;
        border-radius: 8px; margin: 3px; display: inline-block; font-size: 1rem; font-weight: bold;
    }
    .time-box {
        font-size: 0.85rem; color: #7f8c8d; background: #f9f9f9; padding: 10px; border-radius: 8px; border: 1px solid rgba(0,0,0,0.04);
    }
    .btn-action { border-radius: 12px; padding: 15px; font-weight: bold; width: 100%; font-size: 1.2rem; margin-bottom: 8px; }

    /* =========================================
       5. ç¯©é¸èˆ‡æ§åˆ¶å€å¡Š (Mobile Optimized)
       ========================================= */
    .sticky-controls {
        position: sticky;
        top: 56px; /* Bootstrap Navbar height */
        z-index: 990;
        background-color: rgba(240, 242, 245, 0.95);
        backdrop-filter: blur(5px);
        border-bottom: 1px solid rgba(0,0,0,0.05);
        padding-top: 10px;
        margin-top: -16px;
    }

    .input-group:focus-within { box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important; transition: 0.3s; }

    /* æ©«å‘æ²å‹•å®¹å™¨ */
    #filterContainer {
        display: flex;
        flex-wrap: nowrap;
        overflow-x: auto;
        gap: 8px;
        padding: 10px 5px;
        -webkit-overflow-scrolling: touch;
        cursor: grab;
    }
    /* éš±è—æ²è»¸ */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    /* ç¯©é¸æŒ‰éˆ• */
    .filter-btn { 
        white-space: nowrap; 
        border: 1px solid transparent; 
        transition: all 0.2s; 
        opacity: 0.65; 
        flex: 0 0 auto; 
        border-radius: 50rem !important;
        font-size: 0.95rem;
    }
    .filter-btn:hover { transform: translateY(-2px); opacity: 0.9; }
    
    /* ç¯©é¸æŒ‰éˆ•é¸ä¸­ç‹€æ…‹ */
    .filter-btn.active { 
        opacity: 1; 
        box-shadow: 0 4px 10px rgba(0,0,0,0.15); 
        border: 2px solid #fff;
        transform: scale(1.05);
    }
    
    /* å€‹åˆ¥æŒ‰éˆ•é¸ä¸­é¡è‰² */
    .filter-btn[onclick*='pending'].active { background-color: #636e72 !important; border-color: #636e72; }
    .filter-btn[onclick*='confirmed'].active { background-color: #0d6efd !important; border-color: #0d6efd; }
    .filter-btn[onclick*='preparing'].active { background-color: #ffc107 !important; border-color: #ffc107; color: black !important; }
    .filter-btn[onclick*='uncollected'].active { background-color: #00b894 !important; border-color: #00b894; }
    .filter-btn[onclick*='history'].active { background-color: #b2bec3 !important; border-color: #b2bec3; color: #2d3436 !important; }
    .filter-btn[onclick*='cancelled'].active { background-color: #d63031 !important; border-color: #d63031; color: white !important; }

    /* =========================================
       6. å½ˆçª—èˆ‡å…¶ä»–é›œé …
       ========================================= */
    /* èªéŸ³è§£é–ç•«é¢ */
    #audio-unlocker {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(214, 48, 49, 0.95); z-index: 9999;
        display: flex; flex-direction: column; align-items: center; justify-content: center; color: white;
    }
    #audio-unlocker .store-box { backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
    #audio-unlocker select { background-color: white; color: #333; border: none; cursor: pointer; }

    /* èªéŸ³é™¤éŒ¯æ–‡å­— */
    #voiceDebug { font-size: 0.85rem; min-height: 20px; color: #d63031; font-weight: bold; text-align: center; }

    /* æ‰‹æ©Ÿç‰ˆå¾®èª¿ */
    @media (max-width: 576px) {
        .order-pill, .pay-tag-line, .pay-tag-cash, .status-tag {
            height: 28px; font-size: 0.8rem; padding: 0 8px;
        }
        .item-badge { font-size: 0.9rem; }
        .btn-action { padding: 12px; font-size: 1.1rem; }
    }

    /* =========================================
       âœ¨ ç¾ä»£åŒ–æ‡¸æµ®æœå°‹æ¬„ (è† å›Šæ¨£å¼)
       ========================================= */
    .modern-search-bar {
        border-radius: 50rem; /* æ¥µå¤§åœ“è§’ï¼Œè®Šæˆè† å›Šç‹€ */
        background: white;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08); /* æŸ”å’Œçš„é™°å½± */
        border: 1px solid rgba(0,0,0,0.05); /* æ¥µæ·¡çš„é‚Šæ¡† */
        padding: 5px 5px; /* å…§éƒ¨ç•™ç™½ */
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        overflow: hidden;
    }

    /* ç•¶è¼¸å…¥æ¡†è¢«é»æ“Šæ™‚çš„ç‰¹æ•ˆ */
    .modern-search-bar:focus-within {
        box-shadow: 0 8px 25px rgba(214, 48, 49, 0.15); /* ç´…è‰²å…‰æšˆ */
        transform: translateY(-2px); /* å¾®å¾®æµ®èµ· */
        border-color: rgba(214, 48, 49, 0.3);
    }

    /* 1. å·¦å´åœ–ç¤ºå€ */
    .modern-search-bar .input-group-text {
        background: transparent;
        border: none;
        padding-left: 15px;
        padding-right: 10px;
    }

    /* 2. ä¸­é–“è¼¸å…¥æ¡† */
    .modern-search-bar .form-control {
        border: none;
        background: transparent;
        box-shadow: none !important; /* ç§»é™¤ Bootstrap é è¨­è—æ¡† */
        font-weight: bold;
        color: #2d3436;
        padding-left: 0; /* è®“æ–‡å­—ç·Šè²¼åœ–ç¤º */
        letter-spacing: 0.5px;
    }
    
    /* ä¿®æ”¹ placeholder é¡è‰² */
    .modern-search-bar .form-control::placeholder {
        color: #b2bec3;
        font-weight: normal;
        font-size: 0.9rem;
    }

    /* 3. å³å´æ¸…é™¤æŒ‰éˆ• */
    .modern-search-bar .btn-clear {
        border: none;
        background: transparent;
        color: #b2bec3;
        font-weight: bold;
        padding-right: 15px;
        border-radius: 50%;
        transition: color 0.2s;
    }
    
    .modern-search-bar .btn-clear:hover {
        color: #d63031; /* æ»‘é¼ ç§»éå»è®Šç´…è‰² */
    }
    

    /* =========================================
       âœ¨ èªéŸ³å›é¥‹ HUD (æ‡¸æµ®è† å›Š)
       ========================================= */
    #voiceDebug {
        /* 1. å®šä½ï¼šå›ºå®šåœ¨ç•«é¢ä¸‹æ–¹ä¸­å¤® (æ‡¸æµ®æŒ‰éˆ•ä¹‹ä¸Š) */
        position: fixed;
        bottom: 110px; /* ä½æ–¼æ‡¸æµ®æŒ‰éˆ•ä¸Šæ–¹ï¼Œé¿å…é‡ç–Š */
        left: 50%;
        transform: translateX(-50%) scale(0.8); /* é è¨­ç¨å¾®ç¸®å° */
        
        /* 2. å¤–è§€ï¼šæ¯›ç»ç’ƒè† å›Š */
        background: rgba(255, 255, 255, 0.9); /* åŠé€æ˜ç™½ */
        backdrop-filter: blur(8px); /* èƒŒæ™¯æ¨¡ç³Š */
        padding: 10px 24px;
        border-radius: 50px; /* åœ“æ½¤è† å›Šç‹€ */
        
        /* 3. è£é£¾ï¼šé™°å½±èˆ‡é‚Šæ¡† */
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1), 
                    0 10px 30px rgba(214, 48, 49, 0.1); /* å¸¶æœ‰ç´…è‰²çš„å…‰æšˆ */
        border: 1px solid rgba(255, 255, 255, 0.5);
        
        /* 4. æ–‡å­—è¨­å®š */
        color: #2d3436;
        font-weight: 800;
        font-size: 0.95rem;
        letter-spacing: 0.5px;
        text-align: center;
        white-space: nowrap; /* ä¿æŒå–®è¡Œ */
        z-index: 1999; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ï¼Œä½†åœ¨æŒ‰éˆ•ä¹‹ä¸‹ */
        
        /* 5. éš±è—èˆ‡å‹•ç•«æ©Ÿåˆ¶ */
        opacity: 0;
        visibility: hidden;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Qå½ˆæ•ˆæœ */
        pointer-events: none; /* è®“é»æ“Šå¯ä»¥ç©¿é€å®ƒï¼Œä¸æœƒæ“‹åˆ°å¾Œé¢ */
    }

    /* â˜…â˜…â˜… é—œéµï¼šç•¶è£¡é¢æœ‰æ–‡å­—æ™‚æ‰é¡¯ç¤º â˜…â˜…â˜… */
    /* åˆ©ç”¨ CSS :empty å½é¡ï¼Œç•¶ JS å¡«å…¥æ–‡å­—æ™‚è‡ªå‹•è§¸ç™¼ */
    #voiceDebug:not(:empty) {
        opacity: 1;
        visibility: visible;
        transform: translateX(-50%) scale(1); /* å½ˆå‡ºä¾† */
        bottom: 120px; /* å¾®å¾®ä¸Šæµ® */
    }

    /* =========================================
       7. ğŸ‘¨â€ğŸ³ å»šæˆ¿å‚™é¤æˆ°æƒ…æ¿ (Kitchen Status Board)
       ========================================= */
    #kitchenBoard {
        position: fixed;
        left: 15px;
        bottom: 20px;
        width: 350px; 
        background: rgba(33, 37, 41, 0.65);
        backdrop-filter: blur(2px);
        color: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.25);
        z-index: 1050;
        overflow: hidden;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(255,255,255,0.1);
        font-family: 'Microsoft JhengHei', sans-serif;
        
        /* è®“å®ƒæ ¹æ“šå…§å®¹è‡ªå‹•é•·é«˜ (é›»è…¦ç‰ˆé™åˆ¶æœ€å¤§ 70% é«˜åº¦) */
        height: auto;
        max-height: 70vh;
        display: flex;
        flex-direction: column;
    }

    /* æ¨™é¡Œåˆ— */
    .kb-header {
        padding: 12px 15px;
        background: rgba(255,255,255,0.1);
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        user-select: none;
    }
    
    .kb-title { font-weight: bold; font-size: 1rem; display: flex; align-items: center; gap: 8px; }
    .kb-badge { background: #ff4757; color: white; padding: 2px 8px; border-radius: 20px; font-size: 0.8rem; font-weight: 800; }
    .kb-toggle { transition: transform 0.3s; }
    
    /* å…§å®¹å€ */
    .kb-body {
        max-height: 300px; /* é›»è…¦ç‰ˆæœ€å¤§é«˜åº¦ */
        overflow-y: auto;
        padding: 0;
        transition: max-height 0.3s ease;
    }

    /* æ”¶åˆç‹€æ…‹ (é€é JS åˆ‡æ› class) */
    #kitchenBoard.collapsed .kb-body {
        max-height: 0;
    }
    #kitchenBoard.collapsed .kb-toggle {
        transform: rotate(-90deg);
    }
    #kitchenBoard.collapsed {
        width: auto !important; /* å¼·åˆ¶è¦†è“‹ä¸Šé¢çš„ 350px */
        min-width: 160px;
        height: auto;
    }

    /* åˆ—è¡¨é …ç›® */
    .kb-item {
        padding: 10px 15px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.95rem;
    }
    .kb-item:last-child { border-bottom: none; }
    
    /* æ•¸é‡å¼·èª¿ */
    .kb-qty { 
        font-size: 1.2rem; 
        font-weight: 800; 
        color: #ffd32a; /* äº®é»ƒè‰²æ•¸å­— */
        margin-left: 10px;
    }
    .kb-name { opacity: 0.9; }

    /* ç©ºè³‡æ–™ç‹€æ…‹ */
    .kb-empty { padding: 15px; text-align: center; color: rgba(255,255,255,0.5); font-size: 0.9rem; }

    .kb-item {
        padding: 12px 15px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        display: grid;
        grid-template-columns: auto 1fr auto; /* å‹¾é¸æ¡† | åç¨± | æ•¸é‡ */
        align-items: center;
        gap: 12px;
        font-size: 1rem;
        transition: all 0.2s;
    }
    .kb-item:last-child { border-bottom: none; }

    /* é¸ä¸­å¾Œçš„æ¨£å¼ (è®Šæš— + åˆªé™¤ç·š) */
    .kb-item.checked {
        opacity: 0.4;
        background: rgba(0,0,0,0.2);
    }
    .kb-item.checked .kb-name {
        text-decoration: line-through;
    }

    /* --- âœ¨ ç¾åŒ– Checkbox --- */
    .kb-check-wrapper {
        position: relative;
        display: flex;
        align-items: center;
        cursor: pointer;
    }
    
    /* éš±è—åŸç”Ÿ Checkbox */
    .kb-check-input {
        position: absolute;
        opacity: 0;
        cursor: pointer;
        height: 0;
        width: 0;
    }

    /* è‡ªè¨‚ Checkbox å¤–è§€ */
    .kb-checkmark {
        height: 22px;
        width: 22px;
        background-color: rgba(255,255,255,0.1);
        border: 2px solid rgba(255,255,255,0.4);
        border-radius: 6px;
        transition: all 0.2s ease;
        position: relative;
    }

    /* æ»‘é¼ ç§»éå» */
    .kb-check-wrapper:hover .kb-check-input ~ .kb-checkmark {
        border-color: #ffd32a;
    }

    /* é¸ä¸­ç‹€æ…‹ */
    .kb-check-input:checked ~ .kb-checkmark {
        background-color: #ffd32a; /* äº®é»ƒè‰²èƒŒæ™¯ */
        border-color: #ffd32a;
        transform: scale(1.1);
    }

    /* å‹¾å‹¾åœ–ç¤º (ç”¨ CSS ç•«) */
    .kb-check-input:checked ~ .kb-checkmark:after {
        content: "";
        position: absolute;
        left: 6px;
        top: 2px;
        width: 6px;
        height: 12px;
        border: solid #2d3436; /* æ·±è‰²å‹¾å‹¾ */
        border-width: 0 3px 3px 0;
        transform: rotate(45deg);
    }

    /* --- å•†å“åç¨±èˆ‡ç·¨è™Ÿ --- */
    .kb-name { 
        font-weight: 500; 
        line-height: 1.4;
        color: #fff;
    }
    .kb-index {
        color: rgba(255,255,255,0.5);
        font-size: 0.9em;
        margin-right: 4px;
        font-family: monospace; /* ç­‰å¯¬å­—é«”è®“æ•¸å­—å°é½Š */
    }

    /* --- æ•¸é‡ (ä¿æŒäº®çœ¼) --- */
    .kb-qty { 
        font-size: 1.3rem; 
        font-weight: 800; 
        color: #ffd32a; 
        min-width: 30px;
        text-align: right;
    }
    /* --- ğŸ“± æ‰‹æ©Ÿç‰ˆ RWD å„ªåŒ– --- */
    @media (max-width: 576px) {
        #kitchenBoard {
            /* 1. æ”¹ç‚ºæ»¿ç‰ˆå¯¬åº¦ (å·¦å³å„ç•™ 10px é–“è·ï¼Œè¦–è¦ºæ¯”è¼ƒèˆ’é©) */
            left: 10px;
            right: 10px; /* è¨­å®šå³é‚Šè·é›¢ï¼Œå¼·è¿«æ‹‰å¯¬ */
            width: auto; /* è®“ left å’Œ right æ±ºå®šå¯¬åº¦ */
            
            /* æˆ–è€…ä½ å¯ä»¥ç›´æ¥ç”¨é€™è¡Œï¼š
            width: calc(100% - 20px); 
            */

            /* 2. é—œéµï¼šè§£é™¤åŸæœ¬çš„å¯¬åº¦é™åˆ¶ */
            max-width: none; 

            /* 3. é«˜åº¦èˆ‡å®šä½è¨­å®š */
            bottom: 30px; 
            height: auto;
            max-height: 75vh;
            
            /* 4. æ’ç‰ˆè¨­å®š */
            display: flex;
            flex-direction: column;
            z-index: 1050; 
        }
        
        /* å…§å®¹å€ï¼šè§£é™¤é«˜åº¦é™åˆ¶ï¼Œè®“å®ƒæ’é–‹ */
        .kb-body {
            max-height: none; 
            overflow-y: auto; /* åªæœ‰ç•¶æ•´å¼µå¡ç‰‡çœŸçš„å¤ªé«˜(è¶…é75vh)æ™‚æ‰å‡ºç¾æ²è»¸ */
            flex-grow: 1;
        }
        
        /* æ¨™é¡Œåˆ—å¾®èª¿ */
        .kb-header { padding: 10px 12px; }
        .kb-title { font-size: 0.95rem; }
        
        /* æ”¶åˆæ¨¡å¼ï¼šç¸®æˆä¸€å€‹å°è† å›Š */
        #kitchenBoard.collapsed {
            width: auto;
            min-width: 140px;
            /* æ”¶åˆæ™‚ä¸éœ€è¦ä½”ä½ */
            height: auto; 
        }
    }
</style>
</head>

<body>
  <nav class="navbar navbar-dark sticky-top">
    <div class="container-fluid">
      <div class="d-flex align-items-center flex-grow-1">
        <span class="navbar-brand fw-bold me-2">ğŸ“ ç®¡ç†ç³»çµ±</span>
        <select id="storeSelector" class="store-selector-nav me-auto" onchange="switchStore()">
          <option value="dajin">å¤§æ´¥ç€‘å¸ƒ</option>
          <option value="neipu">å…§åŸ”å¹´è¡—</option>
        </select>
      </div>
      <button id="navVoiceBtn" class="btn btn-voice-nav voice-inactive" onclick="toggleVoiceControl()">
        <svg id="icon-mic" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
            <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
        </svg>
        <svg id="icon-wave" class="d-none" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <rect x="6" y="4" width="4" height="16" rx="2"/>
            <rect x="14" y="4" width="4" height="16" rx="2"/>
        </svg>
      </button>
      <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasMenu">
        <span class="navbar-toggler-icon"></span>
      </button>
    </div>
  </nav>

  <div class="sticky-controls pb-2 mb-3">
    <div class="container">
      
      <div class="input-group input-group-sm modern-search-bar">
          <span class="input-group-text">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#999" viewBox="0 0 16 16">
                  <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
              </svg>
          </span>
          
          <input type="tel" id="searchInput" class="form-control" 
                placeholder="è¼¸å…¥å–®è™Ÿæˆ–æ‰‹æ©Ÿæœ«4ç¢¼" onkeyup="handleSearch()">
                
          <button class="btn btn-clear" type="button" onclick="clearSearch()">âœ•</button>
      </div>

      <div id="filterContainer" class="no-scrollbar">
        <button class="btn btn-dark filter-btn active position-relative" onclick="setFilter('all')">
          å…¨éƒ¨
        </button>
        
        <button class="btn btn-secondary filter-btn position-relative" onclick="setFilter('pending')">
          æ–°å–®
          <span id="badge-pending" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none animate__animated">0</span>
        </button>
        
        <button class="btn btn-primary filter-btn position-relative" onclick="setFilter('confirmed')">
          æˆç«‹
          <span id="badge-confirmed" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none animate__animated">0</span>
        </button>

        <button class="btn btn-warning filter-btn position-relative" onclick="setFilter('preparing')">
          è£½ä½œ
          <span id="badge-preparing" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none animate__animated">0</span>
        </button>
        
        <button class="btn btn-success filter-btn position-relative" onclick="setFilter('uncollected')">
          æœªå–
          <span id="badge-uncollected" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none animate__animated">0</span>
        </button>

        <button class="btn btn-light border filter-btn position-relative" onclick="setFilter('final')">
          å®Œæˆ
          <span id="badge-final" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none animate__animated">0</span>
        </button>

        <button class="btn btn-danger bg-opacity-75 filter-btn position-relative" onclick="setFilter('cancelled')">
          å–æ¶ˆ
        </button>
      </div>
      </div>
  </div>

  <div class="container mt-3" id="orderList">
    <div class="text-center mt-5 text-muted">
      <div class="spinner-border text-danger mb-3" role="status"></div>
      <p>æ­£åœ¨åŒæ­¥è¨‚å–®è³‡æ–™...</p>
    </div>
  </div>

  <div class="container mt-4 mb-5 pb-5">
    <nav aria-label="Order pagination">
      <ul class="pagination justify-content-center" id="paginationControls"></ul>
    </nav>
    <div class="text-center text-muted small mt-2" id="pageInfo"></div>
  </div>

  <div class="container">
    <div id="voiceDebug"></div>
    <div id="volumeContainer" class="progress mx-auto mt-1" style="width: 150px; height: 4px; background-color: #eee; border-radius: 5px; overflow: hidden; opacity: 0; transition: opacity 0.3s;">
      <div id="volumeBar" class="progress-bar bg-danger" style="width: 0%; transition: width 0.05s;"></div>
    </div>
  </div>

  <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasMenu">
    <div class="offcanvas-header bg-danger text-white">
      <h5 class="offcanvas-title fw-bold">åŠŸèƒ½é¸å–®</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
      <div class="list-group">
        <a href="javascript:void(0)" onclick="resetBusinessDay()" class="list-group-item list-group-item-action py-3 fw-bold text-dark">æ”¶æ”¤çµç®—</a>
        <a href="javascript:void(0)" onclick="goToReport()" class="list-group-item list-group-item-action py-3 fw-bold text-danger">ç‡Ÿæ¥­å ±è¡¨çµ±è¨ˆ</a>
        <a href="/backend/" class="list-group-item list-group-item-action py-3">å•†å“ç®¡ç†</a>
        <a href="/admin/" class="list-group-item list-group-item-action py-3">ç³»çµ±ç®¡ç†</a>
        <a href="javascript:void(0)" onclick="openStatusBoard()" class="list-group-item list-group-item-action py-3 text-primary">å«è™Ÿçœ‹æ¿</a>
        <hr>
      </div>
    </div>
  </div>

  <div id="audio-unlocker">
    <h2 class="mb-4 animate__animated animate__fadeInDown">ğŸ“ ä¸€æŠŠè‘«ç®¡ç†ç³»çµ±</h2>
    <div class="store-box mb-4 p-4 shadow-lg" style="background: rgba(255,255,255,0.1); border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); width: 90%; max-width: 400px;">
        <p class="mb-3">é¸æ“‡ç®¡ç†åº—é‹ª</p>
        <select id="initStoreSelector" class="form-select form-select-lg mb-4" style="border-radius: 12px; font-weight: bold;">
            <option value="" disabled selected>è¼‰å…¥ä¸­...</option>
        </select>
        <button onclick="unlockAudio()" id="startBtn" class="btn btn-light btn-lg fw-bold w-100 py-3 shadow" style="border-radius: 15px; color: #d63031;">
            å•Ÿå‹•ç³»çµ±
        </button>
    </div>
    <p class="small opacity-75">å•Ÿå‹•å¾Œå°‡é–‹å•ŸèªéŸ³é€šçŸ¥èˆ‡å³æ™‚è¨‚å–®ç›£æ¸¬</p>
  </div>

  <div class="modal fade" id="editOrderModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg"> <div class="modal-content" style="border-radius: 20px;">
        <div class="modal-header border-0 bg-light">
          <h5 class="modal-title fw-bold">âœï¸ ä¿®æ”¹è¨‚å–® #<span id="editOrderIdDisplay"></span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-0">
          <div id="editProductList" class="list-group list-group-flush" style="max-height: 60vh; overflow-y: auto;">
              </div>
        </div>
        <div class="modal-footer border-top shadow-sm justify-content-between">
          <div>
              <span class="text-muted small">ä¿®æ­£å¾Œç¸½é¡ï¼š</span>
              <span class="fs-4 fw-bold text-danger" id="editTotalAmount">$0</span>
          </div>
          <div>
              <button type="button" class="btn btn-secondary rounded-pill me-2" data-bs-dismiss="modal">å–æ¶ˆ</button>
              <button type="button" class="btn btn-danger rounded-pill px-4 fw-bold" onclick="saveOrderChange()">ç¢ºèªå„²å­˜</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="kitchenBoard">
    <div class="kb-header" onclick="toggleKitchenBoard()">
        <div class="kb-title">
            <span>ğŸ‘¨â€ğŸ³ è£½ä½œæ¸…å–®</span>
            <span id="kbTotalCount" class="kb-badge d-none">0</span>
        </div>
        <div class="kb-toggle">â–¼</div>
    </div>
    <div class="kb-body" id="kbContent">
        <div class="kb-empty">ç›®å‰ç„¡è£½ä½œä¸­é¤é»</div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ==========================================
    // 1. åŸºç¤è®Šæ•¸èˆ‡è¨­å®š
    // ==========================================
    let currentStore = localStorage.getItem('selected_store') || ''; 
    let storesData = []; 
    let isFirstLoad = true;
    let lastCounts = {};
    
    // é€šçŸ¥è¨˜éŒ„
    let alertedArrived = new Set(JSON.parse(localStorage.getItem('alerted_arrived') || '[]'));
    let alertedNewOrder = new Set(JSON.parse(localStorage.getItem('alerted_new_orders') || '[]'));
    let alertedLinePayPaid = new Set(JSON.parse(localStorage.getItem('alerted_linepay_paid') || '[]'));
    let lastOrdersJson = ''; 
    let allProducts = [], currentEditingOrderId = null, currentEditingItems = [];
    let kbCheckedState = {};

    // ==========================================
    // 2. èªéŸ³èˆ‡éŸ³æ•ˆè®Šæ•¸ (æ ¸å¿ƒä¿®å¾©)
    // ==========================================
    let audioContext = null;        
    let recognition = null;         
    let isVoiceControlling = false; 
    let isRecognitionActive = false;
    let isSpeaking = false; 
    let restartTimer = null; // é‡å•Ÿè¨ˆæ™‚å™¨
    let lastFinalText = "", lastFinalAt = 0;
    let micStream = null, micSource = null, analyserNode = null, rafId = null;

    // ğŸ›‘ é˜²æ­¢èªéŸ³ç‰©ä»¶è¢«å›æ”¶
    const utteranceStorage = [];

    // ==========================================
    // 3. åˆå§‹åŒ–æµç¨‹
    // ==========================================
    document.addEventListener('DOMContentLoaded', () => {
        fetchStores();
        if ('speechSynthesis' in window) window.speechSynthesis.getVoices(); 
    });

    document.addEventListener('DOMContentLoaded', () => {
        fetchStores();
        fetchAllProducts(); // æ–°å¢é€™è¡Œ
        // ...å…¶ä»–åŸæœ¬çš„ä»£ç¢¼
    });

    function fetchStores() {
        fetch('/api/stores/')
            .then(res => res.json())
            .then(data => {
                storesData = data;
                const initSelector = document.getElementById('initStoreSelector');
                const navSelector = document.getElementById('storeSelector');
                if (!initSelector || !navSelector) return;

                initSelector.innerHTML = '';
                navSelector.innerHTML = '';

                data.forEach(store => {
                    const opt = document.createElement('option');
                    opt.value = store.slug;
                    opt.textContent = store.name;
                    initSelector.appendChild(opt.cloneNode(true));
                    navSelector.appendChild(opt);
                });

                if (currentStore && data.some(s => s.slug === currentStore)) {
                    initSelector.value = currentStore;
                    navSelector.value = currentStore;
                } else if (data.length > 0) {
                    currentStore = data[0].slug;
                }
                updateStoreUI();
            })
            .catch(err => console.error("åˆ†åº—è¼‰å…¥å¤±æ•—", err));
    }

    async function unlockAudio() {
        const initSelector = document.getElementById('initStoreSelector');
        if (!initSelector || !initSelector.value) return Swal.fire("è«‹å…ˆé¸æ“‡åˆ†åº—");

        currentStore = initSelector.value;
        localStorage.setItem('selected_store', currentStore);
        document.getElementById('storeSelector').value = currentStore;
        updateStoreUI();

        if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
        if (audioContext.state === 'suspended') await audioContext.resume();

        const unlocker = document.getElementById('audio-unlocker');
        unlocker.classList.add('animate__animated', 'animate__fadeOut');
        setTimeout(() => { unlocker.style.display = 'none'; }, 500);

        playBell();
        setTimeout(() => speak("ç³»çµ±å•Ÿå‹•æˆåŠŸ"), 600);

        loadOrders();
        setInterval(loadOrders, 5000); 
    }

    // ==========================================
    // 4. éŸ³æ•ˆ
    // ==========================================
    function playBell() {
        if (!audioContext) return;
        if (audioContext.state === 'suspended') audioContext.resume();

        const now = audioContext.currentTime;
        const osc1 = audioContext.createOscillator();
        const gain1 = audioContext.createGain();
        osc1.type = 'sine';
        osc1.frequency.setValueAtTime(660, now); 
        gain1.gain.setValueAtTime(0.1, now);
        gain1.gain.exponentialRampToValueAtTime(0.001, now + 1.5);
        osc1.connect(gain1);
        gain1.connect(audioContext.destination);
        osc1.start(now);
        osc1.stop(now + 1.5);

        const osc2 = audioContext.createOscillator();
        const gain2 = audioContext.createGain();
        osc2.type = 'sine';
        osc2.frequency.setValueAtTime(523.25, now + 0.4); 
        gain2.gain.setValueAtTime(0.1, now + 0.4);
        gain2.gain.exponentialRampToValueAtTime(0.001, now + 2);
        osc2.connect(gain2);
        gain2.connect(audioContext.destination);
        osc2.start(now + 0.4);
        osc2.stop(now + 2);
    }

    // ==========================================
    // 5. ğŸ¤ èªéŸ³æ§åˆ¶ (æ ¸å¿ƒä¿®å¾©å€)
    // ==========================================
    
    // â˜…â˜…â˜… 1. å®šç¾©é‡å•Ÿå‡½å¼ (å¿…é ˆåœ¨è¢«å‘¼å«å‰å®šç¾©) â˜…â˜…â˜…
    function scheduleRestart(ms) {
        if (restartTimer) clearTimeout(restartTimer);
        restartTimer = setTimeout(() => {
            if (isVoiceControlling && recognition && !isSpeaking) {
                try { 
                    recognition.start(); 
                    const dbg = document.getElementById('voiceDebug');
                    if(dbg) dbg.innerText = "ğŸ¤ è†è½ä¸­...";
                } catch(e) { /* å¿½ç•¥é‡è¤‡å•Ÿå‹•éŒ¯èª¤ */ }
            }
        }, ms);
    }

    // â˜…â˜…â˜… 2. èªéŸ³åˆæˆ (è¬›è©±æ™‚æš«åœè¾¨è­˜) â˜…â˜…â˜…
    function speak(text) {
        if (!('speechSynthesis' in window)) return;
        
        // èªªè©±æ™‚æš«åœè¾¨è­˜ï¼Œé¿å…è½åˆ°è‡ªå·±
        if (isVoiceControlling && recognition) {
            isSpeaking = true;
            try { recognition.abort(); } catch(e){}
        }

        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'zh-TW';
        u.rate = 1.1; 
        
        const voices = window.speechSynthesis.getVoices();
        const zhVoice = voices.find(v => v.lang === 'zh-TW') || voices.find(v => v.lang.includes('zh'));
        if (zhVoice) u.voice = zhVoice;

        utteranceStorage.push(u);
        u.onend = function() {
            const index = utteranceStorage.indexOf(u);
            if (index > -1) utteranceStorage.splice(index, 1);
            
            // èªªå®Œè©±å¾Œæ¢å¾©è¾¨è­˜
            isSpeaking = false;
            // å‘¼å«é‡å•Ÿå‡½å¼ (é€™è£¡å°±æ˜¯æ‚¨åŸæœ¬å ±éŒ¯çš„åœ°æ–¹)
            scheduleRestart(200);
        };
        window.speechSynthesis.speak(u);
    }

    async function toggleVoiceControl() {
        if (!isVoiceControlling) {
             try { await startVoiceControl(); } 
             catch(e) { Swal.fire("éŒ¯èª¤", "ç„¡æ³•å•Ÿå‹•éº¥å…‹é¢¨", "error"); }
        } else { 
            stopVoiceControl(); 
        }
    }

    // ==========================================
    // 5. ğŸ¤ èªéŸ³æ§åˆ¶ (ç„¡é™çºŒå‘½ç‰ˆ)
    // ==========================================

    let ignoreAutoStop = false; //ç”¨ä¾†å¿½ç•¥ Chrome çš„è‡ªå‹•æ–·ç·š

    async function startVoiceControl() {
        if (!('webkitSpeechRecognition' in window)) return Swal.fire("è«‹ä½¿ç”¨ Chrome ç€è¦½å™¨");
        
        // 1. è™•ç†éŸ³æ•ˆ Context (åªç”¨æ–¼æ’­æ”¾æç¤ºéŸ³)
        if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
        if (audioContext.state === 'suspended') await audioContext.resume();

        // 2. UI æ›´æ–°
        isVoiceControlling = true;
        const btn = document.getElementById('navVoiceBtn');
        btn.classList.add('voice-active');
        btn.classList.remove('voice-inactive');
        
        // â˜…â˜…â˜… æ–°å¢ï¼šåˆ‡æ› SVG åœ–ç¤º â˜…â˜…â˜…
        document.getElementById('icon-mic').classList.add('d-none'); // éš±è—éº¥å…‹é¢¨
        document.getElementById('icon-wave').classList.remove('d-none'); // é¡¯ç¤ºæ³¢å½¢(æš«åœéˆ•)
        
        // 3. å•Ÿå‹•è¾¨è­˜
        initRecognition();
        startRecognitionSafe();
        
        speak("è²æ§å·²å•Ÿå‹•");
    }

    function stopVoiceControl() {
        isVoiceControlling = false;
        isSpeaking = false;
        ignoreAutoStop = false; // åœæ­¢æ™‚å–æ¶ˆå¿½ç•¥æ¨™è¨˜

        if (restartTimer) clearTimeout(restartTimer);

        const btn = document.getElementById('navVoiceBtn');
        btn.classList.remove('voice-active');
        btn.classList.add('voice-inactive');
        document.getElementById('icon-mic').classList.remove('d-none'); // é¡¯ç¤ºéº¥å…‹é¢¨
        document.getElementById('icon-wave').classList.add('d-none'); // éš±è—æ³¢å½¢
        
        const dbg = document.getElementById('voiceDebug');
        if(dbg) dbg.innerText = "";

        if (recognition) {
            recognition.onend = null; // ç§»é™¤ç›£è½ï¼Œé˜²æ­¢å®ƒæ­»ç°å¾©ç‡ƒ
            try { recognition.abort(); } catch(e){}
        }
    }

    // å®‰å…¨å•Ÿå‹•å‡½å¼
    function startRecognitionSafe() {
        if (!recognition || !isVoiceControlling) return;
        try {
            recognition.start();
            document.getElementById('voiceDebug').innerText = "ğŸ¤ ç›£è½ä¸­...";
        } catch (e) {
            // å¦‚æœå·²ç¶“æ˜¯ç”¨æ–¼å•Ÿå‹•ç‹€æ…‹ï¼Œå¿½ç•¥éŒ¯èª¤
            if (e.message.includes('already started')) return;
            console.log("é‡å•Ÿç·©è¡ä¸­...");
        }
    }

    function initRecognition() {
        if (!window.webkitSpeechRecognition) return;
        
        // æ¸…é™¤èˆŠçš„
        if (recognition) {
             recognition.onend = null;
             try { recognition.abort(); } catch(e){}
        }

        recognition = new window.webkitSpeechRecognition();
        recognition.lang = 'zh-TW';
        
        // â˜…â˜…â˜… é—œéµä¿®æ”¹ 1ï¼šé—œé–‰é€£çºŒæ¨¡å¼ï¼Œæ”¹ç‚ºã€Œä¸€å¥ä¸€çµç®—ã€ â˜…â˜…â˜…
        recognition.continuous = false; 
        
        // ä»ç„¶é–‹å•Ÿå³æ™‚é¡¯ç¤ºï¼Œè®“ä½ çœ‹åˆ°å®ƒåœ¨é‹ä½œ
        recognition.interimResults = true; 

        // --- è¨ºæ–·ä»£ç¢¼ä¿ç•™ ---
        recognition.onaudiostart = () => console.log("âœ… 1. éŸ³è¨Šé€šé“");
        recognition.onsoundstart = () => console.log("ğŸ”Š 2. æ”¶åˆ°è²éŸ³");
        recognition.onspeechstart = () => console.log("ğŸ—£ï¸ 3. åµæ¸¬åˆ°äººè²");
        // -------------------

        recognition.onstart = () => { 
            isRecognitionActive = true;
            // åªæœ‰é™¤éŒ¯æ™‚æ‰é¡¯ç¤ºï¼Œé¿å…æ´—ç‰ˆ
            // console.log("é–‹å§‹è†è½...");
        };
        
        // â˜…â˜…â˜… é—œéµä¿®æ”¹ 2ï¼šé€™è£¡åªè¦æœ‰ä»»ä½•çµæœï¼Œéƒ½å…ˆå°å‡ºä¾†çœ‹çœ‹ â˜…â˜…â˜…
        recognition.onresult = (event) => {
            console.log("ğŸ“ 4. æ”¶åˆ°è³‡æ–™åŒ… (onresultè§¸ç™¼)"); // ç¢ºä¿æœ‰é€²åˆ°é€™è£¡
            
            let finalTranscript = "";
            let interimTranscript = "";

            for (let i = event.resultIndex; i < event.results.length; i++) {
                const transcript = event.results[i][0].transcript;
                if (event.results[i].isFinal) {
                    finalTranscript += transcript;
                    console.log("ğŸ¯ æœ€çµ‚çµæœ:", finalTranscript); // é€™è£¡æ‰æ˜¯çœŸæ­£è¾¨è­˜å‡ºçš„å­—
                    processVoiceCommand(finalTranscript);
                } else {
                    interimTranscript += transcript;
                }
            }
            
            // æ›´æ–° UI è®“ä½ çŸ¥é“å®ƒæœ‰åœ¨è½
            const dbg = document.getElementById('voiceDebug');
            if(dbg) {
                if(finalTranscript) dbg.innerText = `âœ…: ${finalTranscript}`;
                else if(interimTranscript) dbg.innerText = `ğŸ‘‚: ${interimTranscript}`;
            }
        };

        recognition.onend = () => { 
            isRecognitionActive = false; 
            // console.log("æ–·ç·šï¼Œæº–å‚™é‡é€£...");

            // â˜…â˜…â˜… é—œéµä¿®æ”¹ 3ï¼šPulse Mode æ ¸å¿ƒ - æ–·ç·šå¾Œã€Œç§’é€Ÿã€é‡é€£ â˜…â˜…â˜…
            if (isVoiceControlling && !isSpeaking) {
                // é€™è£¡ç¨å¾®åŠ  50ms å»¶é²è®“ç€è¦½å™¨å–˜å£æ°£ï¼Œé¿å…ç•¶æ©Ÿ
                setTimeout(() => {
                    startRecognitionSafe();
                }, 50);
            }
        };

        recognition.onerror = (event) => {
            // å¿½ç•¥å¸¸è¦‹çš„ç„¡è²æˆ–é‡è¤‡éŒ¯èª¤
            if (event.error === 'no-speech' || event.error === 'aborted') return;
            
            console.warn('å ±éŒ¯:', event.error);
            if (event.error === 'network') {
                Swal.fire("ç¶²è·¯éŒ¯èª¤", "èªéŸ³è¾¨è­˜éœ€è¦é€£æ¥ Google ä¼ºæœå™¨", "error");
            }
        };
    }

    // ==========================================
    // 6. æŒ‡ä»¤è§£æèˆ‡åŸ·è¡Œ (å«å±•é–‹/æ”¶åˆåŠŸèƒ½)
    // ==========================================
    function processVoiceCommand(text) {
        if (text === lastFinalText && (Date.now() - lastFinalAt) < 1000) return;
        lastFinalText = text;
        lastFinalAt = Date.now();

        console.log(`ğŸ¤– æŒ‡ä»¤: "${text}"`); 
        const cleanText = text.replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g, ""); 

        // --------------------------------------------------
        // â˜…â˜…â˜… ç¬¬ä¸€å±¤ï¼šå„ªå…ˆåˆ¤æ–·ã€Œå…¨éƒ¨ã€æ“ä½œ (ä¸éœ€è¦è¨‚å–®è™Ÿ) â˜…â˜…â˜…
        // --------------------------------------------------
        
        // ã€å…¨éƒ¨æ”¶åˆ/é—œé–‰ã€‘
        if (cleanText.includes("å…¨éƒ¨") && (cleanText.includes("æ”¶åˆ") || cleanText.includes("æ”¶èµ·ä¾†") || cleanText.includes("é—œé–‰") || cleanText.includes("ç¸®"))) {
            console.log(`âœ… è§¸ç™¼: å…¨éƒ¨æ”¶åˆ`);
            speak("å·²æ”¶åˆæ‰€æœ‰è¨‚å–®");
            collapseAllOrders();
            return;
        }

        // ã€å…¨éƒ¨å±•é–‹/æ‰“é–‹ã€‘
        if (cleanText.includes("å…¨éƒ¨") && (cleanText.includes("å±•é–‹") || cleanText.includes("æ‰“é–‹") || cleanText.includes("é¡¯ç¤º"))) {
            console.log(`âœ… è§¸ç™¼: å…¨éƒ¨å±•é–‹`);
            speak("å±•é–‹æ‰€æœ‰è¨‚å–®");
            expandAllOrders();
            return;
        }

        // ã€åˆ‡æ›åˆ†é ã€‘(åŸæœ¬çš„é‚è¼¯)
        if (cleanText.includes("åˆ‡æ›") || cleanText.includes("é¡¯ç¤º") || cleanText.includes("çœ‹")) {
            // ... (ç¶­æŒæ‚¨åŸæœ¬çš„åˆ‡æ›é‚è¼¯ï¼Œé€™è£¡çœç•¥ä»¥ç¯€çœç¯‡å¹…) ...
            // å¦‚æœæ‚¨éœ€è¦é€™æ®µï¼Œè«‹ä¿ç•™ä¸Šä¸€ç‰ˆçµ¦æ‚¨çš„åˆ‡æ›ä»£ç¢¼
            let targetFilter = null;
            let targetName = "";
            if (cleanText.includes("å…¨éƒ¨")) { targetFilter = 'all'; targetName = "å…¨éƒ¨è¨‚å–®"; }
            else if (cleanText.includes("æ¸…å–®")) { targetFilter = 'pending'; targetName = "æ–°è¨‚å–®"; }
            else if (cleanText.includes("æˆç«‹")) { targetFilter = 'confirmed'; targetName = "æˆç«‹è¨‚å–®"; }
            else if (cleanText.includes("è£½ä½œ")) { targetFilter = 'preparing'; targetName = "è£½ä½œä¸­è¨‚å–®"; }
            else if (cleanText.includes("ä½ç½®")) { targetFilter = 'uncollected'; targetName = "æœªå–é¤è¨‚å–®"; }
            else if (cleanText.includes("å®Œæˆ")) { targetFilter = 'final'; targetName = "å·²å®Œæˆè¨‚å–®"; }
            else if (cleanText.includes("å–æ¶ˆ")) { targetFilter = 'cancelled'; targetName = "å·²å–æ¶ˆè¨‚å–®"; }

            if (targetFilter) {
                speak(`åˆ‡æ›åˆ° ${targetName}`);
                setFilter(targetFilter);
                return;
            }
        }

        // --------------------------------------------------
        // â˜…â˜…â˜… ç¬¬äºŒå±¤ï¼šé‡å°ã€Œç‰¹å®šè™Ÿç¢¼ã€æ“ä½œ â˜…â˜…â˜…
        // --------------------------------------------------
        
        let orderId = null;
        const numMatch = cleanText.match(/(\d+)/);
        if (numMatch) orderId = parseInt(numMatch[1]);
        else {
            const zhNum = cleanText.match(/[é›¶ä¸€äºŒå…©ä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+/);
            if (zhNum) orderId = parseChineseNumber(zhNum[0]);
        }

        if (!orderId) return;

        console.log(`ğŸ”¢ è¨‚å–®è™Ÿ: ${orderId}`);

        // ã€å–®ç¨æ”¶åˆã€‘(â˜… æ–°å¢)
        if (cleanText.includes("æ”¶åˆ") || cleanText.includes("é—œé–‰") || cleanText.includes("ç¸®") || cleanText.includes("é—œèµ·ä¾†")) {
            console.log(`âœ… è§¸ç™¼: æ”¶åˆ ${orderId}è™Ÿ`);
            // ä¸ç”¨èªéŸ³å›é¥‹ï¼Œç›´æ¥æ”¶èµ·ä¾†æ¯”è¼ƒé †æš¢ï¼Œæˆ–è€…ç°¡å–®å›å€‹ "å¥½"
            collapseSingleOrder(orderId);
        }

        // ã€å–®ç¨å±•é–‹ã€‘(æ‚¨åŸæœ¬çš„åŠŸèƒ½)
        else if (cleanText.includes("å±•é–‹") || cleanText.includes("æ‰“é–‹") || cleanText.includes("æœå°‹") || cleanText.includes("æ‰¾")) {
            speak(`å±•é–‹ ${orderId}è™Ÿ`);
            searchAndExpand(orderId);
        }

        // ã€ç‹€æ…‹æ“ä½œã€‘(ä»˜æ¬¾/è£½ä½œ/å®Œæˆ/çµæ¡ˆ...ç¶­æŒåŸæ¨£)
        else if (cleanText.includes("ä»˜æ¬¾") || cleanText.includes("æ”¶éŒ¢")) {
            speak(`${orderId}è™Ÿ å·²ä»˜æ¬¾`);
            updateStatus(orderId, 'confirmed');
        }
        else if (cleanText.includes("è£½ä½œ") || cleanText.includes("åš")) {
            speak(`${orderId}è™Ÿ è£½ä½œä¸­`);
            updateStatus(orderId, 'preparing');
        }
        else if (cleanText.includes("å®Œæˆ") || cleanText.includes("å¥½äº†") || cleanText.includes("é€šçŸ¥")) {
            speak(`${orderId}è™Ÿ è£½ä½œå®Œæˆ`);
            updateStatus(orderId, 'completed', true);
        }
        else if (cleanText.includes("çµæ¡ˆ") || cleanText.includes("äº¤ä»˜")) {
            updateStatus(orderId, 'final');
        }
    }

    function parseChineseNumber(s) {
        const map = {'é›¶':0,'ä¸€':1,'äºŒ':2,'å…©':2,'ä¸‰':3,'å››':4,'äº”':5,'å…­':6,'ä¸ƒ':7,'å…«':8,'ä¹':9,'å':10};
        let val = 0;
        if (s.startsWith('å')) s = 'ä¸€' + s; 
        let parts = s.split('å');
        if (parts.length === 1) return map[parts[0]] || 0;
        if (parts.length === 2) {
            let ten = map[parts[0]] || 0;
            let unit = map[parts[1]] || 0;
            return ten * 10 + unit;
        }
        return 0;
    }
    
    function startVolumeMeter() {
        const volBar = document.getElementById('volumeBar');
        const buffer = new Uint8Array(analyserNode.frequencyBinCount);
        const draw = () => {
            if (!isVoiceControlling) return;
            analyserNode.getByteFrequencyData(buffer);
            let sum = 0;
            for(let i=0; i<buffer.length; i++) sum += buffer[i];
            let avg = sum / buffer.length;
            if(volBar) volBar.style.width = Math.min(avg * 2.5, 100) + "%";
            rafId = requestAnimationFrame(draw);
        };
        draw();
    }

    function searchAndExpand(id) {
        // 1. å¼·åˆ¶åˆ‡æ›åˆ°ã€Œå…¨éƒ¨ã€é ç±¤ï¼Œä»¥å…è©²è¨‚å–®åœ¨å…¶ä»–åˆ†é¡è¢«éš±è—
        currentFilter = 'all';
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        // å‡è¨­ç¬¬ä¸€å€‹æŒ‰éˆ•æ˜¯ã€Œå…¨éƒ¨ã€ï¼Œçµ¦å®ƒ active
        const allBtn = document.querySelector('.filter-btn'); 
        if(allBtn) allBtn.classList.add('active');

        // 2. è¨­å®šæœå°‹é—œéµå­—
        searchQuery = id.toString();
        const input = document.getElementById('searchInput');
        if (input) input.value = searchQuery; // åŒæ­¥æ›´æ–°æœå°‹æ¡†æ–‡å­—

        // 3. é‡æ–°æ¸²æŸ“åˆ—è¡¨ (é€™æ™‚åˆ—è¡¨åªæœƒå‰©ä¸‹ä¸€å¼µå–®)
        renderOrders();

        // 4. å¼·åˆ¶å±•é–‹è©²è¨‚å–®çš„æ˜ç´°
        // å› ç‚º renderOrders æ˜¯åŒæ­¥çš„ï¼Œæ‰€ä»¥ DOM å·²ç¶“å»ºç«‹å¥½äº†
        const detailEl = document.getElementById(`detail-${id}`);
        const arrowEl = document.getElementById(`arrow-${id}`);

        if (detailEl) {
            detailEl.classList.remove('hide-detail'); // ç§»é™¤éš±è— class
            // åŠ ä¸Šé«˜äº®å‹•ç•«ï¼Œè®“ä½¿ç”¨è€…çŸ¥é“æ˜¯é€™å¼µ
            detailEl.parentElement.classList.add('animate__animated', 'animate__pulse');
        }
        
        if (arrowEl) {
            arrowEl.style.transform = 'rotate(180deg)'; // ç®­é ­è½‰å‘
        }
    }

    // ==========================================
    // ğŸ“‚ å±•é–‹èˆ‡æ”¶åˆæ§åˆ¶å‡½å¼
    // ==========================================

    // 1. å…¨éƒ¨å±•é–‹ (é¡¯ç¤ºæ‰€æœ‰æ˜ç´°)
    function expandAllOrders() {
        document.querySelectorAll('.detail-content').forEach(el => {
            el.classList.remove('hide-detail'); // ç§»é™¤éš±è—
            // åŠ ä¸Šé«˜äº®å‹•ç•«
            el.parentElement.classList.add('animate__animated', 'animate__pulse');
        });
        document.querySelectorAll('.arrow').forEach(el => {
            el.style.transform = 'rotate(180deg)'; // ç®­é ­æœä¸Š
        });
    }

    // 2. å…¨éƒ¨æ”¶åˆ (åªç•™æ¨™é¡Œ)
    function collapseAllOrders() {
        document.querySelectorAll('.detail-content').forEach(el => {
            el.classList.add('hide-detail'); // åŠ å…¥éš±è—
        });
        document.querySelectorAll('.arrow').forEach(el => {
            el.style.transform = 'rotate(0deg)'; // ç®­é ­æœä¸‹
        });
    }

    // 3. å–®ç¨æ”¶åˆ (é—œé–‰ç‰¹å®š ID)
    function collapseSingleOrder(id) {
        const detailEl = document.getElementById(`detail-${id}`);
        const arrowEl = document.getElementById(`arrow-${id}`);
        
        if (detailEl && !detailEl.classList.contains('hide-detail')) {
            detailEl.classList.add('hide-detail');
            if (arrowEl) arrowEl.style.transform = 'rotate(0deg)';
        }
    }

    function stopVolumeMeter() { if (rafId) cancelAnimationFrame(rafId); }

    // ==========================================
    // 6. è³‡æ–™è¼‰å…¥èˆ‡æ¸²æŸ“ (UI é‚è¼¯)
    // ==========================================
    function switchStore() {
        currentStore = document.getElementById('storeSelector').value;
        localStorage.setItem('selected_store', currentStore);
        updateStoreUI();
        isFirstLoad = true;
        alertedArrived.clear();
        loadOrders();
        speak("å·²åˆ‡æ›åˆ†åº—");
    }

    function updateStoreUI() {
        const storeObj = storesData.find(s => s.slug === currentStore);
        if(document.getElementById('targetStoreName')) 
            document.getElementById('targetStoreName').innerText = storeObj ? storeObj.name : "";
    }

    // ==========================================
    // 7. ğŸ‘¨â€ğŸ³ å»šæˆ¿å‚™é¤æˆ°æƒ…æ¿é‚è¼¯ (æ–°åŠŸèƒ½)
    // ==========================================

    // åˆå§‹åŒ–ç‹€æ…‹ (åœ¨é é¢è¼‰å…¥æ™‚æª¢æŸ¥è¨˜æ†¶)
    // æ³¨æ„ï¼šåŸæœ¬ script å‰é¢å¯èƒ½å·²ç¶“æœ‰ä¸€å€‹ DOMContentLoadedï¼Œ
    // é€™è£¡æˆ‘å€‘ç›´æ¥åŠ åœ¨æœ€å¾Œé¢å³å¯ï¼Œç€è¦½å™¨æœƒä¾åºåŸ·è¡Œã€‚
    document.addEventListener('DOMContentLoaded', () => {
        const isCollapsed = localStorage.getItem('kb_collapsed') === 'true';
        const kb = document.getElementById('kitchenBoard');
        if (isCollapsed && kb) {
            kb.classList.add('collapsed');
        }
    });
    
    // è¨ˆç®—ä¸¦æ¸²æŸ“æˆ°æƒ…æ¿ (åƒ…çµ±è¨ˆ preparing ç‹€æ…‹)
    function updateKitchenBoard() {
        if (!rawOrdersCache) return;

        // 1. ç¯©é¸è£½ä½œä¸­è¨‚å–®
        const preparingOrders = rawOrdersCache.filter(o => o.status === 'preparing');
        
        // 2. çµ±è¨ˆå•†å“æ•¸é‡
        const stats = {};
        let totalItems = 0;

        preparingOrders.forEach(order => {
            let items = order.items;
            if (typeof items === 'string') {
                try { items = JSON.parse(items); } catch(e) { items = []; }
            }

            if (items && Array.isArray(items)) {
                items.forEach(item => {
                    const name = item.name || item.product_name || item.title || 'æœªå‘½åå•†å“';
                    const rawQty = item.quantity || item.qty || 0;
                    const qty = parseInt(rawQty, 10);
                    
                    if (!isNaN(qty) && qty > 0) {
                        if (!stats[name]) stats[name] = 0;
                        stats[name] += qty;
                        totalItems += qty;
                    }
                });
            }
        });

        // 3. æ›´æ–° UI
        const boardContent = document.getElementById('kbContent');
        const countBadge = document.getElementById('kbTotalCount');
        
        // Badge é¡¯ç¤º
        if (totalItems > 0) {
            countBadge.innerText = totalItems;
            countBadge.classList.remove('d-none');
        } else {
            countBadge.classList.add('d-none');
            // å¦‚æœæ²’æ±è¥¿åšï¼Œæ¸…ç©ºæ‰“å‹¾ç´€éŒ„ï¼Œé¿å…ç©å¤ªå¤šåƒåœ¾è³‡æ–™
            kbCheckedState = {}; 
        }

        // æ¸²æŸ“åˆ—è¡¨
        if (totalItems === 0) {
            boardContent.innerHTML = `<div class="kb-empty">ç„¡è£½ä½œä¸­é¤é»<br><small class="opacity-50">è«‹åœ¨è¨‚å–®æŒ‰ã€Œé–‹å§‹è£½ä½œã€</small></div>`;
        } else {
            // æ’åºï¼šæ•¸é‡å¤šçš„åœ¨ä¸Šé¢
            const sortedItems = Object.entries(stats).sort((a, b) => b[1] - a[1]);
            
            let html = '';
            sortedItems.forEach(([name, qty], index) => {
                // æª¢æŸ¥æ­¤å•†å“æ˜¯å¦è¢«æ¨™è¨˜ç‚ºå·²è®€(æ‰“å‹¾)
                const isChecked = kbCheckedState[name] ? 'checked' : '';
                const rowClass = kbCheckedState[name] ? 'kb-item checked' : 'kb-item';
                const num = index + 1; // ç·¨è™Ÿå¾ 1 é–‹å§‹

                html += `
                    <div class="${rowClass}">
                        <label class="kb-check-wrapper">
                            <input type="checkbox" class="kb-check-input" 
                                   onchange="toggleKbCheck('${name}')" ${isChecked}>
                            <span class="kb-checkmark"></span>
                        </label>
                        <div class="kb-name">
                            <span class="kb-index">${num}.</span>${name}
                        </div>
                        <div class="kb-qty">${qty}</div>
                    </div>
                `;
            });
            boardContent.innerHTML = html;
        }
    }

    // é»æ“Š Checkbox çš„è™•ç†å‡½å¼
    function toggleKbCheck(name) {
        // åˆ‡æ›ç‹€æ…‹ true <-> false
        if (kbCheckedState[name]) {
            delete kbCheckedState[name];
        } else {
            kbCheckedState[name] = true;
        }
        // é‡æ–°æ¸²æŸ“ä»¥å¥—ç”¨æ¨£å¼ (åˆªé™¤ç·šç­‰)
        updateKitchenBoard();
    }

    // åˆ‡æ›å±•é–‹/æ”¶åˆ
    function toggleKitchenBoard() {
        const board = document.getElementById('kitchenBoard');
        board.classList.toggle('collapsed');
        localStorage.setItem('kb_collapsed', board.classList.contains('collapsed'));
    }

    // åˆå§‹åŒ–ç‹€æ…‹ (åœ¨é é¢è¼‰å…¥æ™‚æª¢æŸ¥è¨˜æ†¶)
    document.addEventListener('DOMContentLoaded', () => {
        const isCollapsed = localStorage.getItem('kb_collapsed') === 'true';
        if (isCollapsed) {
            const kb = document.getElementById('kitchenBoard');
            if(kb) kb.classList.add('collapsed');
        }
    });

    function toggleDetail(id) {
        const d = document.getElementById(`detail-${id}`), a = document.getElementById(`arrow-${id}`);
        if(d){ d.classList.toggle('hide-detail'); a.style.transform = d.classList.contains('hide-detail')?'rotate(0deg)':'rotate(180deg)'; }
    }

    function getStatusText(s) { 
        const map = { 'pending': 'å¾…ä»˜', 'confirmed': 'å·²ä»˜', 'preparing': 'è£½ä½œä¸­', 'completed': 'é€šçŸ¥ä¸­', 'arrived': 'åˆ°æ«ƒ', 'final': 'çµæ¡ˆ', 'cancelled': 'å–æ¶ˆ' }; 
        return map[s] || s; 
    }

    function openStatusBoard() {
        if (!currentStore) return Swal.fire('è«‹å…ˆé¸æ“‡åˆ†åº—');
        window.open(`/status/${currentStore}/`, '_blank');
    }

    function goToReport() {
        if(!currentStore) return Swal.fire('è«‹å…ˆé¸æ“‡åˆ†åº—');
        window.location.href = '/dashboard/?store=' + currentStore;
    }

    function getCookie(n) { let v = document.cookie.match('(^|;) ?' + n + '=([^;]*)(;|$)'); return v ? decodeURIComponent(v[2]) : null; }

    function updateStatus(id, status) {
        fetch(`/api/orders/${id}/`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
            body: JSON.stringify({ status: status })
        }).then(res => { 
            if(res.ok) { 
                loadOrders(); 
                if(status==='final') speak(`${id}è™Ÿï¼Œè¨‚å–®å·²å®Œæˆ`);
            } 
        });
    }

    function cancelOrder(id) {
        Swal.fire({
            title: 'å–æ¶ˆè¨‚å–®?', 
            text: "è‹¥æ˜¯ LINE Pay å°‡è‡ªå‹•é€€æ¬¾", 
            icon: 'warning', 
            showCancelButton: true, 
            confirmButtonColor: '#d33', 
            confirmButtonText: 'ç¢ºå®šå–æ¶ˆ'
        }).then((res) => {
            if (res.isConfirmed) {
                fetch(`/api/orders/${id}/cancel/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') }
                }).then(r => r.json()).then(d => {
                    Swal.fire(d.error?'å¤±æ•—':'æˆåŠŸ', d.error||'è¨‚å–®å·²å–æ¶ˆ', d.error?'error':'success');
                    loadOrders();
                });
            }
        });
    }

    function confirmAction(id, status, msg) {
        Swal.fire({ title: msg, icon: 'question', showCancelButton: true, confirmButtonText: 'ç¢ºèª' })
            .then(r => { if(r.isConfirmed) updateStatus(id, status); });
    }

    // ==========================================
    // 1. è®Šæ•¸è¨­å®š (æ”¾åœ¨ Script æœ€ä¸Šæ–¹)
    // ==========================================
    let rawOrdersCache = []; 
    let currentFilter = 'all'; // é è¨­é¡¯ç¤ºå…¨éƒ¨
    let currentPage = 1;     
    let itemsPerPage = 15;   
    let searchQuery = '';    

    // ==========================================
    // 2. å–ä»£åŸæœ¬çš„ loadOrders
    // ==========================================
    function loadOrders() {
        if (!currentStore) return;

        // åŠ å…¥ t=æ™‚é–“æˆ³è¨˜ï¼Œé˜²æ­¢ API è¢«ç€è¦½å™¨å¿«å–
        fetch(`/api/orders/?store=${currentStore}&t=${Date.now()}`)
            .then(res => res.json())
            .then(orders => {
                if (!Array.isArray(orders)) return;

                // 1. èªéŸ³é€šçŸ¥
                orders.forEach(order => {
                    if (order.status === 'pending' && !alertedNewOrder.has(order.id)) {
                        if (!isFirstLoad) speak(`æ–°è¨‚å–® ${order.id}è™Ÿ`);
                        alertedNewOrder.add(order.id);
                    }
                    if (order.status === 'arrived' && !alertedArrived.has(order.id)) {
                        playBell();
                        setTimeout(() => speak(`${order.id}è™Ÿ å®¢äººå·²ç¶“åˆ°æ«ƒæª¯æ‘Ÿ`), 1000);
                        alertedArrived.add(order.id);
                    }
                    if (order.status === 'confirmed' && order.payment_method === 'linepay' && !alertedLinePayPaid.has(order.id)) {
                        speak(`${order.id}è™Ÿ ç·šä¸Šä»˜æ¬¾æˆåŠŸ`);
                        alertedLinePayPaid.add(order.id);
                    }
                });

                // 2. ç´…é»è¨ˆç®—
                let counts = { pending: 0, confirmed: 0, preparing: 0, uncollected: 0 };
                orders.forEach(o => {
                    if (counts.hasOwnProperty(o.status)) counts[o.status]++;
                    if (['completed', 'arrived'].includes(o.status)) counts.uncollected++;
                });

                // 3. æ›´æ–°ç´…é»
                document.querySelectorAll('[id^="badge-"]').forEach(el => el.classList.add('d-none'));
                Object.keys(counts).forEach(key => {
                    const badge = document.getElementById(`badge-${key}`);
                    if (badge) {
                        const newCount = counts[key];
                        const oldCount = lastCounts[key] || 0;
                        badge.innerText = newCount > 99 ? '99+' : newCount;
                        if (newCount > 0) {
                            badge.classList.remove('d-none');
                            if (newCount > oldCount) {
                                badge.classList.remove('animate__heartBeat');
                                void badge.offsetWidth; 
                                badge.classList.add('animate__heartBeat');
                            }
                        }
                    }
                });
                lastCounts = {...counts};

                // 4. åˆ—è¡¨æ¸²æŸ“ & æˆ°æƒ…æ¿æ›´æ–°
                const jsonStr = JSON.stringify(orders);
                rawOrdersCache = orders; // â˜… ç¢ºä¿å¿«å–æœ€æ–°

                if (jsonStr !== lastOrdersJson) {
                    lastOrdersJson = jsonStr;
                    renderOrders();
                }
                
                // â˜… æ¯æ¬¡éƒ½å‘¼å«ï¼Œç¢ºä¿æˆ°æƒ…æ¿æ•¸å­—æ­£ç¢º (åŒ…å« parseInt ä¿®å¾©)
                updateKitchenBoard();

                isFirstLoad = false;
            })
            .catch(err => console.error("è¼‰å…¥å¤±æ•—", err));
    }

    // ==========================================
    // 3. æ ¸å¿ƒæ¸²æŸ“å‡½å¼ (åŒ…å«æ–°åˆ†é¡é‚è¼¯)
    // ==========================================
    function renderOrders() {
        let filtered = rawOrdersCache.slice(); 

        // æœå°‹
        if (searchQuery) {
            filtered = filtered.filter(o => 
                o.id.toString().includes(searchQuery) || 
                (o.phone_tail && o.phone_tail.toString().includes(searchQuery))
            );
        }

        // ç¯©é¸
        if (currentFilter !== 'all') {
            switch (currentFilter) {
                case 'pending': filtered = filtered.filter(o => o.status === 'pending'); break;
                case 'confirmed': filtered = filtered.filter(o => o.status === 'confirmed'); break;
                case 'preparing': filtered = filtered.filter(o => o.status === 'preparing'); break;
                case 'uncollected': filtered = filtered.filter(o => ['completed', 'arrived'].includes(o.status)); break;
                case 'cancelled': filtered = filtered.filter(o => o.status === 'cancelled'); break;
                case 'final': filtered = filtered.filter(o => o.status === 'final'); break;
            }
        }

        // æ’åº
        filtered.sort((a, b) => {
            const isAClosed = ['final', 'cancelled'].includes(a.status);
            const isBClosed = ['final', 'cancelled'].includes(b.status);
            if (isAClosed && !isBClosed) return 1;
            if (!isAClosed && isBClosed) return -1;
            return b.id - a.id;
        });

        // åˆ†é 
        const totalItems = filtered.length;
        const totalPages = Math.ceil(totalItems / itemsPerPage) || 1;
        if (currentPage > totalPages) currentPage = 1;
        const startIndex = (currentPage - 1) * itemsPerPage;
        const pageItems = filtered.slice(startIndex, startIndex + itemsPerPage);

        const list = document.getElementById('orderList');
        if (pageItems.length === 0) {
            list.innerHTML = `<div class="text-center mt-5 text-muted"><h4>ğŸ“­</h4><p>æ­¤åˆ†é¡ä¸‹æ²’æœ‰è¨‚å–®</p></div>`;
            updatePaginationUI(0, 0);
            return;
        }

        // è¨˜æ†¶å±•é–‹ç‹€æ…‹
        const openedIds = [];
        document.querySelectorAll('.detail-content:not(.hide-detail)').forEach(el => {
            openedIds.push(parseInt(el.id.replace('detail-', '')));
        });

        let html = '';
        pageItems.forEach(order => {
            let shouldExpand = false;
            // é è¨­å…¨é–‹çš„åˆ†é 
            const autoExpandFilters = ['pending', 'confirmed', 'preparing', 'uncollected'];
            if (autoExpandFilters.includes(currentFilter)) {
                shouldExpand = true;
            } else if (currentFilter === 'all' || searchQuery !== '') {
                 // åœ¨å…¨éƒ¨æˆ–æœå°‹æ™‚ï¼Œåªå±•é–‹é€²è¡Œä¸­
                 const activeStatuses = ['pending', 'confirmed', 'preparing', 'completed', 'arrived'];
                 if (activeStatuses.includes(order.status)) shouldExpand = true;
            }
            if (openedIds.includes(order.id)) shouldExpand = true;

            let detailClass = shouldExpand ? 'detail-content' : 'detail-content hide-detail';
            let arrowRotate = shouldExpand ? 'style="transform: rotate(180deg)"' : '';
            
            const isLinePay = order.payment_method === 'linepay';
            const payTag = isLinePay ? `<span class="pay-tag-line">LINE</span>` : `<span class="pay-tag-cash">CASH</span>`;
            const statusTagClass = { 
                pending: 'tag-pending', confirmed: 'tag-confirmed', preparing: 'tag-preparing', 
                completed: 'tag-completed', arrived: 'tag-arrived', final: 'tag-final', cancelled: 'tag-cancelled' 
            }[order.status];

            let actionBtn = getActionBtnHtml(order);

            html += `
                <div class="card order-card status-${order.status}" id="card-${order.id}">
                    <div class="card-header-clickable" onclick="toggleDetail(${order.id})">
                        <div class="order-head-left">
                            <span class="order-pill pill-phone">${order.phone_tail || 'ç¾å ´'}</span>
                            <span class="order-pill pill-id">#${order.id}</span>
                            ${payTag}
                            <span class="status-tag ${statusTagClass}">
                                ${getStatusText(order.status)}${order.status === 'arrived' ? ' ğŸš¨' : ''}
                            </span>
                        </div>
                        <div class="order-head-right">
                            <span class="arrow" id="arrow-${order.id}" ${arrowRotate}>â–¼</span>
                        </div>
                    </div>
                    <div id="detail-${order.id}" class="${detailClass}">
                        <div class="mb-3">
                            ${(order.items || []).map(i => `<span class="item-badge">${i.name} x ${i.quantity || i.qty}</span>`).join('')}
                        </div>
                        <div class="time-box mb-3">
                            <div>ğŸ•’ ä¸‹å–®ï¼š${new Date(order.created_at).toLocaleTimeString()}</div>
                            <div class="mt-2 fw-bold text-danger fs-5">ç¸½é¡ï¼š$${order.total}</div>
                        </div>
                        <div id="btn-zone-${order.id}">
                            ${actionBtn}
                        </div>
                    </div>
                </div>
            `;
        });
        list.innerHTML = html;
        updatePaginationUI(totalPages, totalItems);
    }

    // ==========================================
    // 4. è¼”åŠ©å‡½å¼ï¼šç”¢ç”ŸæŒ‰éˆ• (ä¿æŒä¹¾æ·¨)
    // ==========================================
    function fetchAllProducts() {
        if(!currentStore) return;
        // å‡è¨­æ‚¨çš„ API æ˜¯é€™å€‹è·¯å¾‘
        fetch(`/api/products/?store=${currentStore}`)
            .then(res => res.json())
            .then(data => {
                allProducts = data;
            });
    }
    
    // å¦‚æœåˆ‡æ›åˆ†åº—ï¼Œä¹Ÿè¦é‡æŠ“å•†å“
    function switchStore() {
        // ... åŸæœ¬çš„é‚è¼¯ ...
        currentStore = document.getElementById('storeSelector').value;
        fetchAllProducts(); // åŠ é€™è¡Œ
        // ...
    }

    // ==========================================
    // å–å¾—æ“ä½œæŒ‰éˆ• HTML (å«ä¿®æ”¹è¨‚å–®åŠŸèƒ½)
    // ==========================================
    let editingItemsMap = {}; 

    // 2. æ‰“é–‹ä¿®æ”¹è¦–çª—
    function openEditModal(orderId) {
        if (allProducts.length === 0) {
            Swal.fire('è¼‰å…¥ä¸­', 'å•†å“è³‡æ–™å°šæœªè¼‰å…¥ï¼Œè«‹ç¨å¾Œå†è©¦', 'info');
            fetchAllProducts();
            return;
        }

        const order = rawOrdersCache.find(o => o.id === orderId);
        if (!order) return;

        currentEditingOrderId = orderId;
        document.getElementById('editOrderIdDisplay').innerText = orderId;
        
        // åˆå§‹åŒ–æ•¸é‡ Map
        editingItemsMap = {};
        allProducts.forEach(p => editingItemsMap[p.id] = 0); 
        
        if (order.items && Array.isArray(order.items)) {
            order.items.forEach(item => {
                if (item.id) {
                    editingItemsMap[item.id] = item.quantity || item.qty || 0;
                }
            });
        }

        // å»ºæ§‹æ‰‹é¢¨ç´ HTML çµæ§‹ (åªåœ¨æ‰“é–‹æ™‚åšä¸€æ¬¡)
        buildEditAccordion();
        
        // æ›´æ–°æ‰€æœ‰æ•¸å­—èˆ‡æ¨£å¼
        refreshEditUI();

        const modal = new bootstrap.Modal(document.getElementById('editOrderModal'));
        modal.show();
    }

    // 2. å»ºæ§‹ HTML çµæ§‹ (å«åˆ†é¡é‚è¼¯)
    function buildEditAccordion() {
        const container = document.getElementById('editProductList');
        if (!container) return;

        // --- A. è³‡æ–™åˆ†çµ„é‚è¼¯ ---
        const groups = {};
        allProducts.forEach(p => {
            // è‹¥å¾Œç«¯ API æ²’å›å‚³ category_nameï¼Œå°±ç”¨ slug ä»£æ›¿
            const catSlug = p.category || 'other';
            if (!groups[catSlug]) {
                groups[catSlug] = {
                    slug: catSlug,
                    name: p.category_name || catSlug, 
                    order: p.category_sort_order !== undefined ? p.category_sort_order : 999,
                    products: []
                };
            }
            groups[catSlug].products.push(p);
        });

        // æ’åºåˆ†é¡
        const sortedCategories = Object.values(groups).sort((a, b) => a.order - b.order);

        // --- B. ç”¢ç”Ÿ HTML ---
        let html = `<div class="accordion accordion-flush" id="editAccordionParent">`;

        sortedCategories.forEach((cat, index) => {
            const isFirst = index === 0; // åˆ¤æ–·æ˜¯å¦ç‚ºç¬¬ä¸€å€‹
            const collapseId = `edit_collapse_${cat.slug}`;
            const headerId = `edit_heading_${cat.slug}`;
            
            // æ±ºå®šåˆ†é¡é¡è‰² Class
            let colorClass = `cat-${cat.slug}`; 
            
            html += `
            <div class="accordion-item border-0 mb-2">
                <h2 class="accordion-header" id="${headerId}">
                    <button class="accordion-button ${colorClass} ${isFirst ? '' : 'collapsed'} p-3 rounded" 
                            type="button" 
                            data-bs-toggle="collapse" 
                            data-bs-target="#${collapseId}" 
                            aria-expanded="${isFirst ? 'true' : 'false'}">
                        ${cat.name}
                    </button>
                </h2>
                <div id="${collapseId}" class="accordion-collapse collapse ${isFirst ? 'show' : ''}" 
                    data-bs-parent="#editAccordionParent">
                    <div class="accordion-body p-0 ps-2">
                        ${cat.products.map(p => `
                            <div id="edit-row-${p.id}" class="edit-item-row list-group-item d-flex justify-content-between align-items-center py-2 ps-3 pe-2">
                                <div class="d-flex align-items-center">
                                    <div>
                                        <div class="fw-bold text-dark">${p.name}</div>
                                        <small class="text-muted">$${p.price}</small>
                                    </div>
                                </div>
                                <div class="qty-controls d-flex align-items-center bg-light rounded-pill border px-1">
                                    <button class="btn btn-sm text-danger fw-bold fs-5 px-2" onclick="adjustEditQty(${p.id}, -1)">-</button>
                                    <span id="edit-qty-${p.id}" class="mx-2 fw-bold fs-5 text-dark" style="min-width: 24px; text-align: center;">0</span>
                                    <button class="btn btn-sm text-success fw-bold fs-5 px-2" onclick="adjustEditQty(${p.id}, 1)">+</button>
                                </div>
                            </div>
                        `).join('')}
                        </div>
                </div>
            </div>`;
        });

        html += `</div>`;
        container.innerHTML = html;
    }

    // 3. æ¸²æŸ“ä¿®æ”¹åˆ—è¡¨ (åŒ…å« +- æŒ‰éˆ•)
    function renderEditList() {
        const container = document.getElementById('editProductList');
        if (!container) return;
        
        let html = '';
        let total = 0;

        allProducts.forEach(p => {
            const qty = editingItemsMap[p.id] || 0;
            const subtotal = qty * p.price;
            total += subtotal;

            // æœ‰é¸è³¼çš„å•†å“çµ¦äºˆé«˜äº®èƒŒæ™¯
            const activeClass = qty > 0 ? 'bg-warning bg-opacity-10' : '';
            const borderClass = qty > 0 ? 'border-warning' : '';

            html += `
                <div class="list-group-item d-flex justify-content-between align-items-center py-3 ${activeClass} ${borderClass}">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <h6 class="mb-0 fw-bold">${p.name}</h6>
                            <small class="text-muted">$${p.price}</small>
                        </div>
                    </div>
                    <div class="qty-controls d-flex align-items-center bg-white rounded-pill border px-1">
                        <button class="btn btn-sm text-danger fw-bold fs-5" onclick="adjustEditQty(${p.id}, -1)">-</button>
                        <span class="mx-3 fw-bold fs-5" style="min-width: 24px; text-align: center;">${qty}</span>
                        <button class="btn btn-sm text-success fw-bold fs-5" onclick="adjustEditQty(${p.id}, 1)">+</button>
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;
        document.getElementById('editTotalAmount').innerText = '$' + total;
    }

    function getActionBtnHtml(order) {
        const isLinePay = order.payment_method === 'linepay';
        
        // --- 1. å¾…ä»˜æ¬¾ (Pending) ---
        if (order.status === 'pending') {
            let html = '';

            if (isLinePay) {
                // LinePayï¼šé€šå¸¸ä¸å»ºè­°å¾Œå°éš¨æ„æ”¹é‡‘é¡ï¼Œå› ç‚ºç‰½æ¶‰åˆ°ç¬¬ä¸‰æ–¹é‡‘æµæˆæ¬Š
                html += `<div class="alert alert-warning text-center fw-bold mb-2 py-2 small">â³ ç­‰å¾…é¡§å®¢ä»˜æ¬¾ä¸­...</div>`;
            } else {
                // ç¾å ´ç¾é‡‘ï¼šé¡¯ç¤ºã€Œå·²æ”¶éŒ¢ã€èˆ‡ã€Œä¿®æ”¹ã€ä¸¦æ’
                html += `
                <div class="d-flex gap-2 mb-2">
                    <button onclick="updateStatus(${order.id}, 'confirmed')" class="btn btn-primary btn-action shadow flex-grow-1">ğŸ’° å·²æ”¶éŒ¢</button>
                    <button onclick="openEditModal(${order.id})" class="btn btn-outline-dark btn-action shadow flex-grow-1" style="border: 2px solid #333; font-weight: bold;">âœï¸ ä¿®æ”¹</button>
                </div>`;
            }
            
            // å–æ¶ˆæŒ‰éˆ• (LinePay æœƒè§¸ç™¼é€€æ¬¾ï¼Œç¾é‡‘å‰‡ç›´æ¥å–æ¶ˆ)
            html += `<button onclick="cancelOrder(${order.id})" class="btn btn-link btn-sm text-muted w-100 mt-1">å–æ¶ˆè¨‚å–®</button>`;
            return html;
        } 
        
        // --- 2. å·²ä»˜æ¬¾ (Confirmed) ---
        else if (order.status === 'confirmed') {
            return `<button onclick="updateStatus(${order.id}, 'preparing')" class="btn btn-warning btn-action shadow">ğŸ“ é–‹å§‹è£½ä½œ</button>
                    <button onclick="cancelOrder(${order.id})" class="btn btn-link btn-sm text-muted w-100 mt-1">å–æ¶ˆè¨‚å–®</button>`;
        } 
        
        // --- 3. è£½ä½œä¸­ (Preparing) ---
        else if (order.status === 'preparing') {
            return `<button onclick="updateStatus(${order.id}, 'completed', true)" class="btn btn-success btn-action shadow">ğŸ”” è£½ä½œå®Œæˆï¼šç™¼é€é€šçŸ¥</button>
                    <button onclick="cancelOrder(${order.id})" class="btn btn-link btn-sm text-muted w-100 mt-1">å–æ¶ˆè¨‚å–®</button>`;
        } 
        
        // --- 4. é€šçŸ¥ä¸­/æœªå–é¤ (Completed) ---
        else if (order.status === 'completed') {
            return `<div class="alert alert-info text-center mb-2 py-2 fw-bold small">âŒ› å·²é€šçŸ¥ï¼Œç­‰å€™å–é¤ä¸­...</div>
                    <button onclick="confirmAction(${order.id}, 'final', 'ç¢ºèªäº¤ä»˜é¤é»ä¸¦çµæ¡ˆï¼Ÿ')" class="btn btn-danger btn-action shadow">âœ¨ äº¤ä»˜çµæ¡ˆ</button>`;
        } 
        
        // --- 5. å®¢äººå·²åˆ°æ«ƒ (Arrived) ---
        else if (order.status === 'arrived') {
            return `<button onclick="confirmAction(${order.id}, 'final', 'ç¢ºèªäº¤ä»˜çµæ¡ˆï¼Ÿ')" class="btn btn-danger btn-action animate__animated animate__pulse animate__infinite shadow-lg">ğŸš¨ å®¢äººå·²æŠµé”ï¼é»æ­¤çµæ¡ˆ</button>`;
        } 
        
        // --- 6. å·²å–æ¶ˆ (Cancelled) ---
        else if (order.status === 'cancelled') {
            return `<div class="text-center py-2 text-danger fw-bold">ğŸ˜¨ è¨‚å–®å·²å–æ¶ˆ</div>`;
        } 
        
        // --- 7. å·²å®Œæˆ (Final / Archived) ---
        else if (order.status === 'final' || order.status === 'archived') {
            return `<div class="text-center py-2 text-muted fw-bold">ğŸ¥° äº¤æ˜“å·²å®Œæˆ</div>`;
        }

        return '';
    }

    // --- æ–°å¢ï¼šèª¿æ•´æ•¸é‡ ---
    function adjustEditQty(pid, delta) {
        if (!editingItemsMap[pid]) editingItemsMap[pid] = 0;
        editingItemsMap[pid] += delta;
        if (editingItemsMap[pid] < 0) editingItemsMap[pid] = 0;
        
        refreshEditUI(); 
    }

    function refreshEditUI() {
        let total = 0;

        allProducts.forEach(p => {
            const qty = editingItemsMap[p.id] || 0;
            const subtotal = qty * p.price;
            total += subtotal;

            // æ›´æ–°æ•¸å­—é¡¯ç¤º
            const qtyEl = document.getElementById(`edit-qty-${p.id}`);
            if (qtyEl) qtyEl.innerText = qty;

            // æ›´æ–°é¸ä¸­æ¨£å¼ (é»ƒè‰²èƒŒæ™¯)
            const rowEl = document.getElementById(`edit-row-${p.id}`);
            if (rowEl) {
                if (qty > 0) {
                    rowEl.classList.add('bg-warning', 'bg-opacity-10', 'border-warning');
                } else {
                    rowEl.classList.remove('bg-warning', 'bg-opacity-10', 'border-warning');
                }
            }
        });

        document.getElementById('editTotalAmount').innerText = '$' + total;
    }

    // --- æ–°å¢ï¼šå„²å­˜ä¿®æ”¹ ---
    function saveOrderChange() {
        if (!currentEditingOrderId) return;

        // 1. çµ„è£ items è³‡æ–™
        const newItems = [];
        for (const [pid, qty] of Object.entries(editingItemsMap)) {
            if (qty > 0) {
                newItems.push({ id: parseInt(pid), quantity: qty });
            }
        }

        if (newItems.length === 0) {
            return Swal.fire('éŒ¯èª¤', 'è¨‚å–®ä¸èƒ½æ˜¯ç©ºçš„', 'error');
        }

        // 2. ç™¼é€ API è«‹æ±‚
        fetch(`/api/orders/${currentEditingOrderId}/`, {
            method: 'PATCH',
            headers: { 
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ items: newItems }) // åªé€å‡º itemsï¼Œå¾Œç«¯æœƒé‡ç®— total
        })
        .then(res => {
            if (res.ok) return res.json();
            return res.json().then(err => { throw new Error(err.error || 'ä¿®æ”¹å¤±æ•—') });
        })
        .then(data => {
            // 3. æˆåŠŸå¾Œé—œé–‰ Modal ä¸¦é‡æ–°è¼‰å…¥
            bootstrap.Modal.getInstance(document.getElementById('editOrderModal')).hide();
            Swal.fire('æˆåŠŸ', 'è¨‚å–®å·²ä¿®æ”¹', 'success');
            loadOrders();
        })
        .catch(err => {
            Swal.fire('å¤±æ•—', err.message, 'error');
        });
    }

    // ==========================================
    // 5. äº’å‹•æ§åˆ¶ (ç¯©é¸ã€åˆ†é ã€æœå°‹)
    // ==========================================
    function setFilter(filterType) {
        currentFilter = filterType;
        currentPage = 1; 
        
        // â˜…â˜…â˜… é—œéµä¿®æ­£ï¼šåˆ‡æ›åˆ†é¡æ™‚ï¼Œå¼·åˆ¶æ¸…ç©ºæœå°‹é—œéµå­— â˜…â˜…â˜…
        searchQuery = ''; // æ¸…ç©ºè¨˜æ†¶é«”ä¸­çš„é—œéµå­—
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.value = ''; // æ¸…ç©ºç•«é¢ä¸Šè¼¸å…¥æ¡†çš„å­—
        }
        // ------------------------------------------------

        // 1. é‡ç½®æŒ‰éˆ•äº®ç‡ˆç‹€æ…‹
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        
        // 2. é»äº®å°æ‡‰æŒ‰éˆ•
        const targetBtn = document.querySelector(`.filter-btn[onclick*="'${filterType}'"]`);
        if (targetBtn) {
            targetBtn.classList.add('active');
        }
        
        // 3. é‡æ–°æ¸²æŸ“
        renderOrders();
    }

    function handleSearch() {
        searchQuery = document.getElementById('searchInput').value.trim();
        currentPage = 1;
        renderOrders();
    }
    
    function clearSearch() {
        document.getElementById('searchInput').value = '';
        searchQuery = '';
        renderOrders();
    }

    function changePage(page) {
        currentPage = page;
        renderOrders();
        // æ›é å¾Œæ»‘å‹•åˆ°é ‚éƒ¨
        const listTop = document.getElementById('filterContainer').offsetTop;
        window.scrollTo({ top: listTop - 60, behavior: 'smooth' });
    }

    function updatePaginationUI(totalPages, totalItems) {
        const pagEl = document.getElementById('paginationControls');
        const infoEl = document.getElementById('pageInfo');
        if (!pagEl) return;

        infoEl.innerText = `å…± ${totalItems} ç­†è¨‚å–®ï¼Œç¬¬ ${currentPage} / ${totalPages} é `;

        if (totalPages <= 1) {
            pagEl.innerHTML = '';
            return;
        }

        let html = '';
        html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">ä¸Šä¸€é </a>
                 </li>`;
        
        for (let i = 1; i <= totalPages; i++) {
             // ç°¡å–®çš„åˆ†é é‚è¼¯ï¼šé¡¯ç¤º 1, æœ€å¾Œä¸€é , å’Œç•¶å‰é çš„å‰å¾Œ
             if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                 html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                          </li>`;
             } else if (i === currentPage - 2 || i === currentPage + 2) {
                 html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
             }
        }

        html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">ä¸‹ä¸€é </a>
                 </li>`;
        
        pagEl.innerHTML = html;
    }

    function changePage(page) {
        currentPage = page;
        renderOrders();
        
        // RWD å„ªåŒ–ï¼šæ²å‹•ä½ç½®è¨ˆç®—
        // å–å¾— sticky-controls çš„é«˜åº¦ï¼Œé¿å…æ“‹ä½å…§å®¹
        const stickyHeight = document.querySelector('.sticky-controls').offsetHeight;
        const navbarHeight = document.querySelector('.navbar').offsetHeight;
        const targetPosition = 0; // æˆ–è€…è¨­ç‚º navbarHeight è‹¥ä¸å®Œå…¨ç½®é ‚

        window.scrollTo({ 
            top: 0, 
            behavior: 'smooth' 
        });
    }

    // æ–°å¢ï¼šç‡Ÿæ¥­çµæŸæ­¸é›¶å‡½å¼
    // ==========================================
    function resetBusinessDay() {
        if (!currentStore) return Swal.fire('è«‹å…ˆé¸æ“‡åˆ†åº—');
        
        Swal.fire({
            title: 'ç¢ºå®šç‡Ÿæ¥­çµæŸï¼Ÿ',
            text: "é€™å°‡æœƒæŠŠä»Šæ—¥è¨‚å–®æµæ°´è™Ÿæ­¸é›¶ï¼Œä¸¦å°‡æ‰€æœ‰æœªçµæ¡ˆè¨‚å–®è½‰ç‚ºæ­·å²ç´€éŒ„ã€‚æ­¤æ“ä½œç„¡æ³•å¾©åŸï¼",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d63031',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'ç¢ºå®šæ­¸é›¶',
            cancelButtonText: 'å–æ¶ˆ'
        }).then((result) => {
            if (result.isConfirmed) {
                // å‘¼å«å¾Œç«¯ API é€²è¡Œé‡ç½® (å‡è¨­å¾Œç«¯æœ‰é–‹é€™å€‹ endpoint)
                // å¦‚æœå¾Œç«¯å°šæœªå¯¦ä½œï¼Œé€™æ®µ fetch æœƒå¤±æ•—ï¼Œè«‹ç¢ºä¿ Django æœ‰å°æ‡‰çš„ url
                fetch(`/api/stores/${currentStore}/reset_daily/`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken') 
                    }
                })
                .then(res => {
                    if (res.ok) return res.json();
                    throw new Error('Network response was not ok');
                })
                .then(data => {
                    Swal.fire('å·²æ­¸é›¶', 'ä»Šæ—¥ç‡Ÿæ¥­æ•¸æ“šå·²é‡ç½®ã€‚', 'success');
                    lastOrdersJson = ''; // å¼·åˆ¶é‡ç¹ª
                    loadOrders();        // é‡æ–°è¼‰å…¥
                })
                .catch(err => {
                    // å¦‚æœå¾Œç«¯é‚„æ²’åšå¥½ï¼Œå…ˆç”¨å‰ç«¯æ¨¡æ“¬æç¤º
                    console.error(err);
                    Swal.fire('ç³»çµ±æç¤º', 'è«‹ç¢ºèªå¾Œç«¯å·²å¯¦ä½œ /reset_daily/ æ¥å£', 'info');
                });
            }
        });
    }
</script>
</body>

</html>