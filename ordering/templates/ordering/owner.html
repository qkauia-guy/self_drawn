<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>ä¸€æŠŠè‘«ç®¡ç†å¾Œå° - å³æ™‚è¨‚å–®</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background-color: #f0f2f5; font-family: "Microsoft JhengHei", sans-serif; padding-bottom: 50px; }
        .navbar { background-color: #d63031 !important; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        #audio-unlocker {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(214, 48, 49, 0.95); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center; color: white;
        }

        .store-selector-nav { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 8px; padding: 2px 10px; font-weight: bold; }

        /* Navbar åœ“å½¢èªéŸ³æŒ‰éˆ• */
        .btn-voice-nav {
            width: 42px; height: 42px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; border: none;
            transition: all 0.3s ease;
            margin-right: 12px;
        }
        .voice-inactive { background-color: rgba(255, 255, 255, 0.9); color: #d63031; }
        .voice-active {
            background-color: #ff4757 !important; color: white !important;
            box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7);
            animation: pulse-voice-nav 1.5s infinite;
        }
        @keyframes pulse-voice-nav {
            0% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); }
            70% { box-shadow: 0 0 0 8px rgba(255, 71, 87, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); }
        }

        /* è¨‚å–®å¡ç‰‡ */
        .order-card { 
            border: none; border-radius: 12px; margin-bottom: 12px; 
            overflow: hidden; border-left: 8px solid #ccc;
            transition: all 0.2s ease; background: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .status-pending { border-left-color: #636e72; }
        .status-confirmed { border-left-color: #0984e3; }
        .status-preparing { border-left-color: #fdcb6e; }
        .status-completed { border-left-color: #00b894; }
        .status-arrived { border-left-color: #d63031; animation: pulse-red-border 1s infinite; }
        .status-final { border-left-color: #2ecc71; opacity: 0.6; }

        @keyframes pulse-red-border {
            0% { border-left-width: 8px; }
            50% { border-left-width: 15px; }
            100% { border-left-width: 8px; }
        }

        .card-header-clickable { padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .detail-content { padding: 15px; border-top: 1px solid #eee; display: block; }
        .hide-detail { display: none; }
        .btn-action { border-radius: 12px; padding: 15px; font-weight: bold; width: 100%; font-size: 1.2rem; margin-bottom: 8px; }
        .item-badge { background: #fff5f5; border: 1px solid #ffcccc; color: #d63031; padding: 6px 10px; border-radius: 8px; margin: 3px; display: inline-block; font-size: 1rem; font-weight: bold; }
        .time-box { font-size: 0.85rem; color: #7f8c8d; background: #f9f9f9; padding: 10px; border-radius: 8px; }
        
        /* ä¿®å¾©æŒ‰éˆ•è®Šç™½å•é¡Œ */
        .btn-final { background-color: #2d3436; color: white; border: none; }
        .btn-final:hover, .btn-final:active, .btn-final:focus { background-color: #000000 !important; color: white !important; }

        .qty-controls button { width: 40px; height: 40px; border-radius: 50%; font-weight: bold; }
        #voiceDebug { font-size: 0.85rem; min-height: 20px; color: #d63031; font-weight: bold; text-align: center; }
        
        /* ä»˜æ¬¾æ¨™ç±¤ */
        .pay-tag-cash { background-color: #ffcccc; color: #d63031; font-size: 0.8rem; padding: 4px 8px; border-radius: 6px; font-weight: bold; }
        .pay-tag-line { background-color: #06c755; color: white; font-size: 0.8rem; padding: 4px 8px; border-radius: 6px; font-weight: bold; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark sticky-top">
    <div class="container-fluid">
        <div class="d-flex align-items-center flex-grow-1">
            <span class="navbar-brand fw-bold me-2">ğŸ“ ç®¡ç†ç³»çµ±</span>
            <select id="storeSelector" class="store-selector-nav me-auto" onchange="switchStore()">
                <option value="dajin">å¤§æ´¥ç€‘å¸ƒ</option>
                <option value="neipu">å…§åŸ”å¹´è¡—</option>
            </select>
        </div>

        <!-- èªéŸ³æ§åˆ¶æŒ‰éˆ• (Navbar å…§) -->
        <button id="navVoiceBtn" class="btn btn-voice-nav voice-inactive shadow-sm" onclick="toggleVoiceControl()">
            ğŸ¤
        </button>

        <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasMenu">
            <span class="navbar-toggler-icon"></span>
        </button>
    </div>
</nav>

<!-- èªéŸ³ç‹€æ…‹é¡¯ç¤ºå€ -->
<div class="container mt-2">
    <div id="voiceDebug"></div>
    <div id="volumeContainer" class="progress mx-auto mt-1" style="width: 150px; height: 4px; background-color: #eee; border-radius: 5px; overflow: hidden; opacity: 0; transition: opacity 0.3s;">
        <div id="volumeBar" class="progress-bar bg-danger" style="width: 0%; transition: width 0.05s;"></div>
    </div>
</div>

<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasMenu">
    <div class="offcanvas-header bg-danger text-white">
        <h5 class="offcanvas-title fw-bold">åŠŸèƒ½é¸å–®</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
        <div class="list-group">
            <a href="javascript:void(0)" onclick="goToReport()" class="list-group-item list-group-item-action py-3 fw-bold text-danger">ğŸ“Š ç‡Ÿæ¥­å ±è¡¨çµ±è¨ˆ</a>
            <a href="/admin/" class="list-group-item list-group-item-action py-3">Django å¾Œå°ç®¡ç†</a>
            <a href="javascript:void(0)" onclick="openStatusBoard()" class="list-group-item list-group-item-action py-3 text-primary">ğŸ–¥ï¸ æ‰“é–‹å«è™Ÿçœ‹æ¿</a>
            <hr>
            <a href="/admin/logout/" class="list-group-item list-group-item-action py-3 text-muted small">å®‰å…¨ç™»å‡º</a>
        </div>
    </div>
</div>

<div id="audio-unlocker">
    <h2 class="mb-4">ğŸ“ ä¸€æŠŠè‘«ç®¡ç†ç³»çµ±</h2>
    <p class="mb-2">ç•¶å‰ç®¡ç†åº—é‹ªï¼š<span id="targetStoreName" class="fw-bold">å¤§æ´¥ç€‘å¸ƒ</span></p>
    <p class="mb-4">è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•å•Ÿå‹•ç³»çµ±</p>
    <button onclick="unlockAudio()" class="btn btn-light btn-lg fw-bold px-5 py-3 shadow">ğŸš€ å•Ÿå‹•ç³»çµ±</button>
</div>

<div class="container mt-3" id="orderList">
    <div class="text-center mt-5 text-muted">
        <div class="spinner-border text-danger mb-3" role="status"></div>
        <p>æ­£åœ¨åŒæ­¥è¨‚å–®è³‡æ–™...</p>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="editOrderModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 20px;">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold">ä¿®æ”¹è¨‚å–®å…§å®¹ #<span id="editOrderIdDisplay"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="editProductList" class="list-group list-group-flush"></div>
                <div class="mt-4 p-3 bg-light rounded-3 d-flex justify-content-between align-items-center">
                    <span class="fw-bold">ä¿®æ­£å¾Œç¸½é¡ï¼š</span>
                    <span class="fs-3 fw-bold text-danger" id="editTotalAmount">$0</span>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-danger rounded-pill px-4" onclick="saveOrderChange()">ç¢ºèªå„²å­˜ä¿®æ”¹</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- åŸºç¤è®Šæ•¸ ---
    let audioReady = false;
    let alertedArrived = new Set(); 
    let alertedNewOrder = new Set(JSON.parse(localStorage.getItem('alerted_new_orders') || '[]'));
    let notifyTimes = JSON.parse(localStorage.getItem('notify_times') || '{}');
    
    // æ”¹ç”¨ Base64 éŸ³æ•ˆï¼Œé¿å… 404
    let bellAudio = new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU'); 

    let isFirstLoad = true;
    let currentStore = localStorage.getItem('selected_store') || 'dajin';
    let allProducts = [], currentEditingOrderId = null, currentEditingItems = [];

    // --- èªéŸ³è®Šæ•¸ ---
    let audioContext = null;
    let micStream = null, micSource = null, analyserNode = null, rafId = null;
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition = null;
    let isVoiceControlling = false;
    let isSpeaking = false;
    let restartTimer = null;
    let lastFinalText = "", lastFinalAt = 0;

    // --- åˆå§‹åŒ–ä»‹é¢ ---
    document.getElementById('storeSelector').value = currentStore;
    updateStoreUI();

    // --- 1. ç³»çµ±å•Ÿå‹•èˆ‡ AudioContext ä¿®å¾© ---
    async function ensureAudioContextReady() {
        try {
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            if (audioContext.state === 'suspended') await audioContext.resume();
        } catch (e) {
            console.warn("é‡å»º AudioContext:", e);
            try { if(audioContext) await audioContext.close(); } catch(_){}
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            if (audioContext.state === 'suspended') await audioContext.resume();
        }
    }

    async function unlockAudio() {
        audioReady = true;
        const unlocker = document.getElementById('audio-unlocker');
        unlocker.classList.add('animate__animated', 'animate__fadeOut');
        setTimeout(() => { unlocker.style.display = 'none'; }, 500);

        await ensureAudioContextReady();
        
        // æ’­æ”¾ç„¡è²æ¸¬è©¦
        bellAudio.play().then(() => { bellAudio.pause(); bellAudio.currentTime = 0; }).catch(e => {});
        speak("ç³»çµ±å•Ÿå‹•", { muteRecognition: false });
        
        loadOrders();
        setInterval(loadOrders, 5000);
    }

    // --- 2. èªéŸ³æ§åˆ¶æ ¸å¿ƒé‚è¼¯ ---
    async function toggleVoiceControl() {
        if (!SpeechRecognition) return Swal.fire("ä¸æ”¯æ´", "è«‹ä½¿ç”¨ Chrome ç€è¦½å™¨", "error");

        if (!isVoiceControlling) {
            try {
                await startVoiceControl();
            } catch (err) {
                console.error(err);
                Swal.fire("éŒ¯èª¤", "ç„¡æ³•å•Ÿå‹•éº¥å…‹é¢¨ï¼Œè«‹æª¢æŸ¥æ¬Šé™", "error");
            }
        } else {
            stopVoiceControl();
        }
    }

    async function startVoiceControl() {
        await ensureAudioContextReady();
        micStream = await navigator.mediaDevices.getUserMedia({ 
            audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true } 
        });
        micSource = audioContext.createMediaStreamSource(micStream);
        analyserNode = audioContext.createAnalyser();
        analyserNode.fftSize = 512;
        micSource.connect(analyserNode);
        startVolumeMeter();
        initRecognition();
        recognition.start();
        isVoiceControlling = true;
        const btn = document.getElementById('navVoiceBtn');
        btn.classList.remove('voice-inactive');
        btn.classList.add('voice-active');
        btn.innerHTML = 'ğŸ›‘';
        document.getElementById('volumeContainer').style.opacity = '1';
        speak("èªéŸ³æ¨¡å¼å•Ÿå‹•", { muteRecognition: true });
    }

    function stopVoiceControl() {
        isVoiceControlling = false;
        isSpeaking = false;
        if (restartTimer) clearTimeout(restartTimer);
        if (recognition) { try{ recognition.onend = null; recognition.abort(); }catch(e){} recognition = null; }
        stopVolumeMeter();
        if (micStream) { micStream.getTracks().forEach(t => t.stop()); micStream = null; }
        const btn = document.getElementById('navVoiceBtn');
        btn.classList.remove('voice-active');
        btn.classList.add('voice-inactive');
        btn.innerHTML = 'ğŸ¤';
        document.getElementById('voiceDebug').innerText = "";
        document.getElementById('volumeContainer').style.opacity = '0';
        document.getElementById('volumeBar').style.width = "0%";
        speak("èªéŸ³é—œé–‰", { muteRecognition: false });
    }

    function startVolumeMeter() {
        const volBar = document.getElementById('volumeBar');
        const buffer = new Uint8Array(analyserNode.frequencyBinCount);
        const draw = () => {
            if (!isVoiceControlling) return;
            analyserNode.getByteFrequencyData(buffer);
            let sum = 0;
            for(let i=0; i<buffer.length; i++) sum += buffer[i];
            let avg = sum / buffer.length;
            volBar.style.width = Math.min(avg * 2.5, 100) + "%"; 
            rafId = requestAnimationFrame(draw);
        };
        draw();
    }

    function stopVolumeMeter() {
        if (rafId) cancelAnimationFrame(rafId);
        document.getElementById('volumeBar').style.width = "0%";
    }

    function initRecognition() {
        recognition = new SpeechRecognition();
        recognition.lang = 'zh-TW';
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.onresult = (event) => {
            let interim = "";
            for (let i = event.resultIndex; i < event.results.length; i++) {
                const transcript = event.results[i][0].transcript.trim();
                if (event.results[i].isFinal) {
                    processVoiceCommand(transcript);
                } else {
                    interim += transcript;
                }
            }
            if (interim) document.getElementById('voiceDebug').innerText = `ğŸ‘‚: ${interim}`;
        };
        recognition.onerror = (e) => {
            console.log("Voice error:", e.error);
            if(e.error === 'not-allowed') stopVoiceControl();
            else scheduleRestart(500);
        };
        recognition.onend = () => {
            if (isVoiceControlling && !isSpeaking) scheduleRestart(200);
        };
    }

    function scheduleRestart(ms) {
        if(restartTimer) clearTimeout(restartTimer);
        restartTimer = setTimeout(() => {
            if(isVoiceControlling && recognition) {
                try { recognition.start(); } catch(e){}
            }
        }, ms);
    }

    function processVoiceCommand(rawText) {
        if (rawText === lastFinalText && (Date.now() - lastFinalAt) < 1000) return;
        lastFinalText = rawText;
        lastFinalAt = Date.now();
        document.getElementById('voiceDebug').innerText = `âœ…: ${rawText}`;
        const text = rawText.replace(/\s/g, "");
        let orderId = null;
        const numMatch = text.match(/(\d+)/);
        if (numMatch) {
            orderId = parseInt(numMatch[1]);
        } else {
            const zhNum = text.match(/[é›¶ä¸€äºŒå…©ä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+/);
            if (zhNum) orderId = parseChineseNumber(zhNum[0]);
        }
        if (!orderId) return;
        if (text.includes("å®Œæˆ") || text.includes("å¥½äº†") || text.includes("é€šçŸ¥")) {
            speak(`${orderId}è™Ÿå®Œæˆ`);
            updateStatus(orderId, 'completed', true);
        } else if (text.includes("çµæ¡ˆ") || text.includes("äº¤ä»˜")) {
            speak(`${orderId}è™Ÿçµæ¡ˆ`);
            updateStatus(orderId, 'final');
        } else if (text.includes("æ”¶éŒ¢") || text.includes("æ”¶äº†") || text.includes("ç¢ºèª")) {
            speak(`${orderId}è™Ÿå·²æ”¶éŒ¢`);
            updateStatus(orderId, 'confirmed');
        } else if (text.includes("è£½ä½œ") || text.includes("åš")) {
            speak(`${orderId}è™Ÿè£½ä½œä¸­`);
            updateStatus(orderId, 'preparing');
        }
    }

    function parseChineseNumber(s) {
        const map = {'é›¶':0,'ä¸€':1,'äºŒ':2,'å…©':2,'ä¸‰':3,'å››':4,'äº”':5,'å…­':6,'ä¸ƒ':7,'å…«':8,'ä¹':9,'å':10};
        let val = 0;
        if (s.startsWith('å')) s = 'ä¸€' + s; 
        let parts = s.split('å');
        if (parts.length === 1) return map[parts[0]] || 0;
        if (parts.length === 2) {
            let ten = map[parts[0]] || 0;
            let unit = map[parts[1]] || 0;
            return ten * 10 + unit;
        }
        return 0;
    }

    function speak(text, { muteRecognition = true } = {}) {
        if (!audioReady) return;
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'zh-TW';
        if (muteRecognition && isVoiceControlling && recognition) {
            isSpeaking = true;
            try { recognition.abort(); } catch(e){} 
            u.onend = () => {
                isSpeaking = false;
                scheduleRestart(200);
            };
        }
        window.speechSynthesis.speak(u);
    }

    // --- å…¶é¤˜åŸæœ‰é‚è¼¯ ---
    function switchStore() {
        currentStore = document.getElementById('storeSelector').value;
        localStorage.setItem('selected_store', currentStore);
        updateStoreUI();
        isFirstLoad = true;
        alertedArrived.clear(); 
        loadOrders();
        speak("å·²åˆ‡æ›è‡³" + (currentStore === 'dajin' ? 'å¤§æ´¥ç€‘å¸ƒ' : 'å…§åŸ”å¹´è¡—'), {muteRecognition: false});
    }

    function updateStoreUI() {
        const name = currentStore === 'dajin' ? 'å¤§æ´¥ç€‘å¸ƒ' : 'å…§åŸ”å¹´è¡—';
        document.getElementById('targetStoreName').innerText = name;
    }

    function goToReport() { window.location.href = `/report-dashboard/?store=${currentStore}`; }
    function openStatusBoard() { window.open(`/status/${currentStore}/`, '_blank'); }
    function getCookie(n) { let v = document.cookie.match('(^|;) ?' + n + '=([^;]*)(;|$)'); return v ? decodeURIComponent(v[2]) : null; }

    function playBell() {
        if (audioReady) {
            bellAudio.currentTime = 0;
            bellAudio.play().catch(e => console.log("Audio Error:", e));
        }
    }

    function loadOrders() {
        fetch(`/api/orders/?store=${currentStore}&t=${new Date().getTime()}`)
        .then(res => (res.status === 401 || res.status === 403) ? (window.location.href = '/admin/login/?next=' + window.location.pathname) : res.json())
        .then(orders => {
            if (!orders || !Array.isArray(orders)) return;

            if (isFirstLoad) {
                orders.forEach(order => {
                    if (order.status === 'pending') alertedNewOrder.add(order.id);
                    if (order.status === 'arrived') alertedArrived.add(order.id);
                });
                isFirstLoad = false;
            }

            const list = document.getElementById('orderList');
            if (orders.length === 0) {
                list.innerHTML = `<div class="text-center mt-5 text-muted"><p>ç›®å‰æ²’æœ‰è¨‚å–®</p></div>`;
                return;
            }

            let newHtml = '';
            orders.sort((a, b) => {
                const isAClosed = (a.status === 'final' || a.status === 'cancelled');
                const isBClosed = (b.status === 'final' || b.status === 'cancelled');
                if (isAClosed && !isBClosed) return 1;
                if (!isAClosed && isBClosed) return -1;
                return b.id - a.id;
            }).forEach(order => {
                if (order.status === 'pending' && !alertedNewOrder.has(order.id)) {
                    speak("æ–°è¨‚å–®ï¼Œç·¨è™Ÿ " + order.id, {muteRecognition: true});
                    alertedNewOrder.add(order.id);
                    localStorage.setItem('alerted_new_orders', JSON.stringify(Array.from(alertedNewOrder).slice(-100)));
                }
                if (order.status === 'arrived' && !alertedArrived.has(order.id)) {
                    playBell(); 
                    speak("ç·¨è™Ÿ " + order.id + " å®¢äººå·²åˆ°æ«ƒæª¯", {muteRecognition: true});
                    alertedArrived.add(order.id);
                }

                const isContracted = (order.status === 'final' || order.status === 'cancelled');
                const detailClass = isContracted ? 'detail-content hide-detail' : 'detail-content';
                const arrowRotate = isContracted ? '' : 'style="transform: rotate(180deg)"';
                const editBtn = !isContracted ? `<button onclick="openEditModal(${order.id})" class="btn btn-outline-secondary w-100 mb-2 py-2 fw-bold" style="border-radius:12px; font-size:0.9rem;">âœï¸ ä¿®æ”¹å“é … / åº«å­˜</button>` : '';

                // ä»˜æ¬¾æ¨™ç±¤é‚è¼¯
                const isLinePay = order.payment_method === 'linepay';
                const payTag = isLinePay 
                    ? `<span class="pay-tag-line">ğŸ“± LINE Pay</span>` 
                    : `<span class="pay-tag-cash">ğŸ’µ ç¾é‡‘</span>`;

                let actionBtn = '';
                if (order.status === 'pending') {
                    // å¦‚æœæ˜¯ç¾é‡‘å–®ï¼Œæˆ– LINE Pay å¡åœ¨ pending (å¯èƒ½æ²’ä»˜æˆåŠŸ)ï¼Œéƒ½çµ¦æŒ‰éˆ•
                    const btnText = isLinePay ? "âš ï¸ å¼·åˆ¶ç¢ºèª (å®¢äººèªªå·²ä»˜)" : "ğŸ’° å·²æ”¶éŒ¢ï¼šæˆç«‹è¨‚å–®";
                    actionBtn = `<button onclick="updateStatus(${order.id}, 'confirmed')" class="btn btn-primary btn-action shadow">${btnText}</button>
                                 <button onclick="confirmAction(${order.id}, 'cancelled', 'ç¢ºå®šè¦ã€Œå–æ¶ˆã€é€™ç­†è¨‚å–®å—ï¼Ÿ')" class="btn btn-link btn-sm text-muted w-100 mt-2">å–æ¶ˆè¨‚å–®</button>`;
                } else if (order.status === 'confirmed') {
                    // [ä¿®å¾©] é€™è£¡è£œå›äº†å–æ¶ˆæŒ‰éˆ•
                    actionBtn = `<button onclick="updateStatus(${order.id}, 'preparing')" class="btn btn-warning btn-action shadow">ğŸ“ é–‹å§‹è£½ä½œé¤é»</button>
                                 <button onclick="confirmAction(${order.id}, 'cancelled', 'ç¢ºå®šè¦ã€Œå–æ¶ˆã€é€™ç­†è¨‚å–®å—ï¼Ÿ')" class="btn btn-link btn-sm text-muted w-100 mt-2">å–æ¶ˆè¨‚å–®</button>`;
                } else if (order.status === 'preparing') {
                    actionBtn = `<button onclick="updateStatus(${order.id}, 'completed', true)" class="btn btn-success btn-action shadow">ğŸ”” è£½ä½œå®Œæˆï¼šç™¼é€å–é¤é€šçŸ¥</button>`;
                } else if (order.status === 'completed') {
                    actionBtn = `<div class="alert alert-info text-center mb-2 py-2 fw-bold small">âŒ› ç­‰å€™å®¢äººç«¯ç¢ºèªä¸­...</div>
                                 <button onclick="confirmAction(${order.id}, 'final', 'ç¢ºå®šå®¢äººå·²é ˜é¤ï¼Œè¦æ‰‹å‹•å®Œæˆçµæ¡ˆå—ï¼Ÿ')" class="btn btn-final btn-action shadow text-white">âœ… æ‰‹å‹•å®Œæˆäº¤æ˜“(çµæ¡ˆ)</button>`;
                } else if (order.status === 'arrived') {
                    actionBtn = `<button onclick="confirmAction(${order.id}, 'final', 'å®¢äººå·²åœ¨ç¾å ´ï¼Œç¢ºèªäº¤ä»˜é¤é»ä¸¦çµæ¡ˆï¼Ÿ')" class="btn btn-danger btn-action animate__animated animate__pulse animate__infinite shadow-lg">âœ¨ å®¢äººå·²æŠµé”ï¼é»æ­¤äº¤ä»˜çµæ¡ˆ</button>`;
                } else if (order.status === 'cancelled') {
                    actionBtn = `<div class="text-center py-2 text-danger fw-bold">âŒ è¨‚å–®å·²å–æ¶ˆ</div>`;
                } else if (order.status === 'final') {
                    actionBtn = `<div class="text-center py-2 text-success fw-bold">âœ… äº¤æ˜“å·²å®Œæˆ</div>`;
                }

                newHtml += `
                    <div class="card order-card status-${order.status}" id="card-${order.id}">
                        <div class="card-header-clickable" onclick="toggleDetail(${order.id})">
                            <div class="fw-bold h5 mb-0 d-flex align-items-center">
                                <span class="badge bg-light text-dark me-2 border">#${order.id}</span>
                                ${payTag}
                                ${order.status === 'arrived' ? '<span class="ms-2">ğŸš¨</span>' : ''}
                            </div>
                            <div class="d-flex align-items-center">
                                <span class="badge ${isContracted ? 'bg-secondary' : 'bg-danger'} me-2">${order.phone_tail || 'ç¾å ´'}</span>
                                <span class="text-muted small me-2">${getStatusText(order.status)}</span>
                                <span class="text-muted" id="arrow-${order.id}" ${arrowRotate}>â–¼</span>
                            </div>
                        </div>
                        <div id="detail-${order.id}" class="${detailClass}">
                            <div class="mb-3">${order.items.map(i => `<span class="item-badge">${i.name} x ${i.qty || i.quantity}</span>`).join('')}</div>
                            <div class="time-box mb-3">
                                <div>ğŸ•’ ä¸‹å–®ï¼š${new Date(order.created_at).toLocaleTimeString()}</div>
                                ${notifyTimes[order.id] ? `<div>ğŸ”” å–é¤é€šçŸ¥ï¼š${notifyTimes[order.id]}</div>` : ''}
                                <div class="mt-2 fw-bold text-danger fs-5">ç¸½é¡ï¼š$${order.total}</div>
                            </div>
                            <div id="btn-zone-${order.id}">
                                ${editBtn}
                                ${actionBtn}
                            </div>
                        </div>
                    </div>`;
            });
            list.innerHTML = newHtml;
        });
    }

    function openEditModal(orderId) {
        currentEditingOrderId = orderId;
        document.getElementById('editOrderIdDisplay').innerText = orderId;
        Promise.all([
            fetch(`/api/products/?store=${currentStore}&t=${Date.now()}`).then(res => res.json()),
            fetch(`/api/orders/${orderId}/`).then(res => res.json())
        ]).then(([prods, order]) => {
            allProducts = prods;
            currentEditingItems = order.items.map(i => ({...i, quantity: i.quantity || i.qty}));
            currentEditingItems.forEach(item => {
                const p = allProducts.find(prod => prod.id == item.id);
                if (p) p.stock += item.quantity;
            });
            renderEditProductList();
            new bootstrap.Modal(document.getElementById('editOrderModal')).show();
        });
    }

    function renderEditProductList() {
        const container = document.getElementById('editProductList');
        let html = ''; let total = 0;
        allProducts.forEach(p => {
            const item = currentEditingItems.find(i => i.id == p.id);
            const qty = item ? item.quantity : 0;
            total += qty * p.price;
            html += `
                <div class="list-group-item d-flex justify-content-between align-items-center py-3 border-bottom">
                    <div>
                        <div class="fw-bold">${p.name} <span class="text-muted small">($${p.price})</span></div>
                        <div class="small text-danger">å‰©é¤˜åº«å­˜: ${p.stock}</div>
                    </div>
                    <div class="d-flex align-items-center qty-controls">
                        <button class="btn btn-outline-secondary btn-sm" onclick="changeEditQty(${p.id}, -1)" ${qty === 0 ? 'disabled' : ''}>-</button>
                        <span class="fw-bold mx-3 fs-5">${qty}</span>
                        <button class="btn btn-outline-danger btn-sm" onclick="changeEditQty(${p.id}, 1)" ${p.stock <= 0 ? 'disabled' : ''}>+</button>
                    </div>
                </div>`;
        });
        container.innerHTML = html;
        document.getElementById('editTotalAmount').innerText = `$${total}`;
    }

    function changeEditQty(pId, delta) {
        const prod = allProducts.find(p => p.id == pId);
        let item = currentEditingItems.find(i => i.id == pId);
        if (delta > 0 && prod.stock > 0) {
            if (!item) { item = { id: prod.id, name: prod.name, quantity: 0, price: prod.price }; currentEditingItems.push(item); }
            item.quantity++; prod.stock--;
        } else if (delta < 0 && item && item.quantity > 0) {
            item.quantity--; prod.stock++;
            if (item.quantity === 0) currentEditingItems = currentEditingItems.filter(i => i.id != pId);
        }
        renderEditProductList();
    }

    function saveOrderChange() {
        const total = currentEditingItems.reduce((sum, i) => sum + (i.quantity * i.price), 0);
        fetch(`/api/orders/${currentEditingOrderId}/`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
            body: JSON.stringify({ items: currentEditingItems, total: total })
        }).then(res => {
            if (res.ok) {
                bootstrap.Modal.getInstance(document.getElementById('editOrderModal')).hide();
                loadOrders();
                Swal.fire({ icon: 'success', title: 'ä¿®æ”¹æˆåŠŸ', timer: 1000, showConfirmButton: false });
            }
        });
    }

    function getStatusText(s) {
        const map = { 'pending': 'ç­‰å¾…ä»˜éŒ¢', 'confirmed': 'å·²æ”¶éŒ¢/å·²ä»˜æ¬¾', 'preparing': 'è£½ä½œä¸­', 'completed': 'é€šçŸ¥å–é¤ä¸­', 'arrived': 'å®¢äººåˆ°æ«ƒæª¯', 'final': 'å·²å®Œæˆ', 'cancelled': 'å·²å–æ¶ˆ' };
        return map[s] || s;
    }

    function confirmAction(id, newStatus, message) { if (confirm(message)) updateStatus(id, newStatus); }

    function updateStatus(id, newStatus, isNotifying = false) {
        if (isNotifying) {
            const now = new Date();
            notifyTimes[id] = now.getHours() + ":" + now.getMinutes().toString().padStart(2, '0');
            localStorage.setItem('notify_times', JSON.stringify(notifyTimes));
        }
        fetch(`/api/orders/${id}/`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
            body: JSON.stringify({ status: newStatus })
        }).then(res => res.ok ? loadOrders() : alert("æ›´æ–°å¤±æ•—"));
    }

    function toggleDetail(id) {
        const detail = document.getElementById(`detail-${id}`);
        const arrow = document.getElementById(`arrow-${id}`);
        if (detail && arrow) {
            const isHidden = detail.classList.toggle('hide-detail');
            arrow.style.transform = isHidden ? 'rotate(0deg)' : 'rotate(180deg)';
        }
    }
</script>
</body>
</html>
