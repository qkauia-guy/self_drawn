<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>ä¸€æŠŠè‘«ç®¡ç†å¾Œå° - å³æ™‚è¨‚å–®</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body { background-color: #f0f2f5; font-family: "Microsoft JhengHei", sans-serif; padding-bottom: 50px; }
    .navbar { background-color: #d63031 !important; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }

    #audio-unlocker{
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(214, 48, 49, 0.95); z-index: 9999;
      display: flex; flex-direction: column; align-items: center; justify-content: center; color: white;
    }

    .store-selector-nav{
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.3);
      color: white; border-radius: 8px; padding: 2px 10px; font-weight: bold;
    }

    .btn-voice-nav{
      width: 42px; height: 42px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.2rem; border: none;
      transition: all 0.3s ease;
      margin-right: 12px;
    }
    .voice-inactive{ background-color: rgba(255, 255, 255, 0.9); color: #d63031; }
    .voice-active{
      background-color: #ff4757 !important; color: white !important;
      box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7);
      animation: pulse-voice-nav 1.5s infinite;
    }
    @keyframes pulse-voice-nav{
      0% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); }
      70% { box-shadow: 0 0 0 8px rgba(255, 71, 87, 0); }
      100% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); }
    }

    .order-card{
      border: none; border-radius: 12px; margin-bottom: 12px;
      overflow: hidden; border-left: 8px solid #ccc;
      transition: transform 0.12s ease, box-shadow 0.12s ease;
      background: white;
      box-shadow: 0 4px 10px rgba(0,0,0,0.06);
    }
    .order-card:hover{ transform: translateY(-1px); box-shadow: 0 6px 14px rgba(0,0,0,0.08); }

    .status-pending{ border-left-color: #636e72; }
    .status-confirmed{ border-left-color: #0984e3; }
    .status-preparing{ border-left-color: #fdcb6e; }
    .status-completed{ border-left-color: #00b894; }
    .status-arrived{ border-left-color: #d63031; animation: pulse-red-border 1s infinite; }
    .status-final{ border-left-color: #2ecc71; opacity: 0.65; }
    .status-cancelled{ border-left-color: #b2bec3; opacity: 0.65; }

    @keyframes pulse-red-border{
      0% { border-left-width: 8px; }
      50% { border-left-width: 14px; }
      100% { border-left-width: 8px; }
    }

    .card-header-clickable{
      padding: 14px 14px;
      cursor: pointer;
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 10px;
      user-select: none;
    }

    .order-head-left{
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 0;
      flex-wrap: nowrap;
      width: 100%;
    }

    @media (min-width: 992px){
      .order-head-left > *{
        flex: 1 1 0;
        display: inline-flex;
        justify-content: center;
        min-width: 0;
      }
    }
    @media (max-width: 991.98px){
      .order-head-left > *{
        flex: 0 0 auto;
      }
    }

    .order-pill{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 32px;
      padding: 0 10px;
      border-radius: 10px;
      font-weight: 800;
      font-size: 0.95rem;
      line-height: 1;
      white-space: nowrap;
    }

    .pill-phone{
      background: #ffecec;
      color: #d63031;
      border: 1px solid rgba(214,48,49,0.25);
    }
    .pill-id{
      background: #f7f7f7;
      color: #2d3436;
      border: 1px solid rgba(0,0,0,0.08);
    }

    .pay-tag-line,
    .pay-tag-cash{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 64px;
      height: 32px;
      padding: 0 10px;
      border-radius: 10px;
      font-weight: 800;
      font-size: 0.85rem;
      line-height: 1;
      white-space: nowrap;
    }
    .pay-tag-line{
      background-color: #06c755;
      color: #fff;
      border: 1px solid rgba(0,0,0,0.08);
    }
    .pay-tag-cash{
      background-color: #ffcccc;
      color: #d63031;
      border: 1px solid rgba(214,48,49,0.18);
    }

    .status-tag{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 32px;
      padding: 0 12px;
      border-radius: 10px;
      font-weight: 900;
      font-size: 0.85rem;
      white-space: nowrap;
    }
    .tag-pending{ background: #ecf0f1; color: #2d3436; border: 1px solid rgba(0,0,0,0.08); }
    .tag-confirmed{ background: #dbeafe; color: #1d4ed8; border: 1px solid rgba(29,78,216,0.2); }
    .tag-preparing{ background: #fff3cd; color: #7a5a00; border: 1px solid rgba(122,90,0,0.18); }
    .tag-completed{ background: #d1fae5; color: #047857; border: 1px solid rgba(4,120,87,0.18); }
    .tag-arrived{ background: #ffecec; color: #d63031; border: 1px solid rgba(214,48,49,0.25); }
    .tag-final{ background: #e5e7eb; color: #111827; border: 1px solid rgba(17,24,39,0.12); }
    .tag-cancelled{ background: #f1f5f9; color: #64748b; border: 1px solid rgba(100,116,139,0.18); }

    .order-head-right{
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 8px;
      white-space: nowrap;
    }

    .arrow{
      width: 28px; height: 28px;
      display: inline-flex; align-items: center; justify-content: center;
      border-radius: 8px;
      background: #f3f4f6;
      color: #374151;
      border: 1px solid rgba(0,0,0,0.06);
    }

    .detail-content{ padding: 15px; border-top: 1px solid #eee; display: block; }
    .hide-detail{ display: none; }

    .btn-action{
      border-radius: 12px; padding: 15px; font-weight: bold;
      width: 100%; font-size: 1.2rem; margin-bottom: 8px;
    }

    .item-badge{
      background: #fff5f5; border: 1px solid #ffcccc; color: #d63031;
      padding: 6px 10px; border-radius: 8px; margin: 3px;
      display: inline-block; font-size: 1rem; font-weight: bold;
    }

    .time-box{
      font-size: 0.85rem; color: #7f8c8d;
      background: #f9f9f9; padding: 10px; border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.04);
    }

    .btn-final{ background-color: #2d3436; color: white; border: none; }
    .btn-final:hover, .btn-final:active, .btn-final:focus{ background-color: #000000 !important; color: white !important; }

    .qty-controls button{ width: 40px; height: 40px; border-radius: 50%; font-weight: bold; }

    #voiceDebug{
      font-size: 0.85rem; min-height: 20px;
      color: #d63031; font-weight: bold; text-align: center;
    }
    #audio-unlocker select {
        background-color: white;
        color: #333;
        border: none;
        cursor: pointer;
    }

    #audio-unlocker .store-box {
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
    }

    #startBtn:active {
        transform: scale(0.95);
        transition: 0.1s;
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-dark sticky-top">
    <div class="container-fluid">
      <div class="d-flex align-items-center flex-grow-1">
        <span class="navbar-brand fw-bold me-2">ğŸ“ ç®¡ç†ç³»çµ±</span>
        <select id="storeSelector" class="store-selector-nav me-auto" onchange="switchStore()">
          <option value="dajin">å¤§æ´¥ç€‘å¸ƒ</option>
          <option value="neipu">å…§åŸ”å¹´è¡—</option>
        </select>
      </div>

      <button id="navVoiceBtn" class="btn btn-voice-nav voice-inactive shadow-sm" onclick="toggleVoiceControl()">
        âšª
      </button>

      <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasMenu">
        <span class="navbar-toggler-icon"></span>
      </button>
    </div>
  </nav>

  <div class="container">
    <div id="voiceDebug"></div>
    <div id="volumeContainer" class="progress mx-auto mt-1" style="width: 150px; height: 4px; background-color: #eee; border-radius: 5px; overflow: hidden; opacity: 0; transition: opacity 0.3s;">
      <div id="volumeBar" class="progress-bar bg-danger" style="width: 0%; transition: width 0.05s;"></div>
    </div>
  </div>

  <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasMenu">
    <div class="offcanvas-header bg-danger text-white">
      <h5 class="offcanvas-title fw-bold">åŠŸèƒ½é¸å–®</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
      <div class="list-group">
        <a href="javascript:void(0)" onclick="goToReport()" class="list-group-item list-group-item-action py-3 fw-bold text-danger">ğŸ“Š ç‡Ÿæ¥­å ±è¡¨çµ±è¨ˆ</a>
        <a href="/admin/" class="list-group-item list-group-item-action py-3">Django å¾Œå°ç®¡ç†</a>
        <a href="javascript:void(0)" onclick="openStatusBoard()" class="list-group-item list-group-item-action py-3 text-primary">ğŸ–¥ï¸ æ‰“é–‹å«è™Ÿçœ‹æ¿</a>
        <hr>
        <a href="/admin/logout/" class="list-group-item list-group-item-action py-3 text-muted small">å®‰å…¨ç™»å‡º</a>
      </div>
    </div>
  </div>

  <div id="audio-unlocker">
    <h2 class="mb-4 animate__animated animate__fadeInDown">ğŸ“ ä¸€æŠŠè‘«ç®¡ç†ç³»çµ±</h2>
    
    <div class="store-box mb-4 p-4 shadow-lg" style="background: rgba(255,255,255,0.1); border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); width: 90%; max-width: 400px;">
        <p class="mb-3">é¸æ“‡ç®¡ç†åº—é‹ª</p>
        <select id="initStoreSelector" class="form-select form-select-lg mb-4" style="border-radius: 12px; font-weight: bold;">
            <option value="" disabled selected>è¼‰å…¥ä¸­...</option>
        </select>
        <button onclick="unlockAudio()" id="startBtn" class="btn btn-light btn-lg fw-bold w-100 py-3 shadow" style="border-radius: 15px; color: #d63031;">
            å•Ÿå‹•ç³»çµ±
        </button>
    </div>
    
    <p class="small opacity-75">å•Ÿå‹•å¾Œå°‡é–‹å•ŸèªéŸ³é€šçŸ¥èˆ‡å³æ™‚è¨‚å–®ç›£æ¸¬</p>
  </div>

  <div class="container mt-3" id="orderList">
    <div class="text-center mt-5 text-muted">
      <div class="spinner-border text-danger mb-3" role="status"></div>
      <p>æ­£åœ¨åŒæ­¥è¨‚å–®è³‡æ–™...</p>
    </div>
  </div>

  <div class="modal fade" id="editOrderModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" style="border-radius: 20px;">
        <div class="modal-header border-0">
          <h5 class="modal-title fw-bold">ä¿®æ”¹è¨‚å–®å…§å®¹ #<span id="editOrderIdDisplay"></span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="editProductList" class="list-group list-group-flush"></div>
          <div class="mt-4 p-3 bg-light rounded-3 d-flex justify-content-between align-items-center">
            <span class="fw-bold">ä¿®æ­£å¾Œç¸½é¡ï¼š</span>
            <span class="fs-3 fw-bold text-danger" id="editTotalAmount">$0</span>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-danger rounded-pill px-4" onclick="saveOrderChange()">ç¢ºèªå„²å­˜ä¿®æ”¹</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // --- åŸºç¤è®Šæ•¸ ---
    let audioReady = false;
    let alertedArrived = new Set(JSON.parse(localStorage.getItem('alerted_arrived') || '[]'));
    let alertedNewOrder = new Set(JSON.parse(localStorage.getItem('alerted_new_orders') || '[]'));
    let alertedLinePayPaid = new Set(JSON.parse(localStorage.getItem('alerted_linepay_paid') || '[]'));
    let notifyTimes = JSON.parse(localStorage.getItem('notify_times') || '{}');

    let bellAudio = new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU');

    let isFirstLoad = true;
    let currentStore = localStorage.getItem('selected_store') || ''; // åˆå§‹ç•™ç©ºï¼Œç”± API è¼‰å…¥
    let storesData = []; // å­˜æ”¾å¾å¾Œç«¯ API ç²å–çš„åˆ†åº—åˆ—è¡¨
    let allProducts = [], currentEditingOrderId = null, currentEditingItems = [];

    // --- èªéŸ³è®Šæ•¸ ---
    let audioContext = null;
    let micStream = null, micSource = null, analyserNode = null, rafId = null;
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition = null;
    let isVoiceControlling = false;
    let isSpeaking = false;
    let restartTimer = null;
    let lastFinalText = "", lastFinalAt = 0;
    let lastOrdersJson = ''; 

    // --- ğŸš€ åˆå§‹åŒ–æµç¨‹ï¼šèˆ‡å¾Œç«¯é€£å‹•åˆ†åº— ---
    document.addEventListener('DOMContentLoaded', () => {
        fetchStores();
    });

    /**
     * å¾å¾Œç«¯ API ç²å–åˆ†åº—æ¸…å–®ä¸¦å¡«å……ä¸‹æ‹‰é¸å–®
     */
    function fetchStores() {
        fetch('/api/stores/') // è«‹ç¢ºä¿ Django æœ‰å°æ‡‰çš„ API è·¯å¾‘
            .then(res => res.json())
            .then(data => {
                storesData = data;
                const initSelector = document.getElementById('initStoreSelector'); // å•Ÿå‹•ç•«é¢é¸å–®
                const navSelector = document.getElementById('storeSelector');     // å°èˆªæ¬„é¸å–®

                if (!initSelector || !navSelector) return;

                initSelector.innerHTML = '';
                navSelector.innerHTML = '';

                data.forEach(store => {
                    const opt = document.createElement('option');
                    opt.value = store.slug;
                    opt.textContent = store.name;
                    initSelector.appendChild(opt.cloneNode(true));
                    navSelector.appendChild(opt);
                });

                // å¦‚æœæœ‰è¨˜æ†¶ä¸Šæ¬¡çš„åˆ†åº—ï¼Œå‰‡é è¨­é¸ä¸­
                if (currentStore && data.some(s => s.slug === currentStore)) {
                    initSelector.value = currentStore;
                    navSelector.value = currentStore;
                } else if (data.length > 0) {
                    currentStore = data[0].slug; // é è¨­ç¬¬ä¸€é–“
                }
                updateStoreUI();
            })
            .catch(err => {
                console.error("ç„¡æ³•åŠ è¼‰åˆ†åº—è³‡æ–™:", err);
                Swal.fire("é€£ç·šéŒ¯èª¤", "ç„¡æ³•ç²å–åˆ†åº—è³‡è¨Šï¼Œè«‹æª¢æŸ¥ä¼ºæœå™¨ç‹€æ…‹", "error");
            });
    }

    async function ensureAudioContextReady() {
        try {
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            if (audioContext.state === 'suspended') await audioContext.resume();
        } catch (e) {
            console.warn("é‡å»º AudioContext:", e);
            try { if(audioContext) await audioContext.close(); } catch(_){}
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            if (audioContext.state === 'suspended') await audioContext.resume();
        }
    }

    /**
     * å•Ÿå‹•æŒ‰éˆ•é‚è¼¯ï¼šç¢ºèªåˆ†åº—ä¸¦è§£é–éŸ³è¨Š
     */
    async function unlockAudio() {
        const initSelector = document.getElementById('initStoreSelector');
        if (!initSelector || !initSelector.value) {
            Swal.fire("æé†’", "è«‹å…ˆé¸æ“‡æœå‹™åˆ†åº—", "warning");
            return;
        }

        currentStore = initSelector.value;
        localStorage.setItem('selected_store', currentStore);
        document.getElementById('storeSelector').value = currentStore;
        updateStoreUI();

        if (!('speechSynthesis' in window)) {
            Swal.fire({
                icon: 'warning',
                title: 'ç€è¦½å™¨ä¸æ”¯æ´',
                text: 'æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³åŠŸèƒ½ï¼Œè«‹ä½¿ç”¨ Chrome',
                confirmButtonColor: '#d63031'
            });
            return;
        }

        audioReady = true;
        const unlocker = document.getElementById('audio-unlocker');
        unlocker.classList.add('animate__animated', 'animate__fadeOut');
        setTimeout(() => { unlocker.style.display = 'none'; }, 500);

        await ensureAudioContextReady();

        try {
            await bellAudio.play();
            bellAudio.pause();
            bellAudio.currentTime = 0;
        } catch (e) { console.warn('éŸ³è¨Šæ¸¬è©¦å¤±æ•—:', e); }

        const storeName = storesData.find(s => s.slug === currentStore)?.name || "ä¸€æŠŠè‘«";
        setTimeout(() => {
            speak(`${storeName} ç®¡ç†ç³»çµ±å•Ÿå‹•`, { muteRecognition: false });
        }, 300);

        loadOrders();
        setInterval(loadOrders, 5000);
    }

    // --- èªéŸ³æ§åˆ¶é‚è¼¯ ---

    async function toggleVoiceControl() {
        if (!SpeechRecognition) return Swal.fire("ä¸æ”¯æ´", "è«‹ä½¿ç”¨ Chrome ç€è¦½å™¨", "error");
        if (!isVoiceControlling) {
            try { await startVoiceControl(); } 
            catch (err) { Swal.fire("éŒ¯èª¤", "ç„¡æ³•å•Ÿå‹•éº¥å…‹é¢¨ï¼Œè«‹æª¢æŸ¥æ¬Šé™", "error"); }
        } else { stopVoiceControl(); }
    }

    async function startVoiceControl() {
        await ensureAudioContextReady();
        micStream = await navigator.mediaDevices.getUserMedia({
            audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }
        });
        micSource = audioContext.createMediaStreamSource(micStream);
        analyserNode = audioContext.createAnalyser();
        analyserNode.fftSize = 512;
        micSource.connect(analyserNode);
        startVolumeMeter();
        initRecognition();
        recognition.start();
        isVoiceControlling = true;

        const btn = document.getElementById('navVoiceBtn');
        btn.classList.remove('voice-inactive');
        btn.classList.add('voice-active');
        btn.innerHTML = 'â¸ï¸';
        document.getElementById('volumeContainer').style.opacity = '1';
        speak("èªéŸ³æ¨¡å¼å•Ÿå‹•", { muteRecognition: true });
    }

    function stopVoiceControl() {
        isVoiceControlling = false;
        isSpeaking = false;
        if (restartTimer) clearTimeout(restartTimer);
        if (recognition) { try{ recognition.onend = null; recognition.abort(); }catch(e){} recognition = null; }
        stopVolumeMeter();
        if (micStream) { micStream.getTracks().forEach(t => t.stop()); micStream = null; }

        const btn = document.getElementById('navVoiceBtn');
        btn.classList.remove('voice-active');
        btn.classList.add('voice-inactive');
        btn.innerHTML = 'âšª';
        document.getElementById('voiceDebug').innerText = "";
        document.getElementById('volumeContainer').style.opacity = '0';
        speak("èªéŸ³é—œé–‰", { muteRecognition: false });
    }

    function startVolumeMeter() {
        const volBar = document.getElementById('volumeBar');
        const buffer = new Uint8Array(analyserNode.frequencyBinCount);
        const draw = () => {
            if (!isVoiceControlling) return;
            analyserNode.getByteFrequencyData(buffer);
            let sum = 0;
            for(let i=0; i<buffer.length; i++) sum += buffer[i];
            let avg = sum / buffer.length;
            volBar.style.width = Math.min(avg * 2.5, 100) + "%";
            rafId = requestAnimationFrame(draw);
        };
        draw();
    }

    function openStatusBoard() {
    // 1. æª¢æŸ¥æ˜¯å¦å·²ç¶“é¸æ“‡äº†åˆ†åº—
    if (!currentStore) {
        Swal.fire({
            icon: 'warning',
            title: 'è«‹å…ˆé¸æ“‡åˆ†åº—',
            text: 'è«‹åœ¨å•Ÿå‹•ç•«é¢æˆ–ä¸Šæ–¹é¸å–®é¸æ“‡åˆ†åº—å¾Œå†é–‹å•Ÿçœ‹æ¿',
            confirmButtonColor: '#d63031'
        });
        return;
    }

    // 2. ä¾ç…§ urls.py çš„å®šç¾©æ‹¼æ¥ç¶²å€ï¼š/status/åˆ†åº—ä»£è™Ÿ/
    // âš ï¸ å‹™å¿…ç¢ºä¿é–‹é ­æœ‰æ–œç·š /ï¼Œå¦å‰‡æœƒè®Šæˆç›¸å°è·¯å¾‘å°è‡´ 404
    const url = `/status/${currentStore}/`;
    
    console.log("æ­£åœ¨é–‹å•Ÿçœ‹æ¿:", url);
    window.open(url, '_blank');
}
    function stopVolumeMeter() { if (rafId) cancelAnimationFrame(rafId); }

    function initRecognition() {
        recognition = new SpeechRecognition();
        recognition.lang = 'zh-TW';
        recognition.continuous = true;
        recognition.interimResults = true;

        recognition.onresult = (event) => {
            let interim = "";
            for (let i = event.resultIndex; i < event.results.length; i++) {
                const transcript = event.results[i][0].transcript.trim();
                if (event.results[i].isFinal) processVoiceCommand(transcript);
                else interim += transcript;
            }
            if (interim) document.getElementById('voiceDebug').innerText = `ğŸ‘‚: ${interim}`;
        };

        recognition.onend = () => { if (isVoiceControlling && !isSpeaking) scheduleRestart(200); };
    }

    function scheduleRestart(ms) {
        if(restartTimer) clearTimeout(restartTimer);
        restartTimer = setTimeout(() => {
            if(isVoiceControlling && recognition) { try { recognition.start(); } catch(e){} }
        }, ms);
    }

    function processVoiceCommand(rawText) {
        if (rawText === lastFinalText && (Date.now() - lastFinalAt) < 1000) return;
        lastFinalText = rawText;
        lastFinalAt = Date.now();
        document.getElementById('voiceDebug').innerText = `âœ…: ${rawText}`;
        const text = rawText.replace(/\s/g, "");

        let orderId = null;
        const numMatch = text.match(/(\d+)/);
        if (numMatch) orderId = parseInt(numMatch[1]);
        else {
            const zhNum = text.match(/[é›¶ä¸€äºŒå…©ä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+/);
            if (zhNum) orderId = parseChineseNumber(zhNum[0]);
        }
        if (!orderId) return;

        if (text.includes("å®Œæˆ") || text.includes("å¥½äº†")) updateStatus(orderId, 'completed', true);
        else if (text.includes("çµæ¡ˆ") || text.includes("äº¤ä»˜")) updateStatus(orderId, 'final');
        else if (text.includes("æ”¶éŒ¢") || text.includes("æ”¶äº†")) updateStatus(orderId, 'confirmed');
        else if (text.includes("è£½ä½œ")) updateStatus(orderId, 'preparing');
    }

    function parseChineseNumber(s) {
        const map = {'é›¶':0,'ä¸€':1,'äºŒ':2,'å…©':2,'ä¸‰':3,'å››':4,'äº”':5,'å…­':6,'ä¸ƒ':7,'å…«':8,'ä¹':9,'å':10};
        if (s.startsWith('å')) s = 'ä¸€' + s;
        let parts = s.split('å');
        if (parts.length === 1) return map[parts[0]] || 0;
        if (parts.length === 2) return (map[parts[0]] || 0) * 10 + (map[parts[1]] || 0);
        return 0;
    }

    // --- èªéŸ³éšŠåˆ—ç®¡ç† ---
    let speechQueue = [];
    let isSpeakingNow = false;
    
    function processSpeechQueue() {
        if (isSpeakingNow || speechQueue.length === 0) return;
        isSpeakingNow = true;
        const { text, muteRecognition } = speechQueue.shift();
        
        if (!audioReady || !('speechSynthesis' in window)) {
            isSpeakingNow = false;
            processSpeechQueue();
            return;
        }
        
        try {
            if (speechQueue.length === 0) window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'zh-TW';
            u.onend = () => {
                isSpeakingNow = false;
                if (muteRecognition && isVoiceControlling && recognition) {
                    isSpeaking = false;
                    scheduleRestart(200);
                }
                setTimeout(() => processSpeechQueue(), 100);
            };
            
            if (muteRecognition && isVoiceControlling && recognition) {
                isSpeaking = true;
                try { recognition.abort(); } catch(e){}
            }
            window.speechSynthesis.speak(u);
        } catch (e) {
            isSpeakingNow = false;
            processSpeechQueue();
        }
    }
    
    function speak(text, { muteRecognition = true, priority = false } = {}) {
        if (priority) speechQueue.unshift({ text, muteRecognition });
        else speechQueue.push({ text, muteRecognition });
        if (!isSpeakingNow) processSpeechQueue();
    }

    // --- åˆ†åº—èˆ‡è¨‚å–®é‚è¼¯ ---

    function switchStore() {
        currentStore = document.getElementById('storeSelector').value;
        localStorage.setItem('selected_store', currentStore);
        updateStoreUI();
        isFirstLoad = true;
        alertedArrived.clear();
        loadOrders();
        const storeName = storesData.find(s => s.slug === currentStore)?.name || "";
        speak(`å·²åˆ‡æ›è‡³ ${storeName}`, {muteRecognition: false});
    }

    function updateStoreUI() {
        const storeObj = storesData.find(s => s.slug === currentStore);
        const name = storeObj ? storeObj.name : "è¼‰å…¥ä¸­...";
        const display = document.getElementById('targetStoreName');
        if (display) display.innerText = name;
    }

    function loadOrders() {
        if (!currentStore) return;
        fetch(`/api/orders/?store=${currentStore}&t=${new Date().getTime()}`)
            .then(res => {
                if (res.status === 401 || res.status === 403) {
                    window.location.href = '/admin/login/?next=' + window.location.pathname;
                    return null;
                }
                return res.json();
            })
            .then(orders => {
                if (!orders || !Array.isArray(orders)) return;
                const currentJson = JSON.stringify(orders);
                if (currentJson === lastOrdersJson) return; 
                lastOrdersJson = currentJson;

                if (isFirstLoad) {
                    orders.forEach(order => {
                        if (order.status === 'pending') alertedNewOrder.add(order.id);
                        if (order.status === 'arrived') alertedArrived.add(order.id);
                        if (order.status === 'confirmed' && order.payment_method === 'linepay') alertedLinePayPaid.add(order.id);
                    });
                    isFirstLoad = false;
                }

                const list = document.getElementById('orderList');
                if (orders.length === 0) {
                    list.innerHTML = `<div class="text-center mt-5 text-muted"><p>ç›®å‰æ²’æœ‰è¨‚å–®</p></div>`;
                    return;
                }

                const currentlyOpenedIds = [];
                document.querySelectorAll('.detail-content:not(.hide-detail)').forEach(el => {
                    currentlyOpenedIds.push(parseInt(el.id.replace('detail-', '')));
                });

                let newHtml = '';
                orders.sort((a, b) => {
                    const isAClosed = (a.status === 'final' || a.status === 'cancelled');
                    const isBClosed = (b.status === 'final' || b.status === 'cancelled');
                    if (isAClosed && !isBClosed) return 1;
                    if (!isAClosed && isBClosed) return -1;
                    return b.id - a.id;
                }).forEach(order => {
                    // èªéŸ³é€šçŸ¥è§¸ç™¼
                    if (order.status === 'pending' && !alertedNewOrder.has(order.id)) {
                        speak(`æ–°è¨‚å–®ï¼Œç·¨è™Ÿ ${order.id}`);
                        alertedNewOrder.add(order.id);
                        localStorage.setItem('alerted_new_orders', JSON.stringify(Array.from(alertedNewOrder).slice(-100)));
                    }
                    if (order.status === 'arrived' && !alertedArrived.has(order.id)) {
                        speak(`ç·¨è™Ÿ ${order.id} å®¢äººå·²åˆ°æ«ƒæª¯`, {priority: true});
                        alertedArrived.add(order.id);
                        localStorage.setItem('alerted_arrived', JSON.stringify(Array.from(alertedArrived).slice(-100)));
                    }

                    const wasOpened = currentlyOpenedIds.includes(order.id);
                    const isContracted = (order.status === 'final' || order.status === 'cancelled');
                    let detailClass = (wasOpened || !isContracted) ? 'detail-content' : 'detail-content hide-detail';
                    let arrowRotate = (wasOpened || !isContracted) ? 'style="transform: rotate(180deg)"' : '';

                    const isLinePay = order.payment_method === 'linepay';
                    const payTag = isLinePay ? `<span class="pay-tag-line">LINE</span>` : `<span class="pay-tag-cash">CASH</span>`;

                    let actionBtn = '';
                    if (order.status === 'pending') {
                        actionBtn = isLinePay ? `<div class="alert alert-warning py-2 small">â³ ç­‰å¾…é¡§å®¢ä»˜æ¬¾ä¸­...</div>` : `<button onclick="updateStatus(${order.id}, 'confirmed')" class="btn btn-primary btn-action">ğŸ’° å·²æ”¶éŒ¢ï¼šæˆç«‹è¨‚å–®</button>`;
                    } else if (order.status === 'confirmed') {
                        actionBtn = `<button onclick="updateStatus(${order.id}, 'preparing')" class="btn btn-warning btn-action">ğŸ“ é–‹å§‹è£½ä½œ</button>`;
                    } else if (order.status === 'preparing') {
                        actionBtn = `<button onclick="updateStatus(${order.id}, 'completed', true)" class="btn btn-success btn-action">ğŸ”” è£½ä½œå®Œæˆ</button>`;
                    } else if (order.status === 'arrived') {
                        actionBtn = `<button onclick="confirmAction(${order.id}, 'final', 'ç¢ºèªäº¤ä»˜çµæ¡ˆï¼Ÿ')" class="btn btn-danger btn-action">âœ¨ äº¤ä»˜çµæ¡ˆ</button>`;
                    }

                    newHtml += `
                        <div class="card order-card status-${order.status}" id="card-${order.id}">
                            <div class="card-header-clickable" onclick="toggleDetail(${order.id})">
                                <div class="order-head-left">
                                    <span class="order-pill pill-phone">${order.phone_tail || 'ç¾å ´'}</span>
                                    <span class="order-pill pill-id">#${order.id}</span>
                                    ${payTag}
                                    <span class="status-tag">${getStatusText(order.status)}</span>
                                </div>
                                <span class="arrow" id="arrow-${order.id}" ${arrowRotate}>â–¼</span>
                            </div>
                            <div id="detail-${order.id}" class="${detailClass}">
                                <div class="mb-2">
                                    ${(order.items || []).map(i => `<span class="item-badge">${i.name} x ${i.quantity}</span>`).join('')}
                                </div>
                                <div class="time-box">
                                    <div>ğŸ•’ ä¸‹å–®ï¼š${new Date(order.created_at).toLocaleTimeString()}</div>
                                    <div class="mt-1 fw-bold text-danger">ç¸½é¡ï¼š$${order.total}</div>
                                </div>
                                <div class="mt-2">${actionBtn}</div>
                            </div>
                        </div>
                    `;
                });
                list.innerHTML = newHtml;
            });
    }

    // --- å·¥å…·å‡½å¼ ---
    function getCookie(n) { let v = document.cookie.match('(^|;) ?' + n + '=([^;]*)(;|$)'); return v ? decodeURIComponent(v[2]) : null; }
    function getStatusText(s) { const map = { 'pending': 'å¾…ä»˜', 'confirmed': 'å·²ä»˜', 'preparing': 'è£½ä½œä¸­', 'completed': 'é€šçŸ¥ä¸­', 'arrived': 'åˆ°æ«ƒ', 'final': 'çµæ¡ˆ', 'cancelled': 'å–æ¶ˆ' }; return map[s] || s; }
    function toggleDetail(id) {
        const d = document.getElementById(`detail-${id}`), a = document.getElementById(`arrow-${id}`);
        if (d && a) { const isH = d.classList.toggle('hide-detail'); a.style.transform = isH ? 'rotate(0deg)' : 'rotate(180deg)'; }
    }
    function updateStatus(id, ns, notify = false) {
        fetch(`/api/orders/${id}/`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
            body: JSON.stringify({ status: ns })
        }).then(() => loadOrders());
    }
  </script>
</body>
</html>
