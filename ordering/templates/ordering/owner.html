<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>ä¸€æŠŠè‘«ç®¡ç†å¾Œå° - å³æ™‚è¨‚å–®</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    /* =========================================
       æ‚¨çš„åŸå§‹ UI æ¨£å¼ (å®Œå…¨ä¿ç•™)
       ========================================= */
    body { background-color: #f0f2f5; font-family: "Microsoft JhengHei", sans-serif; padding-bottom: 50px; }
    .navbar { background-color: #d63031 !important; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }

    #audio-unlocker{
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(214, 48, 49, 0.95); z-index: 9999;
      display: flex; flex-direction: column; align-items: center; justify-content: center; color: white;
    }

    .store-selector-nav{
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.3);
      color: white; border-radius: 8px; padding: 2px 10px; font-weight: bold;
    }

    .btn-voice-nav{
      width: 42px; height: 42px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.2rem; border: none; transition: all 0.3s ease; margin-right: 12px;
    }
    .voice-inactive{ background-color: rgba(255, 255, 255, 0.9); color: #d63031; }
    .voice-active{
      background-color: #ff4757 !important; color: white !important;
      box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7);
      animation: pulse-voice-nav 1.5s infinite;
    }
    @keyframes pulse-voice-nav{
      0% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); }
      70% { box-shadow: 0 0 0 8px rgba(255, 71, 87, 0); }
      100% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); }
    }

    .order-card{
      border: none; border-radius: 12px; margin-bottom: 12px;
      overflow: hidden; border-left: 8px solid #ccc;
      transition: transform 0.12s ease, box-shadow 0.12s ease;
      background: white;
      box-shadow: 0 4px 10px rgba(0,0,0,0.06);
    }
    .order-card:hover{ transform: translateY(-1px); box-shadow: 0 6px 14px rgba(0,0,0,0.08); }

    .status-pending{ border-left-color: #636e72; }
    .status-confirmed{ border-left-color: #0984e3; }
    .status-preparing{ border-left-color: #fdcb6e; }
    .status-completed{ border-left-color: #00b894; }
    .status-arrived{ border-left-color: #d63031; animation: pulse-red-border 1s infinite; }
    .status-final{ border-left-color: #2ecc71; opacity: 0.65; }
    .status-cancelled{ border-left-color: #b2bec3; opacity: 0.65; }

    @keyframes pulse-red-border{
      0% { border-left-width: 8px; } 50% { border-left-width: 14px; } 100% { border-left-width: 8px; }
    }

    .card-header-clickable{
      padding: 14px 14px; cursor: pointer;
      display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 10px; user-select: none;
    }
    .order-head-left{ display: flex; align-items: center; gap: 8px; min-width: 0; flex-wrap: nowrap; width: 100%; }
    
    @media (min-width: 992px){ .order-head-left > *{ flex: 1 1 0; display: inline-flex; justify-content: center; min-width: 0; } }
    @media (max-width: 991.98px){ .order-head-left > *{ flex: 0 0 auto; } }

    /* æ‚¨çš„è—¥ä¸¸æ¨£å¼ */
    .order-pill{
      display: inline-flex; align-items: center; justify-content: center; height: 32px; padding: 0 10px;
      border-radius: 10px; font-weight: 800; font-size: 0.95rem; line-height: 1; white-space: nowrap;
    }
    .pill-phone{ background: #ffecec; color: #d63031; border: 1px solid rgba(214,48,49,0.25); }
    .pill-id{ background: #f7f7f7; color: #2d3436; border: 1px solid rgba(0,0,0,0.08); }

    /* æ‚¨çš„ä»˜æ¬¾æ¨™ç±¤ */
    .pay-tag-line, .pay-tag-cash{
      display: inline-flex; align-items: center; justify-content: center; width: 64px; height: 32px;
      padding: 0 10px; border-radius: 10px; font-weight: 800; font-size: 0.85rem; line-height: 1; white-space: nowrap;
    }
    .pay-tag-line{ background-color: #06c755; color: #fff; border: 1px solid rgba(0,0,0,0.08); }
    .pay-tag-cash{ background-color: #ffcccc; color: #d63031; border: 1px solid rgba(214,48,49,0.18); }

    /* æ‚¨çš„ç‹€æ…‹æ¨™ç±¤ */
    .status-tag{
      display: inline-flex; align-items: center; justify-content: center; height: 32px; padding: 0 12px;
      border-radius: 10px; font-weight: 900; font-size: 0.85rem; white-space: nowrap;
    }
    .tag-pending{ background: #ecf0f1; color: #2d3436; border: 1px solid rgba(0,0,0,0.08); }
    .tag-confirmed{ background: #dbeafe; color: #1d4ed8; border: 1px solid rgba(29,78,216,0.2); }
    .tag-preparing{ background: #fff3cd; color: #7a5a00; border: 1px solid rgba(122,90,0,0.18); }
    .tag-completed{ background: #d1fae5; color: #047857; border: 1px solid rgba(4,120,87,0.18); }
    .tag-arrived{ background: #ffecec; color: #d63031; border: 1px solid rgba(214,48,49,0.25); }
    .tag-final{ background: #e5e7eb; color: #111827; border: 1px solid rgba(17,24,39,0.12); }
    .tag-cancelled{ background: #f1f5f9; color: #64748b; border: 1px solid rgba(100,116,139,0.18); }

    .arrow{
      width: 28px; height: 28px; display: inline-flex; align-items: center; justify-content: center;
      border-radius: 8px; background: #f3f4f6; color: #374151; border: 1px solid rgba(0,0,0,0.06);
    }
    .detail-content{ padding: 15px; border-top: 1px solid #eee; display: block; }
    .hide-detail{ display: none; }
    .btn-action{ border-radius: 12px; padding: 15px; font-weight: bold; width: 100%; font-size: 1.2rem; margin-bottom: 8px; }
    .item-badge{
      background: #fff5f5; border: 1px solid #ffcccc; color: #d63031; padding: 6px 10px;
      border-radius: 8px; margin: 3px; display: inline-block; font-size: 1rem; font-weight: bold;
    }
    .time-box{
      font-size: 0.85rem; color: #7f8c8d; background: #f9f9f9; padding: 10px; border-radius: 8px; border: 1px solid rgba(0,0,0,0.04);
    }
    .btn-final{ background-color: #2d3436; color: white; border: none; }
    .btn-final:hover{ background-color: #000000 !important; color: white !important; }
    .qty-controls button{ width: 40px; height: 40px; border-radius: 50%; font-weight: bold; }
    #voiceDebug{ font-size: 0.85rem; min-height: 20px; color: #d63031; font-weight: bold; text-align: center; }
    #audio-unlocker select { background-color: white; color: #333; border: none; cursor: pointer; }
    #audio-unlocker .store-box { backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
  </style>
</head>

<body>
  <nav class="navbar navbar-dark sticky-top">
    <div class="container-fluid">
      <div class="d-flex align-items-center flex-grow-1">
        <span class="navbar-brand fw-bold me-2">ğŸ“ ç®¡ç†ç³»çµ±</span>
        <select id="storeSelector" class="store-selector-nav me-auto" onchange="switchStore()">
          <option value="dajin">å¤§æ´¥ç€‘å¸ƒ</option>
          <option value="neipu">å…§åŸ”å¹´è¡—</option>
        </select>
      </div>
      <button id="navVoiceBtn" class="btn btn-voice-nav voice-inactive shadow-sm" onclick="toggleVoiceControl()">âšª</button>
      <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasMenu">
        <span class="navbar-toggler-icon"></span>
      </button>
    </div>
  </nav>

  <div class="container">
    <div id="voiceDebug"></div>
    <div id="volumeContainer" class="progress mx-auto mt-1" style="width: 150px; height: 4px; background-color: #eee; border-radius: 5px; overflow: hidden; opacity: 0; transition: opacity 0.3s;">
      <div id="volumeBar" class="progress-bar bg-danger" style="width: 0%; transition: width 0.05s;"></div>
    </div>
  </div>

  <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasMenu">
    <div class="offcanvas-header bg-danger text-white">
      <h5 class="offcanvas-title fw-bold">åŠŸèƒ½é¸å–®</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
      <div class="list-group">
        <a href="javascript:void(0)" onclick="goToReport()" class="list-group-item list-group-item-action py-3 fw-bold text-danger">ğŸ“Š ç‡Ÿæ¥­å ±è¡¨çµ±è¨ˆ</a>
        <a href="/admin/" class="list-group-item list-group-item-action py-3">Django å¾Œå°ç®¡ç†</a>
        <a href="javascript:void(0)" onclick="openStatusBoard()" class="list-group-item list-group-item-action py-3 text-primary">ğŸ–¥ï¸ æ‰“é–‹å«è™Ÿçœ‹æ¿</a>
        <hr>
        <a href="/admin/logout/" class="list-group-item list-group-item-action py-3 text-muted small">å®‰å…¨ç™»å‡º</a>
      </div>
    </div>
  </div>

  <div id="audio-unlocker">
    <h2 class="mb-4 animate__animated animate__fadeInDown">ğŸ“ ä¸€æŠŠè‘«ç®¡ç†ç³»çµ±</h2>
    <div class="store-box mb-4 p-4 shadow-lg" style="background: rgba(255,255,255,0.1); border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); width: 90%; max-width: 400px;">
        <p class="mb-3">é¸æ“‡ç®¡ç†åº—é‹ª</p>
        <select id="initStoreSelector" class="form-select form-select-lg mb-4" style="border-radius: 12px; font-weight: bold;">
            <option value="" disabled selected>è¼‰å…¥ä¸­...</option>
        </select>
        <button onclick="unlockAudio()" id="startBtn" class="btn btn-light btn-lg fw-bold w-100 py-3 shadow" style="border-radius: 15px; color: #d63031;">
            å•Ÿå‹•ç³»çµ±
        </button>
    </div>
    <p class="small opacity-75">å•Ÿå‹•å¾Œå°‡é–‹å•ŸèªéŸ³é€šçŸ¥èˆ‡å³æ™‚è¨‚å–®ç›£æ¸¬</p>
  </div>

  <div class="container mt-3" id="orderList">
    <div class="text-center mt-5 text-muted">
      <div class="spinner-border text-danger mb-3" role="status"></div>
      <p>æ­£åœ¨åŒæ­¥è¨‚å–®è³‡æ–™...</p>
    </div>
  </div>

  <div class="modal fade" id="editOrderModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" style="border-radius: 20px;">
        <div class="modal-header border-0">
          <h5 class="modal-title fw-bold">ä¿®æ”¹è¨‚å–®å…§å®¹ #<span id="editOrderIdDisplay"></span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="editProductList" class="list-group list-group-flush"></div>
          <div class="mt-4 p-3 bg-light rounded-3 d-flex justify-content-between align-items-center">
            <span class="fw-bold">ä¿®æ­£å¾Œç¸½é¡ï¼š</span>
            <span class="fs-3 fw-bold text-danger" id="editTotalAmount">$0</span>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-danger rounded-pill px-4" onclick="saveOrderChange()">ç¢ºèªå„²å­˜ä¿®æ”¹</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ==========================================
    // 1. åŸºç¤è®Šæ•¸èˆ‡è¨­å®š
    // ==========================================
    let currentStore = localStorage.getItem('selected_store') || ''; 
    let storesData = []; 
    let isFirstLoad = true;
    
    // é€šçŸ¥è¨˜éŒ„
    let alertedArrived = new Set(JSON.parse(localStorage.getItem('alerted_arrived') || '[]'));
    let alertedNewOrder = new Set(JSON.parse(localStorage.getItem('alerted_new_orders') || '[]'));
    let alertedLinePayPaid = new Set(JSON.parse(localStorage.getItem('alerted_linepay_paid') || '[]'));
    let lastOrdersJson = ''; 
    let allProducts = [], currentEditingOrderId = null, currentEditingItems = [];

    // ==========================================
    // 2. èªéŸ³èˆ‡éŸ³æ•ˆè®Šæ•¸ (æ ¸å¿ƒä¿®å¾©)
    // ==========================================
    let audioContext = null;        
    let recognition = null;         
    let isVoiceControlling = false; 
    let isRecognitionActive = false;
    let isSpeaking = false; 
    let restartTimer = null; // é‡å•Ÿè¨ˆæ™‚å™¨
    let lastFinalText = "", lastFinalAt = 0;
    let micStream = null, micSource = null, analyserNode = null, rafId = null;

    // ğŸ›‘ é˜²æ­¢èªéŸ³ç‰©ä»¶è¢«å›æ”¶
    const utteranceStorage = [];

    // ==========================================
    // 3. åˆå§‹åŒ–æµç¨‹
    // ==========================================
    document.addEventListener('DOMContentLoaded', () => {
        fetchStores();
        if ('speechSynthesis' in window) window.speechSynthesis.getVoices(); 
    });

    function fetchStores() {
        fetch('/api/stores/')
            .then(res => res.json())
            .then(data => {
                storesData = data;
                const initSelector = document.getElementById('initStoreSelector');
                const navSelector = document.getElementById('storeSelector');
                if (!initSelector || !navSelector) return;

                initSelector.innerHTML = '';
                navSelector.innerHTML = '';

                data.forEach(store => {
                    const opt = document.createElement('option');
                    opt.value = store.slug;
                    opt.textContent = store.name;
                    initSelector.appendChild(opt.cloneNode(true));
                    navSelector.appendChild(opt);
                });

                if (currentStore && data.some(s => s.slug === currentStore)) {
                    initSelector.value = currentStore;
                    navSelector.value = currentStore;
                } else if (data.length > 0) {
                    currentStore = data[0].slug;
                }
                updateStoreUI();
            })
            .catch(err => console.error("åˆ†åº—è¼‰å…¥å¤±æ•—", err));
    }

    async function unlockAudio() {
        const initSelector = document.getElementById('initStoreSelector');
        if (!initSelector || !initSelector.value) return Swal.fire("è«‹å…ˆé¸æ“‡åˆ†åº—");

        currentStore = initSelector.value;
        localStorage.setItem('selected_store', currentStore);
        document.getElementById('storeSelector').value = currentStore;
        updateStoreUI();

        if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
        if (audioContext.state === 'suspended') await audioContext.resume();

        const unlocker = document.getElementById('audio-unlocker');
        unlocker.classList.add('animate__animated', 'animate__fadeOut');
        setTimeout(() => { unlocker.style.display = 'none'; }, 500);

        playBell();
        setTimeout(() => speak("ç³»çµ±å•Ÿå‹•æˆåŠŸ"), 600);

        loadOrders();
        setInterval(loadOrders, 5000); 
    }

    // ==========================================
    // 4. éŸ³æ•ˆ
    // ==========================================
    function playBell() {
        if (!audioContext) return;
        if (audioContext.state === 'suspended') audioContext.resume();

        const now = audioContext.currentTime;
        const osc1 = audioContext.createOscillator();
        const gain1 = audioContext.createGain();
        osc1.type = 'sine';
        osc1.frequency.setValueAtTime(660, now); 
        gain1.gain.setValueAtTime(0.1, now);
        gain1.gain.exponentialRampToValueAtTime(0.001, now + 1.5);
        osc1.connect(gain1);
        gain1.connect(audioContext.destination);
        osc1.start(now);
        osc1.stop(now + 1.5);

        const osc2 = audioContext.createOscillator();
        const gain2 = audioContext.createGain();
        osc2.type = 'sine';
        osc2.frequency.setValueAtTime(523.25, now + 0.4); 
        gain2.gain.setValueAtTime(0.1, now + 0.4);
        gain2.gain.exponentialRampToValueAtTime(0.001, now + 2);
        osc2.connect(gain2);
        gain2.connect(audioContext.destination);
        osc2.start(now + 0.4);
        osc2.stop(now + 2);
    }

    // ==========================================
    // 5. ğŸ¤ èªéŸ³æ§åˆ¶ (æ ¸å¿ƒä¿®å¾©å€)
    // ==========================================
    
    // â˜…â˜…â˜… 1. å®šç¾©é‡å•Ÿå‡½å¼ (å¿…é ˆåœ¨è¢«å‘¼å«å‰å®šç¾©) â˜…â˜…â˜…
    function scheduleRestart(ms) {
        if (restartTimer) clearTimeout(restartTimer);
        restartTimer = setTimeout(() => {
            if (isVoiceControlling && recognition && !isSpeaking) {
                try { 
                    recognition.start(); 
                    const dbg = document.getElementById('voiceDebug');
                    if(dbg) dbg.innerText = "ğŸ¤ è†è½ä¸­...";
                } catch(e) { /* å¿½ç•¥é‡è¤‡å•Ÿå‹•éŒ¯èª¤ */ }
            }
        }, ms);
    }

    // â˜…â˜…â˜… 2. èªéŸ³åˆæˆ (è¬›è©±æ™‚æš«åœè¾¨è­˜) â˜…â˜…â˜…
    function speak(text) {
        if (!('speechSynthesis' in window)) return;
        
        // èªªè©±æ™‚æš«åœè¾¨è­˜ï¼Œé¿å…è½åˆ°è‡ªå·±
        if (isVoiceControlling && recognition) {
            isSpeaking = true;
            try { recognition.abort(); } catch(e){}
        }

        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'zh-TW';
        u.rate = 1.1; 
        
        const voices = window.speechSynthesis.getVoices();
        const zhVoice = voices.find(v => v.lang === 'zh-TW') || voices.find(v => v.lang.includes('zh'));
        if (zhVoice) u.voice = zhVoice;

        utteranceStorage.push(u);
        u.onend = function() {
            const index = utteranceStorage.indexOf(u);
            if (index > -1) utteranceStorage.splice(index, 1);
            
            // èªªå®Œè©±å¾Œæ¢å¾©è¾¨è­˜
            isSpeaking = false;
            // å‘¼å«é‡å•Ÿå‡½å¼ (é€™è£¡å°±æ˜¯æ‚¨åŸæœ¬å ±éŒ¯çš„åœ°æ–¹)
            scheduleRestart(200);
        };
        window.speechSynthesis.speak(u);
    }

    async function toggleVoiceControl() {
        if (!isVoiceControlling) {
             try { await startVoiceControl(); } 
             catch(e) { Swal.fire("éŒ¯èª¤", "ç„¡æ³•å•Ÿå‹•éº¥å…‹é¢¨", "error"); }
        } else { 
            stopVoiceControl(); 
        }
    }

    async function startVoiceControl() {
        if (!('webkitSpeechRecognition' in window)) return Swal.fire("è«‹ä½¿ç”¨ Chrome");
        
        if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
        if (audioContext.state === 'suspended') await audioContext.resume();

        // è¦–è¦ºåŒ–
        try {
            micStream = await navigator.mediaDevices.getUserMedia({ 
                audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }
            });
            micSource = audioContext.createMediaStreamSource(micStream);
            analyserNode = audioContext.createAnalyser();
            analyserNode.fftSize = 512;
            micSource.connect(analyserNode);
            startVolumeMeter();
        } catch(e) { console.warn("è¦–è¦ºåŒ–å¤±æ•—", e); }

        initRecognition();
        try { recognition.start(); } catch(e){}

        isVoiceControlling = true;
        const btn = document.getElementById('navVoiceBtn');
        btn.classList.add('voice-active');
        btn.classList.remove('voice-inactive');
        btn.innerHTML = 'â¸ï¸';
        document.getElementById('volumeContainer').style.opacity = '1';
        speak("è²æ§å•Ÿå‹•");
    }

    function stopVoiceControl() {
        isVoiceControlling = false;
        isSpeaking = false;
        if (restartTimer) clearTimeout(restartTimer);

        const btn = document.getElementById('navVoiceBtn');
        btn.classList.remove('voice-active');
        btn.classList.add('voice-inactive');
        btn.innerHTML = 'âšª';
        document.getElementById('voiceDebug').innerText = "";
        document.getElementById('volumeContainer').style.opacity = '0';

        if (recognition) {
            recognition.onend = null; // é˜²æ­¢è§¸ç™¼é‡å•Ÿ
            try { recognition.abort(); } catch(e){}
        }
        stopVolumeMeter();
        if (micStream) { micStream.getTracks().forEach(t => t.stop()); micStream = null; }
    }

    // â˜…â˜…â˜… 3. è¾¨è­˜åˆå§‹åŒ– (éæ¿¾éŒ¯èª¤) â˜…â˜…â˜…
    function initRecognition() {
        if (!window.webkitSpeechRecognition) return;
        
        if (recognition) {
             recognition.onend = null;
             recognition.onerror = null;
        }

        recognition = new window.webkitSpeechRecognition();
        recognition.lang = 'zh-TW';
        recognition.continuous = true; 
        recognition.interimResults = true;

        recognition.onstart = () => { 
            isRecognitionActive = true; 
            const dbg = document.getElementById('voiceDebug');
            if(dbg) dbg.innerText = "ğŸ¤ è†è½ä¸­..."; 
        };
        
        // æ–·ç·šè‡ªå‹•é‡é€£
        recognition.onend = () => { 
            isRecognitionActive = false; 
            if (isVoiceControlling && !isSpeaking) {
                scheduleRestart(200);
            }
        };

        recognition.onresult = (event) => {
            let interim = "";
            for (let i = event.resultIndex; i < event.results.length; i++) {
                const transcript = event.results[i][0].transcript.trim();
                if (event.results[i].isFinal) processVoiceCommand(transcript);
                else interim += transcript;
            }
            if(interim) document.getElementById('voiceDebug').innerText = `ğŸ‘‚: ${interim}`;
        };

        // éŒ¯èª¤è™•ç†ï¼šå¿½ç•¥ no-speech èˆ‡ aborted
        recognition.onerror = (event) => {
            if (event.error === 'no-speech' || event.error === 'aborted') return;
            
            console.log('èªéŸ³ä¾‹å¤–:', event.error);
            if (event.error === 'not-allowed') {
                stopVoiceControl();
                Swal.fire("éº¥å…‹é¢¨è¢«æ‹’çµ•", "è«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®š", "error");
            } else {
                scheduleRestart(500);
            }
        };
    }

    function processVoiceCommand(text) {
        if (text === lastFinalText && (Date.now() - lastFinalAt) < 1000) return;
        lastFinalText = text;
        lastFinalAt = Date.now();
        document.getElementById('voiceDebug').innerText = `âœ…: ${text}`;

        text = text.replace(/\s/g, "");
        let orderId = null;
        
        const numMatch = text.match(/(\d+)/);
        if (numMatch) orderId = parseInt(numMatch[1]);
        else {
            const zhNum = text.match(/[é›¶ä¸€äºŒå…©ä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+/);
            if (zhNum) orderId = parseChineseNumber(zhNum[0]);
        }

        if (orderId) {
            if (text.includes("å®Œæˆ") || text.includes("å¥½äº†") || text.includes("é€šçŸ¥")) {
                speak(`${orderId}è™Ÿå®Œæˆ`);
                updateStatus(orderId, 'completed', true);
            }
            else if (text.includes("çµæ¡ˆ") || text.includes("äº¤ä»˜")) {
                speak(`${orderId}è™Ÿçµæ¡ˆ`);
                updateStatus(orderId, 'final');
            }
            else if (text.includes("æ”¶éŒ¢") || text.includes("æ”¶äº†") || text.includes("ç¢ºèª")) {
                speak(`${orderId}è™Ÿå·²æ”¶éŒ¢`);
                updateStatus(orderId, 'confirmed');
            }
            else if (text.includes("è£½ä½œ") || text.includes("åš")) {
                speak(`${orderId}è™Ÿè£½ä½œä¸­`);
                updateStatus(orderId, 'preparing');
            }
        }
    }

    function parseChineseNumber(s) {
        const map = {'é›¶':0,'ä¸€':1,'äºŒ':2,'å…©':2,'ä¸‰':3,'å››':4,'äº”':5,'å…­':6,'ä¸ƒ':7,'å…«':8,'ä¹':9,'å':10};
        let val = 0;
        if (s.startsWith('å')) s = 'ä¸€' + s; 
        let parts = s.split('å');
        if (parts.length === 1) return map[parts[0]] || 0;
        if (parts.length === 2) {
            let ten = map[parts[0]] || 0;
            let unit = map[parts[1]] || 0;
            return ten * 10 + unit;
        }
        return 0;
    }
    
    function startVolumeMeter() {
        const volBar = document.getElementById('volumeBar');
        const buffer = new Uint8Array(analyserNode.frequencyBinCount);
        const draw = () => {
            if (!isVoiceControlling) return;
            analyserNode.getByteFrequencyData(buffer);
            let sum = 0;
            for(let i=0; i<buffer.length; i++) sum += buffer[i];
            let avg = sum / buffer.length;
            if(volBar) volBar.style.width = Math.min(avg * 2.5, 100) + "%";
            rafId = requestAnimationFrame(draw);
        };
        draw();
    }
    function stopVolumeMeter() { if (rafId) cancelAnimationFrame(rafId); }

    // ==========================================
    // 6. è³‡æ–™è¼‰å…¥èˆ‡æ¸²æŸ“ (UI é‚è¼¯)
    // ==========================================
    function switchStore() {
        currentStore = document.getElementById('storeSelector').value;
        localStorage.setItem('selected_store', currentStore);
        updateStoreUI();
        isFirstLoad = true;
        alertedArrived.clear();
        loadOrders();
        speak("å·²åˆ‡æ›åˆ†åº—");
    }

    function updateStoreUI() {
        const storeObj = storesData.find(s => s.slug === currentStore);
        if(document.getElementById('targetStoreName')) 
            document.getElementById('targetStoreName').innerText = storeObj ? storeObj.name : "";
    }

    function loadOrders() {
        if (!currentStore) return;
        fetch(`/api/orders/?store=${currentStore}&t=${Date.now()}`)
            .then(res => res.json())
            .then(orders => {
                if (!Array.isArray(orders)) return;
                
                const jsonStr = JSON.stringify(orders);
                if (jsonStr === lastOrdersJson) return;
                lastOrdersJson = jsonStr;

                const list = document.getElementById('orderList');
                if (orders.length === 0) {
                    list.innerHTML = `<div class="text-center mt-5 text-muted">ç›®å‰æ²’æœ‰è¨‚å–®</div>`;
                    return;
                }

                const openedIds = [];
                document.querySelectorAll('.detail-content:not(.hide-detail)').forEach(el => {
                    openedIds.push(parseInt(el.id.replace('detail-', '')));
                });

                let html = '';
                orders.sort((a, b) => {
                    const aClosed = (a.status === 'final' || a.status === 'cancelled');
                    const bClosed = (b.status === 'final' || b.status === 'cancelled');
                    if (aClosed && !bClosed) return 1;
                    if (!aClosed && bClosed) return -1;
                    return b.id - a.id;
                });

                orders.forEach(order => {
                    if (order.status === 'pending' && !alertedNewOrder.has(order.id)) {
                        if (!isFirstLoad) speak(`æ–°è¨‚å–® ${order.id}è™Ÿ`);
                        alertedNewOrder.add(order.id);
                        localStorage.setItem('alerted_new_orders', JSON.stringify([...alertedNewOrder].slice(-50)));
                    }
                    if (order.status === 'arrived' && !alertedArrived.has(order.id)) {
                        playBell(); 
                        setTimeout(() => speak(`${order.id}è™Ÿ å®¢äººå·²ç¶“åˆ°æ«ƒæª¯æ‘Ÿ`), 1000);
                        alertedArrived.add(order.id);
                        localStorage.setItem('alerted_arrived', JSON.stringify([...alertedArrived].slice(-50)));
                    }
                    if (order.status === 'confirmed' && order.payment_method === 'linepay' && !alertedLinePayPaid.has(order.id)) {
                        speak(`${order.id}è™Ÿ ç·šä¸Šä»˜æ¬¾æˆåŠŸ`);
                        alertedLinePayPaid.add(order.id);
                        localStorage.setItem('alerted_linepay_paid', JSON.stringify([...alertedLinePayPaid].slice(-50)));
                    }

                    // --- UI ç´°é … ---
                    const wasOpened = openedIds.includes(order.id);
                    const isContracted = (order.status === 'final' || order.status === 'cancelled');
                    let detailClass = (wasOpened || !isContracted) ? 'detail-content' : 'detail-content hide-detail';
                    let arrowRotate = (wasOpened || !isContracted) ? 'style="transform: rotate(180deg)"' : '';

                    const isLinePay = order.payment_method === 'linepay';
                    const payTag = isLinePay ? `<span class="pay-tag-line">LINE</span>` : `<span class="pay-tag-cash">CASH</span>`;

                    let actionBtn = '';
                    if (order.status === 'pending') {
                        if (isLinePay) {
                            actionBtn = `
                                <div class="alert alert-warning text-center fw-bold mb-2 py-2 small">â³ ç­‰å¾…é¡§å®¢ä»˜æ¬¾ä¸­...</div>
                                <button onclick="cancelOrder(${order.id})" class="btn btn-link btn-sm text-muted w-100 mt-1">å–æ¶ˆè¨‚å–®</button>
                            `;
                        } else {
                            actionBtn = `
                                <button onclick="updateStatus(${order.id}, 'confirmed')" class="btn btn-primary btn-action shadow">ğŸ’° å·²æ”¶éŒ¢ï¼šæˆç«‹è¨‚å–®</button>
                                <button onclick="cancelOrder(${order.id})" class="btn btn-link btn-sm text-muted w-100 mt-1">å–æ¶ˆè¨‚å–®</button>
                            `;
                        }
                    } else if (order.status === 'confirmed') {
                        actionBtn = `
                            <button onclick="updateStatus(${order.id}, 'preparing')" class="btn btn-warning btn-action shadow">ğŸ“ é–‹å§‹è£½ä½œé¤é»</button>
                            <button onclick="cancelOrder(${order.id})" class="btn btn-link btn-sm text-muted w-100 mt-1">å–æ¶ˆè¨‚å–®</button>
                        `;
                    } else if (order.status === 'preparing') {
                        actionBtn = `
                            <button onclick="updateStatus(${order.id}, 'completed', true)" class="btn btn-success btn-action shadow">ğŸ”” è£½ä½œå®Œæˆï¼šç™¼é€é€šçŸ¥</button>
                            <button onclick="cancelOrder(${order.id})" class="btn btn-link btn-sm text-muted w-100 mt-1">å–æ¶ˆè¨‚å–®</button>
                        `;
                    } else if (order.status === 'completed') {
                        actionBtn = `
                            <div class="alert alert-info text-center mb-2 py-2 fw-bold small">âŒ› å·²é€šçŸ¥ï¼Œç­‰å€™å–é¤ä¸­...</div>
                            <button onclick="confirmAction(${order.id}, 'final', 'ç¢ºèªäº¤ä»˜é¤é»ä¸¦çµæ¡ˆï¼Ÿ')" class="btn btn-danger btn-action shadow">âœ¨ äº¤ä»˜çµæ¡ˆ</button>
                        `;
                    } else if (order.status === 'arrived') {
                        actionBtn = `
                            <button onclick="confirmAction(${order.id}, 'final', 'ç¢ºèªäº¤ä»˜çµæ¡ˆï¼Ÿ')" class="btn btn-danger btn-action animate__animated animate__pulse animate__infinite shadow-lg">ğŸš¨ å®¢äººå·²æŠµé”ï¼é»æ­¤çµæ¡ˆ</button>
                        `;
                    } else if (order.status === 'cancelled') {
                        actionBtn = `<div class="text-center py-2 text-danger fw-bold">âŒ è¨‚å–®å·²å–æ¶ˆ</div>`;
                    } else if (order.status === 'final') {
                        actionBtn = `<div class="text-center py-2 text-success fw-bold">âœ… äº¤æ˜“å·²å®Œæˆ</div>`;
                    }

                    const statusTagClass = { pending: 'tag-pending', confirmed: 'tag-confirmed', preparing: 'tag-preparing', completed: 'tag-completed', arrived: 'tag-arrived', final: 'tag-final', cancelled: 'tag-cancelled' }[order.status];

                    html += `
                        <div class="card order-card status-${order.status}" id="card-${order.id}">
                            <div class="card-header-clickable" onclick="toggleDetail(${order.id})">
                                <div class="order-head-left">
                                    <span class="order-pill pill-phone">${order.phone_tail || 'ç¾å ´'}</span>
                                    <span class="order-pill pill-id">#${order.id}</span>
                                    ${payTag}
                                    <span class="status-tag ${statusTagClass}">
                                        ${getStatusText(order.status)}${order.status === 'arrived' ? ' ğŸš¨' : ''}
                                    </span>
                                </div>
                                <div class="order-head-right">
                                    <span class="arrow" id="arrow-${order.id}" ${arrowRotate}>â–¼</span>
                                </div>
                            </div>

                            <div id="detail-${order.id}" class="${detailClass}">
                                <div class="mb-3">
                                    ${(order.items || []).map(i => `<span class="item-badge">${i.name} x ${i.quantity || i.qty}</span>`).join('')}
                                </div>

                                <div class="time-box mb-3">
                                    <div>ğŸ•’ ä¸‹å–®ï¼š${new Date(order.created_at).toLocaleTimeString()}</div>
                                    <div class="mt-2 fw-bold text-danger fs-5">ç¸½é¡ï¼š$${order.total}</div>
                                </div>

                                <div id="btn-zone-${order.id}">
                                    ${actionBtn}
                                </div>
                            </div>
                        </div>
                    `;
                });
                list.innerHTML = html;
                isFirstLoad = false;
            })
            .catch(err => console.error("è¼‰å…¥å¤±æ•—", err));
    }

    function toggleDetail(id) {
        const d = document.getElementById(`detail-${id}`), a = document.getElementById(`arrow-${id}`);
        if(d){ d.classList.toggle('hide-detail'); a.style.transform = d.classList.contains('hide-detail')?'rotate(0deg)':'rotate(180deg)'; }
    }

    function getStatusText(s) { 
        const map = { 'pending': 'å¾…ä»˜', 'confirmed': 'å·²ä»˜', 'preparing': 'è£½ä½œä¸­', 'completed': 'é€šçŸ¥ä¸­', 'arrived': 'åˆ°æ«ƒ', 'final': 'çµæ¡ˆ', 'cancelled': 'å–æ¶ˆ' }; 
        return map[s] || s; 
    }

    function openStatusBoard() {
        if (!currentStore) return Swal.fire('è«‹å…ˆé¸æ“‡åˆ†åº—');
        window.open(`/status/${currentStore}/`, '_blank');
    }

    function goToReport() {
        if(!currentStore) return Swal.fire('è«‹å…ˆé¸æ“‡åˆ†åº—');
        window.location.href = '/dashboard/?store=' + currentStore;
    }

    function getCookie(n) { let v = document.cookie.match('(^|;) ?' + n + '=([^;]*)(;|$)'); return v ? decodeURIComponent(v[2]) : null; }

    function updateStatus(id, status) {
        fetch(`/api/orders/${id}/`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
            body: JSON.stringify({ status: status })
        }).then(res => { 
            if(res.ok) { 
                loadOrders(); 
                if(status==='final') speak("è¨‚å–®å·²çµæ¡ˆ"); 
            } 
        });
    }

    function cancelOrder(id) {
        Swal.fire({
            title: 'å–æ¶ˆè¨‚å–®?', 
            text: "è‹¥æ˜¯ LINE Pay å°‡è‡ªå‹•é€€æ¬¾", 
            icon: 'warning', 
            showCancelButton: true, 
            confirmButtonColor: '#d33', 
            confirmButtonText: 'ç¢ºå®šå–æ¶ˆ'
        }).then((res) => {
            if (res.isConfirmed) {
                fetch(`/api/orders/${id}/cancel/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') }
                }).then(r => r.json()).then(d => {
                    Swal.fire(d.error?'å¤±æ•—':'æˆåŠŸ', d.error||'è¨‚å–®å·²å–æ¶ˆ', d.error?'error':'success');
                    loadOrders();
                });
            }
        });
    }

    function confirmAction(id, status, msg) {
        Swal.fire({ title: msg, icon: 'question', showCancelButton: true, confirmButtonText: 'ç¢ºèª' })
            .then(r => { if(r.isConfirmed) updateStatus(id, status); });
    }
</script>
</body>
</html>