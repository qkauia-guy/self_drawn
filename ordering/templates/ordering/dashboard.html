<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>è²¡å‹™å ±è¡¨ä¸­å¿ƒ - ä¸€æŠŠè‘«</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7f6; font-family: "Microsoft JhengHei", sans-serif; }
        .navbar { background-color: #d63031 !important; }
        .card-stat { border: none; border-radius: 16px; transition: transform 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .card-stat:hover { transform: translateY(-5px); }
        .rev-value { font-size: 1.8rem; letter-spacing: -1px; }
        .store-badge { background-color: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 4px 12px; border-radius: 20px; font-size: 0.9rem; }
        
        /* Tabs Style */
        .nav-tabs .nav-link { color: #636e72; font-weight: bold; border: none; border-bottom: 3px solid transparent; }
        .nav-tabs .nav-link.active { color: #d63031; border-bottom: 3px solid #d63031; background-color: transparent; }
        .nav-tabs .nav-link:hover { color: #d63031; }
        
        .qty-badge { font-size: 0.9rem; padding: 0.5em 0.8em; width: 80px; }
        .item-rev { font-size: 0.95rem; color: #636e72; font-weight: bold; margin-top: 4px; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark mb-4 shadow-sm">
    <div class="container d-flex justify-content-between">
        <a class="navbar-brand fw-bold" href="/owner/">â¬…ï¸ è¿”å›è¨‚å–®ç®¡ç†</a>
        <div class="store-badge" id="current_store_name">æ­£åœ¨è¼‰å…¥...</div>
    </div>
</nav>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="fw-bold mb-0">ğŸ“Š ç‡Ÿæ¥­æ•¸æ“šæ¦‚è¦½</h3>
        <button class="btn btn-outline-danger btn-sm fw-bold" onclick="fetchStats()">ğŸ”„ é‡æ–°æ•´ç†</button>
    </div>
    
    <div class="row g-3 mb-4">
        <div class="col-6">
            <div class="card card-stat text-white" style="background: linear-gradient(135deg, #0984e3, #74b9ff);">
                <div class="card-body p-3 text-center">
                    <small class="opacity-75">ä»Šæ—¥ç¸½æ”¶</small>
                    <div class="rev-value fw-bold" id="day_rev">$0</div>
                    <div class="small mt-1"><span id="day_count">0</span> ç­†è¨‚å–®</div>
                </div>
            </div>
        </div>
        <div class="col-6">
            <div class="card card-stat text-white" style="background: linear-gradient(135deg, #2d3436, #636e72);">
                <div class="card-body p-3 text-center">
                    <small class="opacity-75">æœ¬æœˆç´¯è¨ˆ</small>
                    <div class="rev-value fw-bold" id="month_rev">$0</div>
                    <div class="small mt-1"><span id="month_count">0</span> ç­†è¨‚å–®</div>
                </div>
            </div>
        </div>
    </div>

    <ul class="nav nav-tabs nav-fill mb-3" id="statsTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="today-tab" data-bs-toggle="tab" data-bs-target="#today-content" type="button" role="tab">
                ğŸ“… ä»Šæ—¥éŠ·å”®ç´°é …
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="month-tab" data-bs-toggle="tab" data-bs-target="#month-content" type="button" role="tab">
                ğŸ—“ï¸ æœ¬æœˆéŠ·å”®ç´°é …
            </button>
        </li>
    </ul>

    <div class="tab-content mb-5" id="statsTabContent">
        
        <div class="tab-pane fade show active" id="today-content" role="tabpanel">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white py-3 border-0">
                    <h6 class="fw-bold mb-0 text-primary">â–¼ é»æ“Šé¡åˆ¥æŸ¥çœ‹ã€ä»Šæ—¥ã€‘ç´°é …</h6>
                </div>
                <div class="table-responsive">
                    <table class="table align-middle mb-0">
                        <thead class="bg-light text-muted small">
                            <tr><th class="ps-4">å“é …é¡åˆ¥</th><th class="text-end pe-4">ä»Šæ—¥æ¥­ç¸¾</th></tr>
                        </thead>
                        <tbody id="today_table_body">
                            <tr><td colspan="2" class="text-center py-4">è¼‰å…¥ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="month-content" role="tabpanel">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white py-3 border-0">
                    <h6 class="fw-bold mb-0 text-secondary">â–¼ é»æ“Šé¡åˆ¥æŸ¥çœ‹ã€æœ¬æœˆã€‘ç´°é …</h6>
                </div>
                <div class="table-responsive">
                    <table class="table align-middle mb-0">
                        <thead class="bg-light text-muted small">
                            <tr><th class="ps-4">å“é …é¡åˆ¥</th><th class="text-end pe-4">æœ¬æœˆç´¯ç©</th></tr>
                        </thead>
                        <tbody id="month_table_body">
                             <tr><td colspan="2" class="text-center py-4">è¼‰å…¥ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <div class="text-center text-muted small pb-4">
        æœ€å¾Œæ›´æ–°æ™‚é–“ï¼š<span id="update_time">-</span>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
const urlParams = new URLSearchParams(window.location.search);
const currentStore = urlParams.get('store') || 'dajin';

// è¼”åŠ©å‡½å¼ï¼šç”¢ç”Ÿå±•é–‹çš„ç´°é … HTML
// itemId: å”¯ä¸€è­˜åˆ¥ç¢¼ (é¿å…ä»Šæ—¥è·Ÿæœ¬æœˆè¡çª)
// detailsObj: ç´°é …è³‡æ–™ç‰©ä»¶ { "å“é …å": {qty, rev} }
// themeColor: é¡è‰²æ¨£å¼ (ä»Šæ—¥ç”¨ danger, æœ¬æœˆç”¨ secondary)
function generateDetailsHtml(itemId, detailsObj, themeColor) {
    const sortedDetails = Object.entries(detailsObj || {}).sort((a, b) => b[1].qty - a[1].qty);
    const borderClass = `border-${themeColor}`;
    const textClass = `text-${themeColor}`; // æ¨™é¡Œé¡è‰²

    if (sortedDetails.length === 0) {
        return `
        <tr class="collapse bg-light" id="${itemId}">
            <td colspan="2" class="text-center text-muted small py-3">å°šç„¡éŠ·å”®ç´€éŒ„</td>
        </tr>`;
    }

    const listItems = sortedDetails.map(([prodName, stat]) => `
        <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent px-0 py-1">
            <span>${prodName}</span>
            <span class="fw-bold text-dark">
                ${stat.qty} <span class="text-muted" style="font-size:0.8em">($${stat.rev.toLocaleString()})</span>
            </span>
        </li>
    `).join('');

    return `
    <tr class="collapse bg-light" id="${itemId}">
        <td colspan="2" class="p-0">
            <div class="p-3 border-start border-4 ${borderClass}">
                <ul class="list-group list-group-flush small">
                    ${listItems}
                </ul>
            </div>
        </td>
    </tr>`;
}

function fetchStats() {
    fetch(`/api/orders/dashboard_stats/?store=${currentStore}&t=${new Date().getTime()}`)
    .then(res => {
        if (res.status === 401 || res.status === 403) { window.location.href = '/admin/login/'; return; }
        return res.json();
    })
    .then(data => {
        if (!data) return;

        // æ›´æ–°é ‚éƒ¨æ•¸æ“š
        document.getElementById('current_store_name').innerText = data.store_name || 'æœªçŸ¥åˆ†åº—';
        document.getElementById('day_rev').innerText = '$' + (data.today.revenue || 0).toLocaleString();
        document.getElementById('day_count').innerText = data.today.orders || 0;
        document.getElementById('month_rev').innerText = '$' + (data.monthly.revenue || 0).toLocaleString();
        document.getElementById('month_count').innerText = data.monthly.orders || 0;
        document.getElementById('update_time').innerText = data.update_time;

        const itemsConfig = [
            { name: 'ğŸ¥› é£²å“ç³»åˆ—', key: 'drink' },
            { name: 'ğŸ¡ Qè»Ÿéº»ç³¬ç³»åˆ—', key: 'mochi' },
            { name: 'ğŸ“ å…ƒå¯¶è‰è“å¤§ç¦', key: 'ichikomochi' },
            { name: 'ğŸ° è‰è“ç”œé»', key: 'dessert' }
        ];
        
        let todayHtml = '';
        let monthHtml = '';
        
        itemsConfig.forEach((item) => {
            // å–å¾—è³‡æ–™ï¼Œè‹¥ç„¡å‰‡çµ¦é è¨­å€¼
            const todayItem = (data.today.items && data.today.items[item.key]) || { qty: 0, rev: 0, details: {} };
            const monthItem = (data.monthly.items && data.monthly.items[item.key]) || { qty: 0, rev: 0, details: {} };
            
            // --- 1. ç”¢ç”Ÿã€ä»Šæ—¥ã€‘å€å¡Š ---
            const todayId = `collapse-today-${item.key}`;
            const todayDetailsHtml = generateDetailsHtml(todayId, todayItem.details, 'danger'); // ç´…è‰²ä¸»é¡Œ

            todayHtml += `
            <tr style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#${todayId}" aria-expanded="false">
                <td class="ps-4">
                    <div class="fw-bold text-dark">${item.name} <span class="text-danger small">â–¾</span></div>
                </td>
                <td class="text-end pe-4">
                    <span class="badge bg-danger rounded-pill qty-badge">${todayItem.qty} ä»½</span>
                    <div class="item-rev">$${todayItem.rev.toLocaleString()}</div>
                </td>
            </tr>
            ${todayDetailsHtml}
            `;

            // --- 2. ç”¢ç”Ÿã€æœ¬æœˆã€‘å€å¡Š (ç¾åœ¨ä¹Ÿæ”¯æ´å±•é–‹äº†) ---
            const monthId = `collapse-month-${item.key}`;
            // å‡è¨­ monthItem.details å­˜åœ¨ã€‚å¦‚æœ API æ²’å›å‚³ detailsï¼Œåˆ—è¡¨æœƒé¡¯ç¤º "å°šç„¡éŠ·å”®ç´€éŒ„"
            const monthDetailsHtml = generateDetailsHtml(monthId, monthItem.details, 'secondary'); // ç°è‰²ä¸»é¡Œ

            monthHtml += `
            <tr style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#${monthId}" aria-expanded="false">
                <td class="ps-4">
                    <div class="fw-bold text-dark">${item.name} <span class="text-secondary small">â–¾</span></div>
                </td>
                <td class="text-end pe-4">
                    <span class="badge bg-secondary rounded-pill qty-badge">${monthItem.qty} ä»½</span>
                    <div class="item-rev">$${monthItem.rev.toLocaleString()}</div>
                </td>
            </tr>
            ${monthDetailsHtml}
            `;
        });

        document.getElementById('today_table_body').innerHTML = todayHtml;
        document.getElementById('month_table_body').innerHTML = monthHtml;
    })
    .catch(err => {
        console.error("è¼‰å…¥å¤±æ•—:", err);
    });
}

fetchStats();
</script>

</body>
</html>