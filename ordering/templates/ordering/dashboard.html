<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>è²¡å‹™å ±è¡¨ä¸­å¿ƒ - ä¸€æŠŠè‘«</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    {% load static %}
    <link rel="icon" href="{% static 'images/favicon6.png' %}" type="image/png">
    <style>
        body { background-color: #f4f7f6; font-family: "Microsoft JhengHei", sans-serif; }
        .navbar { background-color: #d63031 !important; }
        .card-stat { border: none; border-radius: 16px; transition: transform 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .card-stat:hover { transform: translateY(-5px); }
        .rev-value { font-size: 1.8rem; letter-spacing: -1px; }
        .store-badge { background-color: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 4px 12px; border-radius: 20px; font-size: 0.9rem; }
        
        /* Tabs Style */
        .nav-tabs .nav-link { color: #636e72; font-weight: bold; border: none; border-bottom: 3px solid transparent; }
        .nav-tabs .nav-link.active { color: #d63031; border-bottom: 3px solid #d63031; background-color: transparent; }
        .nav-tabs .nav-link:hover { color: #d63031; }
        
        .qty-badge { font-size: 0.9rem; padding: 0.5em 0.8em; width: 80px; }
        .item-rev { font-size: 0.95rem; color: #636e72; font-weight: bold; margin-top: 4px; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark mb-4 shadow-sm">
    <div class="container d-flex justify-content-between">
        <a class="navbar-brand fw-bold" href="/owner/">â¬…ï¸ è¿”å›è¨‚å–®ç®¡ç†</a>
        <div class="store-badge" id="current_store_name">æ­£åœ¨è¼‰å…¥...</div>
    </div>
</nav>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="fw-bold mb-0">ğŸ“Š ç‡Ÿæ¥­æ•¸æ“šæ¦‚è¦½</h3>
        <button class="btn btn-outline-danger btn-sm fw-bold" onclick="fetchStats()">ğŸ”„ é‡æ–°æ•´ç†</button>
    </div>
    
    <div class="row g-3 mb-4">
        <div class="col-6">
            <div class="card card-stat text-white" style="background: linear-gradient(135deg, #0984e3, #74b9ff);">
                <div class="card-body p-3 text-center">
                    <small class="opacity-75">ä»Šæ—¥ç¸½æ”¶</small>
                    <div class="rev-value fw-bold" id="day_rev">$0</div>
                    <div class="small mt-1"><span id="day_count">0</span> ç­†è¨‚å–®</div>
                </div>
            </div>
        </div>
        <div class="col-6">
            <div class="card card-stat text-white" style="background: linear-gradient(135deg, #2d3436, #636e72);">
                <div class="card-body p-3 text-center">
                    <small class="opacity-75">æœ¬æœˆç´¯è¨ˆ</small>
                    <div class="rev-value fw-bold" id="month_rev">$0</div>
                    <div class="small mt-1"><span id="month_count">0</span> ç­†è¨‚å–®</div>
                </div>
            </div>
        </div>
    </div>

    <ul class="nav nav-tabs nav-fill mb-3" id="statsTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="today-tab" data-bs-toggle="tab" data-bs-target="#today-content" type="button" role="tab">
                ğŸ“… ä»Šæ—¥éŠ·å”®ç´°é …
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="month-tab" data-bs-toggle="tab" data-bs-target="#month-content" type="button" role="tab">
                ğŸ—“ï¸ æœ¬æœˆéŠ·å”®ç´°é …
            </button>
        </li>
    </ul>

    <div class="tab-content mb-5" id="statsTabContent">
        
        <div class="tab-pane fade show active" id="today-content" role="tabpanel">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white py-3 border-0">
                    <h6 class="fw-bold mb-0 text-primary">â–¼ é»æ“Šé¡åˆ¥æŸ¥çœ‹ã€ä»Šæ—¥ã€‘ç´°é …</h6>
                </div>
                <div class="table-responsive">
                    <table class="table align-middle mb-0">
                        <thead class="bg-light text-muted small">
                            <tr><th class="ps-4">å“é …é¡åˆ¥</th><th class="text-end pe-4">ä»Šæ—¥æ¥­ç¸¾</th></tr>
                        </thead>
                        <tbody id="today_table_body">
                            <tr><td colspan="2" class="text-center py-4">è¼‰å…¥ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="month-content" role="tabpanel">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white py-3 border-0">
                    <h6 class="fw-bold mb-0 text-secondary">â–¼ é»æ“Šé¡åˆ¥æŸ¥çœ‹ã€æœ¬æœˆã€‘ç´°é …</h6>
                </div>
                <div class="table-responsive">
                    <table class="table align-middle mb-0">
                        <thead class="bg-light text-muted small">
                            <tr><th class="ps-4">å“é …é¡åˆ¥</th><th class="text-end pe-4">æœ¬æœˆç´¯ç©</th></tr>
                        </thead>
                        <tbody id="month_table_body">
                             <tr><td colspan="2" class="text-center py-4">è¼‰å…¥ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <div class="text-center text-muted small pb-4">
        æœ€å¾Œæ›´æ–°æ™‚é–“ï¼š<span id="update_time">-</span>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
const urlParams = new URLSearchParams(window.location.search);
const currentStore = urlParams.get('store') || 'dajin';

// è¼”åŠ©å‡½å¼ï¼šç”¢ç”Ÿå±•é–‹çš„ç´°é … HTML
function generateDetailsHtml(itemId, detailsObj, themeColor) {
    // å°‡ç´°é …è½‰ç‚ºé™£åˆ—ä¸¦æ’åº (éŠ·é‡é«˜ -> ä½)
    const sortedDetails = Object.entries(detailsObj || {}).sort((a, b) => b[1].qty - a[1].qty);
    const borderClass = `border-${themeColor}`;

    if (sortedDetails.length === 0) {
        return `
        <tr class="collapse bg-light" id="${itemId}">
            <td colspan="2" class="text-center text-muted small py-3">å°šç„¡éŠ·å”®ç´€éŒ„</td>
        </tr>`;
    }

    const listItems = sortedDetails.map(([prodName, stat]) => `
        <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent px-0 py-1">
            <span>${prodName}</span>
            <span class="fw-bold text-dark">
                ${stat.qty} <span class="text-muted" style="font-size:0.8em">($${stat.rev.toLocaleString()})</span>
            </span>
        </li>
    `).join('');

    return `
    <tr class="collapse bg-light" id="${itemId}">
        <td colspan="2" class="p-0">
            <div class="p-3 border-start border-4 ${borderClass}">
                <ul class="list-group list-group-flush small">
                    ${listItems}
                </ul>
            </div>
        </td>
    </tr>`;
}

// è¼”åŠ©å‡½å¼ï¼šç”¢ç”Ÿåˆ†é¡çš„ä¸»åˆ— HTML
function generateCategoryRowHtml(slug, data, type, themeColor) {
    const collapseId = `collapse-${type}-${slug}`;
    const badgeClass = `bg-${themeColor}`;
    const textClass = `text-${themeColor}`;
    
    // å¦‚æœè©²åˆ†é¡ç¸½æ¥­ç¸¾ç‚º 0ï¼Œé¡¯ç¤ºç¨å¾®æ·¡ä¸€é» (é¸æ“‡æ€§)
    const opacityClass = data.qty === 0 ? 'opacity-75' : '';

    return `
        <tr style="cursor: pointer;" class="${opacityClass}" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="false">
            <td class="ps-4">
                <div class="fw-bold text-dark">${data.name} <span class="${textClass} small">â–¾</span></div>
            </td>
            <td class="text-end pe-4">
                <span class="badge ${badgeClass} rounded-pill qty-badge">${data.qty} ä»½</span>
                <div class="item-rev">$${data.rev.toLocaleString()}</div>
            </td>
        </tr>
        ${generateDetailsHtml(collapseId, data.details, themeColor)}
    `;
}

function fetchStats() {
    // åŠ å…¥æ™‚é–“æˆ³è¨˜é˜²æ­¢å¿«å–
    fetch(`/api/orders/dashboard_stats/?store=${currentStore}&t=${new Date().getTime()}`)
    .then(res => {
        if (res.status === 401 || res.status === 403) { window.location.href = '/admin/login/'; return; }
        return res.json();
    })
    .then(data => {
        if (!data) return;

        // 1. æ›´æ–°é ‚éƒ¨ç¸½è¦½æ•¸æ“š
        document.getElementById('current_store_name').innerText = data.store_name || 'æœªçŸ¥åˆ†åº—';
        document.getElementById('day_rev').innerText = '$' + (data.today.revenue || 0).toLocaleString();
        document.getElementById('day_count').innerText = data.today.orders || 0;
        document.getElementById('month_rev').innerText = '$' + (data.monthly.revenue || 0).toLocaleString();
        document.getElementById('month_count').innerText = data.monthly.orders || 0;
        document.getElementById('update_time').innerText = data.update_time;

        // 2. å‹•æ…‹ç”Ÿæˆã€ä»Šæ—¥ã€‘åˆ—è¡¨
        // ç›´æ¥éæ­· API å›å‚³çš„ items ç‰©ä»¶ (key=slug, value=è³‡æ–™ç‰©ä»¶)
        let todayHtml = '';
        const todayItems = data.today.items || {};
        
        // ä½¿ç”¨ Object.entries å°‡ç‰©ä»¶è½‰ç‚ºé™£åˆ—ä»¥ä¾¿æ“ä½œ
        // é›–ç„¶ç‰©ä»¶æ²’æœ‰é †åºï¼Œä½†å¾Œç«¯å»ºç«‹å­—å…¸æ™‚é€šå¸¸æ˜¯ä¾ç…§æŸ¥è©¢é †åºåŠ å…¥çš„ (Python 3.7+ ä¿ç•™æ’å…¥é †åº)
        // å¦‚æœéœ€è¦æ›´åš´è¬¹çš„æ’åºï¼Œå¯ä»¥åœ¨é€™è£¡ sort
        Object.entries(todayItems).forEach(([slug, itemData]) => {
            todayHtml += generateCategoryRowHtml(slug, itemData, 'today', 'danger');
        });
        document.getElementById('today_table_body').innerHTML = todayHtml || '<tr><td colspan="2" class="text-center py-4">å°šç„¡è³‡æ–™</td></tr>';

        // 3. å‹•æ…‹ç”Ÿæˆã€æœ¬æœˆã€‘åˆ—è¡¨
        let monthHtml = '';
        const monthItems = data.monthly.items || {};
        
        Object.entries(monthItems).forEach(([slug, itemData]) => {
            monthHtml += generateCategoryRowHtml(slug, itemData, 'month', 'secondary');
        });
        document.getElementById('month_table_body').innerHTML = monthHtml || '<tr><td colspan="2" class="text-center py-4">å°šç„¡è³‡æ–™</td></tr>';
    })
    .catch(err => {
        console.error("è¼‰å…¥å¤±æ•—:", err);
        // å¯ä»¥åŠ å€‹ SweetAlert æç¤º
    });
}

// å•Ÿå‹•è¼‰å…¥
fetchStats();
</script>

</body>
</html>