<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    {% load static %}
    <link rel="icon" href="{% static 'images/favicon.png' %}" type="image/png">
    <title>{{ store.name }} | ç¾å ´å«è™Ÿçœ‹æ¿</title>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --ready-color: #4caf50;
            --preparing-color: #ff9800;
            --text-main: #ffffff;
        }

        body, html {
            margin: 0; padding: 0; height: 100%;
            background-color: var(--bg-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            overflow: hidden; 
        }

        #audio-unlock-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; transition: opacity 0.5s ease;
        }

        .start-btn {
            padding: 25px 60px; font-size: 2rem; font-weight: bold;
            background-color: #ff4d4d; color: white; border: none;
            border-radius: 50px; cursor: pointer; box-shadow: 0 0 20px rgba(255, 77, 77, 0.5);
        }

        .container { display: flex; flex-direction: column; height: 100vh; padding: 20px; box-sizing: border-box; }
        .header { text-align: center; padding-bottom: 10px; border-bottom: 2px solid #333; }
        .title { color: var(--text-main); font-size: 2.5rem; margin: 0; letter-spacing: 5px; }
        .store-badge { font-size: 1.2rem; color: #ff4d4d; margin-top: 5px; font-weight: bold; }

        .board { display: flex; flex: 1; gap: 20px; margin-top: 20px; height: 0; }
        .column { flex: 1; background-color: var(--card-bg); border-radius: 20px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 15px 35px rgba(0,0,0,0.6); }
        .column h2 { text-align: center; font-size: 2.2rem; padding: 15px; margin: 0; color: var(--text-main); border-bottom: 3px solid #333; }
        .ready h2 { background-color: rgba(76, 175, 80, 0.2); color: var(--ready-color); }
        .preparing h2 { background-color: rgba(255, 152, 0, 0.2); color: var(--preparing-color); }
        
        .number-list { flex: 1; display: grid; grid-template-columns: repeat(2, 1fr); grid-auto-rows: min-content; gap: 15px; padding: 20px; overflow: hidden; align-content: start; }
        .order-number { background: #2a2a2a; color: var(--text-main); font-size: 4.5rem; font-weight: 900; text-align: center; padding: 25px 0; border-radius: 12px; animation: fadeIn 0.4s ease-out; }
        .ready .order-number { color: var(--ready-color); background: #1b261c; border: 3px solid var(--ready-color); animation: pulse 2s infinite, fadeIn 0.5s ease-out; }
        .preparing .order-number { color: var(--preparing-color); border: 2px solid var(--preparing-color); }

        @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4); } 70% { box-shadow: 0 0 0 20px rgba(76, 175, 80, 0); } 100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); } }
    </style>
</head>
<body>

<div id="audio-unlock-overlay">
    <h1 style="margin-bottom: 10px; letter-spacing: 3px;">ğŸ“ ä¸€æŠŠè‘«å«è™Ÿçœ‹æ¿</h1>
    <h2 style="margin-bottom: 30px; color: #ff4d4d;">{{ store.name }}</h2>
    <button class="start-btn" onclick="initSystem()">é»æ“Šå•Ÿå‹•ç³»çµ±</button>
    <p style="margin-top: 20px; color: #888;">å•Ÿå‹•å¾Œè«‹å‹¿é‡æ•´ç¶²é ï¼ŒèªéŸ³å°‡è‡ªå‹•é‹ä½œ</p>
</div>

<div class="container">
    <div class="header">
        <h1 class="title">ğŸ“ ä¸€æŠŠè‘« | ç¾å ´å«è™Ÿ</h1>
        <div class="store-badge">{{ store.name }}</div>
    </div>
    
    <div class="board">
        <div class="column ready">
            <h2>è«‹å–é¤ Ready</h2>
            <div id="ready-list" class="number-list"></div>
        </div>

        <div class="column preparing">
            <h2>è£½ä½œä¸­ Preparing</h2>
            <div id="preparing-list" class="number-list"></div>
        </div>
    </div>
</div>

<script>
    // --- åˆ†åº—è­˜åˆ¥é‚è¼¯ ---
    // ç¶²å€æ ¼å¼ç‚º /status/dajin/ï¼ŒpathParts åˆ†è§£å¾Œå–æœ€å¾Œä¸€éƒ¨åˆ†
    const pathParts = window.location.pathname.split('/').filter(p => p);
    const currentStoreSlug = pathParts[pathParts.length - 1];

    let previousReadyNumbers = new Set();
    let isFirstLoad = true;
    let isSystemStarted = false;

    function initSystem() {
        isSystemStarted = true;
        document.getElementById('audio-unlock-overlay').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('audio-unlock-overlay').style.display = 'none';
        }, 500);

        // å•Ÿå‹•èªéŸ³å¼•æ“
        const silentMsg = new SpeechSynthesisUtterance("");
        window.speechSynthesis.speak(silentMsg);

        updateBoard();
        setInterval(updateBoard, 4000);
    }

    function speakOrder(newNumbers) {
        newNumbers.forEach(num => {
            const msg = new SpeechSynthesisUtterance(`è«‹è¨‚å–®ç·¨è™Ÿ ${num} è™Ÿå–é¤`);
            msg.lang = 'zh-TW';
            msg.rate = 0.8; 
            msg.pitch = 1.0; 
            window.speechSynthesis.speak(msg);
        });
    }

    async function updateBoard() {
        if (!isSystemStarted) return;

        try {
            // åŠ å…¥ store åƒæ•¸éæ¿¾è©²åº—è¨‚å–®
            const response = await fetch(`/api/orders/latest/?store=${currentStoreSlug}&t=${new Date().getTime()}`);
            if (!response.ok) return;
            const orders = await response.json();
            
            const readyList = document.getElementById('ready-list');
            const preparingList = document.getElementById('preparing-list');
            
            let readyData = [];
            let preparingData = [];
            let currentReadyNumbers = new Set();

            const orderArray = Array.isArray(orders) ? orders : (orders.results || []);

            orderArray.forEach(order => {
                const orderId = `${order.id}`;

                // åªè™•ç†å®Œæˆ(ç­‰å¾…å–é¤)èˆ‡è£½ä½œä¸­çš„è¨‚å–®
                if (order.status === 'completed' || order.status === 'arrived') {
                    readyData.push(orderId);
                    currentReadyNumbers.add(orderId);
                } else if (order.status === 'preparing') {
                    preparingData.push(orderId);
                }
            });

            // é™åˆ¶çœ‹æ¿é¡¯ç¤ºæ•¸é‡ï¼ˆæœ€å¤š 8 ç­†ï¼‰
            const finalReady = readyData.slice(0, 8);
            const finalPreparing = preparingData.slice(0, 8);

            readyList.innerHTML = finalReady.map(num => `<div class="order-number">${num}</div>`).join('');
            preparingList.innerHTML = finalPreparing.map(num => `<div class="order-number">${num}</div>`).join('');

            // æ–°å¢è™Ÿç¢¼æ™‚æ‰èªéŸ³å«è™Ÿ
            if (!isFirstLoad) {
                const newNumbers = [...currentReadyNumbers].filter(num => !previousReadyNumbers.has(num));
                if (newNumbers.length > 0) {
                    speakOrder(newNumbers);
                }
            }

            previousReadyNumbers = currentReadyNumbers;
            isFirstLoad = false;
        } catch (error) {
            console.error('è³‡æ–™åŒæ­¥å¤±æ•—:', error);
        }
    }
</script>
</body>
</html>