<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

  <!-- iOS/iPadï¼šåŠ åˆ°ä¸»ç•«é¢æ™‚æ¯”è¼ƒæ¥è¿‘å…¨è¢å¹• -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="å«è™Ÿçœ‹æ¿">

  {% load static %}
  <link rel="icon" href="{% static 'images/favicon.png' %}" type="image/png">

  <title>{{ store.name }} | ç¾å ´å«è™Ÿçœ‹æ¿</title>

  <style>
    :root{
      --bg-color: #121212;
      --card-bg: #1e1e1e;
      --ready-color: #4caf50;
      --preparing-color: #ff9800;
      --text-main: #ffffff;
      --vh: 1vh;
    }

    body, html{
      margin: 0; padding: 0;
      height: 100%;
      background-color: var(--bg-color);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      overflow: hidden;
      overscroll-behavior: none;
      -webkit-overflow-scrolling: touch;
    }

    .container{
      display: flex;
      flex-direction: column;
      height: 100dvh;
      height: calc(var(--vh) * 100);
      padding: 20px;
      box-sizing: border-box;
    }

    #audio-unlock-overlay{
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.92);
      z-index: 9999;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      color: white;
      transition: opacity 0.5s ease;
      text-align: center;
      padding: 20px;
      box-sizing: border-box;
    }

    .start-btn{
      padding: 25px 60px;
      font-size: 2rem;
      font-weight: bold;
      background-color: #ff4d4d;
      color: white;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 0 20px rgba(255, 77, 77, 0.5);
    }

    .header{
      text-align: center;
      padding-bottom: 10px;
      border-bottom: 2px solid #333;
    }

    .title{
      color: var(--text-main);
      font-size: 2.5rem;
      margin: 0;
      letter-spacing: 5px;
    }

    .store-badge{
      font-size: 1.2rem;
      color: #ff4d4d;
      margin-top: 5px;
      font-weight: bold;
    }

    .board{
      display: flex;
      flex: 1;
      gap: 20px;
      margin-top: 20px;
      height: 0;
    }

    .column{
      flex: 1;
      background-color: var(--card-bg);
      border-radius: 20px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 15px 35px rgba(0,0,0,0.6);
    }

    .column h2{
      text-align: center;
      font-size: 2.2rem;
      padding: 15px;
      margin: 0;
      color: var(--text-main);
      border-bottom: 3px solid #333;
    }

    .ready h2{
      background-color: rgba(76, 175, 80, 0.2);
      color: var(--ready-color);
    }

    .preparing h2{
      background-color: rgba(255, 152, 0, 0.2);
      color: var(--preparing-color);
    }

    .number-list{
      flex: 1;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-auto-rows: min-content;
      gap: 15px;
      padding: 20px;
      overflow: hidden;
      align-content: start;
    }

    .order-number{
      background: #2a2a2a;
      color: var(--text-main);
      font-size: 4.5rem;
      font-weight: 900;
      text-align: center;
      padding: 25px 0;
      border-radius: 12px;
      animation: fadeIn 0.4s ease-out;
    }

    .ready .order-number{
      color: var(--ready-color);
      background: #1b261c;
      border: 3px solid var(--ready-color);
      animation: pulse 2s infinite, fadeIn 0.5s ease-out;
    }

    .preparing .order-number{
      color: var(--preparing-color);
      border: 2px solid var(--preparing-color);
    }

    @keyframes fadeIn{
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    @keyframes pulse{
      0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4); }
      70% { box-shadow: 0 0 0 20px rgba(76, 175, 80, 0); }
      100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
    }

    @media (max-width: 900px){
      .title{ font-size: 2rem; letter-spacing: 3px; }
      .column h2{ font-size: 1.8rem; }
      .order-number{ font-size: 3.8rem; padding: 18px 0; }
    }
  </style>
</head>

<body>
  <!-- Debug å€ï¼šç¾å ´å¿«é€Ÿåˆ¤æ–·èªéŸ³æ˜¯å¦å°±ç·’ -->
  <!-- <div id="tts-debug" style="color:#aaa;font-size:14px;text-align:center;margin-top:8px;"></div> -->

  <div id="audio-unlock-overlay">
    <h1 style="margin-bottom: 10px; letter-spacing: 3px;">ğŸ“ ä¸€æŠŠè‘«å«è™Ÿçœ‹æ¿</h1>
    <h2 style="margin-bottom: 30px; color: #ff4d4d;">{{ store.name }}</h2>
    <button class="start-btn" onclick="initSystem()">é»æ“Šå•Ÿå‹•ç³»çµ±</button>
    <p style="margin-top: 20px; color: #888;">å•Ÿå‹•å¾Œè«‹å‹¿é‡æ•´ç¶²é ï¼ŒèªéŸ³å°‡è‡ªå‹•é‹ä½œ</p>
    <p style="margin-top: 8px; color: #666; font-size: 0.95rem;">
      æç¤ºï¼šiPad æƒ³æ›´åƒå…¨è¢å¹•ï¼Œå»ºè­°ã€ŒåŠ å…¥ä¸»ç•«é¢ã€å¾Œå†é–‹å•Ÿ
    </p>
  </div>

  <div class="container">
    <div class="header">
      <h1 class="title">ğŸ“ ä¸€æŠŠè‘« | ç¾å ´å«è™Ÿ</h1>
      <div class="store-badge">{{ store.name }}åˆ†åº—</div>
    </div>

    <div class="board">
      <div class="column ready">
        <h2>è«‹å–é¤ Ready</h2>
        <div id="ready-list" class="number-list"></div>
      </div>

      <div class="column preparing">
        <h2>è£½ä½œä¸­ Preparing</h2>
        <div id="preparing-list" class="number-list"></div>
      </div>
    </div>
  </div>

  <script>
    // --- åˆ†åº—è­˜åˆ¥é‚è¼¯ ---
    const pathParts = window.location.pathname.split('/').filter(p => p);
    const currentStoreSlug = pathParts[pathParts.length - 1];

    let previousReadyNumbers = new Set();
    let isFirstLoad = true;
    let isSystemStarted = false;

    // âœ… ä¿®æ­£è¡Œå‹•ç€è¦½å™¨ 100vh å•é¡Œï¼ˆAndroid / iOS éƒ½æœ‰å¹«åŠ©ï¼‰
    function setVhUnit() {
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
    }
    setVhUnit();
    window.addEventListener('resize', setVhUnit);
    window.addEventListener('orientationchange', () => setTimeout(setVhUnit, 200));

    // âœ… å˜—è©¦é€²å…¥å…¨è¢å¹•ï¼ˆéœ€è¦ä½¿ç”¨è€…é»æ“Šè§¸ç™¼ï¼‰
    async function requestFullScreen() {
      const el = document.documentElement;
      try {
        if (el.requestFullscreen) return await el.requestFullscreen();
        if (el.webkitRequestFullscreen) return await el.webkitRequestFullscreen();
      } catch (e) {}
    }

    // =========================
    // âœ… TTSï¼ˆAndroid/iPadï¼‰
    // =========================
    const synth = window.speechSynthesis;
    const debugEl = document.getElementById('tts-debug');

    function debug(msg) {
      if (debugEl) debugEl.innerText = msg;
    }

    function sleep(ms) {
      return new Promise(r => setTimeout(r, ms));
    }

    function getVoicesSafe() {
      try { return (synth && synth.getVoices) ? (synth.getVoices() || []) : []; }
      catch(e){ return []; }
    }

    async function primeTTS() {
      if (!('speechSynthesis' in window)) {
        debug('âŒ speechSynthesis ä¸æ”¯æ´');
        return false;
      }

      /*
        ã€æ¸¬è©¦å‚™è¨» / ç¶“é©—ã€‘
        1) Android Chrome å¯èƒ½å‡ºç¾ speak error: synthesis-failedï¼ˆè¡¨ç¤ºåº•å±¤åˆæˆå¼•æ“å¤±æ•—/ä¸å¯ç”¨ï¼‰[MDN: SpeechSynthesisErrorEvent.error]ã€‚
           ä½† Samsung Internet åœ¨åŒä¸€å°è£ç½®å¯èƒ½æ­£å¸¸ï¼ˆä½ å·²é©—è­‰ï¼‰ã€‚[web:207]

        2) Chrome ç³»åˆ—å¸¸è¦‹ï¼šä¸€é–‹å§‹ getVoices() æœƒå›ç©ºï¼Œéœ€ç­‰ voiceschanged æ‰æœƒå‡ºç¾èªéŸ³æ¸…å–®ã€‚[web:219]

        3) speak() åœ¨å¾ˆå¤šç€è¦½å™¨å¿…é ˆåœ¨ã€Œä½¿ç”¨è€…äº’å‹•å¾Œã€è§¸ç™¼æ‰ç©©å®šï¼›æœ¬é ç”¨æŒ‰éˆ•å•Ÿå‹•ç¬¦åˆé€™å€‹é™åˆ¶ã€‚[web:222]

        4) ç‚ºäº†é¿å…é¸åˆ°ã€Œçœ‹å¾—åˆ°ä½†å£æ‰ã€çš„ voice é€ æˆ synthesis-failedï¼Œ
           é€™ä»½ç¨‹å¼åˆ»æ„ä¸æŒ‡å®š utterance.voiceï¼Œåªè¨­å®š utterance.langï¼Œè®“ç³»çµ±è‡ªè¡ŒæŒ‘é¸å¯ç”¨ voiceã€‚
      */

      // è§¸ç™¼è¼‰å…¥ voice åˆ—è¡¨
      synth.getVoices();

      // ç­‰ voiceschanged æˆ–é€¾æ™‚ï¼ˆåªåšæç¤ºï¼Œå¯¦éš›ä¸ç¡¬ä¾è³´ voices æ•¸é‡ï¼‰
      let resolved = false;

      const waitVoicesChanged = new Promise(resolve => {
        try {
          synth.onvoiceschanged = () => {
            if (resolved) return;
            resolved = true;
            debug(`â„¹ï¸ voiceschanged: voices=${getVoicesSafe().length}`);
            resolve(true);
          };
        } catch(e) {
          resolve(false);
        }
      });

      const timeout = (async () => {
        await sleep(1200);
        if (resolved) return true;
        resolved = true;
        debug(`â„¹ï¸ timeout: voices=${getVoicesSafe().length}`);
        try { synth.onvoiceschanged = null; } catch(e){}
        return true;
      })();

      await Promise.race([waitVoicesChanged, timeout]);

      // ç†±æ©Ÿï¼ˆå¾ˆå¤šè£ç½®ç¬¬ä¸€æ¬¡è¦å…ˆ speak ä¸€å¥æ‰æœƒé–‹å§‹å‡ºè²ï¼‰
      try {
        synth.cancel();
        const u = new SpeechSynthesisUtterance('ç³»çµ±å•Ÿå‹•');
        u.lang = 'zh-TW';
        u.rate = 0.95;
        u.pitch = 1.0;
        u.volume = 1;

        u.onstart = () => debug(`ğŸ”Š TTS start | voices=${getVoicesSafe().length} | voice=auto`);
        u.onend = () => debug('âœ… TTS ready');
        u.onerror = (e) => debug(`âŒ warmup error: ${e.error || 'unknown'}`);

        synth.speak(u);
      } catch (e) {
        debug('âŒ TTS warmup exception');
      }

      return true;
    }

    function speak(text) {
      if (!('speechSynthesis' in window)) return;

      try {
        // Android å¸¸è¦‹ï¼šqueue å¡ä½ => cancel å† speak
        synth.cancel();

        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'zh-TW';
        u.rate = 0.85;
        u.pitch = 1.0;
        u.volume = 1;

        // ä¸æŒ‡å®š u.voiceï¼ˆé¿å… Android/ä¸‰æ˜Ÿé¸åˆ°å£ voiceï¼‰
        u.onerror = (e) => debug(`âŒ speak error: ${e.error || 'unknown'}`);

        synth.speak(u);
      } catch (e) {
        debug('âŒ speak exception');
      }
    }

    function speakOrder(newNumbers) {
      // é€ç­†å«è™Ÿï¼ˆé¿å…ä¸€æ¬¡å¡å¤ªå¤šé€ æˆä¸è¬›ï¼‰
      newNumbers.forEach((num, idx) => {
        setTimeout(() => {
          speak(`è«‹è¨‚å–®ç·¨è™Ÿ ${num} è™Ÿå–é¤`);
        }, idx * 1200);
      });
    }

    // =========================
    // å•Ÿå‹•
    // =========================
    async function initSystem() {
      isSystemStarted = true;

      requestFullScreen();

      // éš±è— overlay
      const overlay = document.getElementById('audio-unlock-overlay');
      overlay.style.opacity = '0';
      setTimeout(() => { overlay.style.display = 'none'; }, 500);

      // âœ… TTS åˆå§‹åŒ–ï¼šä¸€å®šåœ¨ä½¿ç”¨è€…é»æ“Šå¾Œåš
      debug('â³ TTS åˆå§‹åŒ–ä¸­...');
      await primeTTS();

      updateBoard();
      setInterval(updateBoard, 4000);
    }

    async function updateBoard() {
      if (!isSystemStarted) return;

      try {
        const response = await fetch(`/api/orders/latest/?store=${currentStoreSlug}&t=${new Date().getTime()}`);
        if (!response.ok) return;

        const orders = await response.json();
        const readyList = document.getElementById('ready-list');
        const preparingList = document.getElementById('preparing-list');

        let readyData = [];
        let preparingData = [];
        let currentReadyNumbers = new Set();

        const orderArray = Array.isArray(orders) ? orders : (orders.results || []);

        orderArray.forEach(order => {
          const orderId = `${order.id}`;
          if (order.status === 'completed' || order.status === 'arrived') {
            readyData.push(orderId);
            currentReadyNumbers.add(orderId);
          } else if (order.status === 'preparing') {
            preparingData.push(orderId);
          }
        });

        const finalReady = readyData.slice(0, 8);
        const finalPreparing = preparingData.slice(0, 8);

        readyList.innerHTML = finalReady.map(num => `<div class="order-number">${num}</div>`).join('');
        preparingList.innerHTML = finalPreparing.map(num => `<div class="order-number">${num}</div>`).join('');

        if (!isFirstLoad) {
          const newNumbers = [...currentReadyNumbers].filter(num => !previousReadyNumbers.has(num));
          if (newNumbers.length > 0) speakOrder(newNumbers);
        }

        previousReadyNumbers = currentReadyNumbers;
        isFirstLoad = false;
      } catch (error) {
        console.error('è³‡æ–™åŒæ­¥å¤±æ•—:', error);
        debug('âŒ API åŒæ­¥å¤±æ•—ï¼ˆè«‹çœ‹ consoleï¼‰');
      }
    }
  </script>
</body>
</html>
