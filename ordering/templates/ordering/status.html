<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="å«è™Ÿçœ‹æ¿">

  {% load static %}
  <link rel="icon" href="{% static 'images/favicon5.png' %}" type="image/png">

  <title>{{ store.name }} | ç¾å ´å«è™Ÿçœ‹æ¿</title>

  <style>
    :root{
      --bg-color: #121212;
      --card-bg: #1e1e1e;
      --ready-color: #4caf50;
      /* ç¨å¾®èª¿ä½é€æ˜åº¦ï¼Œé…åˆæ¯›ç»ç’ƒ */
      --ready-glow: rgba(76, 175, 80, 0.4);
      --preparing-color: #ff9800;
      --preparing-glow: rgba(255, 152, 0, 0.4);
      --text-main: #ffffff;
      --vh: 1vh;
    }

    body, html{
      margin: 0; padding: 0;
      height: 100%;
      background-color: var(--bg-color);
      /* åŠ å…¥ä¸€é»é»æ¼¸å±¤èƒŒæ™¯ï¼Œè®“æ¯›ç»ç’ƒæ•ˆæœæ›´æ˜é¡¯ */
      background-image: radial-gradient(circle at 50% 50%, #1a1a1a 0%, #000000 100%);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      overflow: hidden;
      overscroll-behavior: none;
      -webkit-overflow-scrolling: touch;
      transition: background-color 0.3s;
    }

    /* è¢å¹•é–ƒçˆå‹•ç•« */
    @keyframes screen-flash {
      0% { box-shadow: inset 0 0 0 0 rgba(255, 255, 255, 0); }
      50% { box-shadow: inset 0 0 150px 50px rgba(255, 255, 255, 0.5); }
      100% { box-shadow: inset 0 0 0 0 rgba(255, 255, 255, 0); }
    }

    .flashing {
      animation: screen-flash 0.6s ease-in-out 3;
    }

    .container{
      display: flex;
      flex-direction: column;
      height: 100dvh;
      height: calc(var(--vh) * 100);
      padding: 20px;
      box-sizing: border-box;
      position: relative;
      z-index: 1;
    }

    #audio-unlock-overlay{
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.92);
      z-index: 9999;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      color: white;
      transition: opacity 0.5s ease;
      text-align: center;
      padding: 20px;
      box-sizing: border-box;
    }

    .start-btn{
      padding: 25px 60px;
      font-size: 2rem;
      font-weight: bold;
      background-color: #ff4d4d;
      color: white;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 0 20px rgba(255, 77, 77, 0.5);
    }

    .header{
      text-align: center;
      padding-bottom: 10px;
      border-bottom: 2px solid #333;
    }

    .title{
      color: var(--text-main);
      font-size: 2.5rem;
      margin: 0;
      letter-spacing: 5px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }

    .store-badge{
      font-size: 1.2rem;
      color: #ff4d4d;
      margin-top: 5px;
      font-weight: bold;
    }

    .board{
      display: flex;
      flex: 1;
      gap: 20px;
      margin-top: 20px;
      height: 0;
    }

    .column{
      flex: 1;
      /* è®“åº•æ¿ç¨å¾®æ·±è‰²ä¸€é»ï¼Œè¥¯æ‰˜ä¸Šé¢çš„æ¯›ç»ç’ƒæ•¸å­— */
      background-color: rgba(30, 30, 30, 0.6);
      border-radius: 20px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 15px 35px rgba(0,0,0,0.6);
    }

    .column h2{
      text-align: center;
      font-size: 2.2rem;
      padding: 15px;
      margin: 0;
      color: var(--text-main);
      border-bottom: 2px solid rgba(255, 255, 255, 0.1);
    }

    .ready h2{
      background-color: rgba(76, 175, 80, 0.15); /* é™ä½é€æ˜åº¦ */
      color: var(--ready-color);
      text-shadow: none;
    }

    .preparing h2{
      background-color: rgba(255, 152, 0, 0.15);
      color: var(--preparing-color);
      text-shadow: none;
    }

    .number-list{
      flex: 1;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-template-rows: repeat(4, 1fr);
      gap: 15px;
      padding: 20px;
      overflow: hidden;
      align-content: start;
    }

    /* â–¼â–¼â–¼ æ¯›ç»ç’ƒæ•¸å­—æ¡†è¨­å®š â–¼â–¼â–¼ */
    .order-number{
      /* 1. éœ§é¢æ¨¡ç³Šæ•ˆæœ (æ ¸å¿ƒ) */
      backdrop-filter: blur(12px); 
      -webkit-backdrop-filter: blur(12px); /* ç›¸å®¹ Safari */
      
      /* 2. åŠé€æ˜èƒŒæ™¯ (é€™æ˜¯åŸºåº•ï¼Œä¸ç”¨å¤ªæ·±) */
      background: rgba(255, 255, 255, 0.05);
      
      /* 3. ç»ç’ƒé‚Šæ¡†æ„Ÿ */
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      
      color: var(--text-main);
      font-size: 4.5rem;
      font-weight: 900;
      text-align: center;
      padding: 25px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      
      /* 4. æŸ”å’Œé™°å½± */
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      
      animation: fadeIn 0.4s ease-out;
    }

    /* âœ¨ Ready (è«‹å–é¤) - ç¶ è‰²éœ§é¢ç»ç’ƒ */
    .ready .order-number{
      color: var(--ready-color);
      /* å¸¶ä¸€é»ç¶ è‰²çš„åŠé€æ˜èƒŒæ™¯ */
      background: rgba(76, 175, 80, 0.15);
      border: 1px solid rgba(76, 175, 80, 0.4); /* é‚Šæ¡†äº®ä¸€é» */
      
      /* æŸ”å’Œçš„æ–‡å­—å…‰æšˆ */
      text-shadow: 0 0 8px var(--ready-glow);
      
      /* å‘¼å¸æ•ˆæœ */
      animation: pulse 2s infinite, fadeIn 0.5s ease-out;
    }

    /* âœ¨ Preparing (è£½ä½œä¸­) - æ©˜è‰²éœ§é¢ç»ç’ƒ */
    .preparing .order-number{
      color: var(--preparing-color);
      /* å¸¶ä¸€é»æ©˜è‰²çš„åŠé€æ˜èƒŒæ™¯ */
      background: rgba(255, 152, 0, 0.1);
      border: 1px solid rgba(255, 152, 0, 0.4);
      
      text-shadow: 0 0 5px var(--preparing-glow);
    }

    @keyframes fadeIn{
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    @keyframes pulse{
      0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.2); border-color: rgba(76, 175, 80, 0.4); }
      50% { box-shadow: 0 0 15px rgba(76, 175, 80, 0.15); border-color: rgba(76, 175, 80, 0.7); }
      100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.2); border-color: rgba(76, 175, 80, 0.4); }
    }

    @media (max-width: 900px){
      .title{ font-size: 2rem; letter-spacing: 3px; }
      .column h2{ font-size: 1.8rem; }
      .order-number{ font-size: 3.8rem; padding: 18px 0; }
    }
</style>
</head>

<body>
  <div id="audio-unlock-overlay">
    <h1 style="margin-bottom: 10px; letter-spacing: 3px;">ğŸ“ ä¸€æŠŠè‘«å«è™Ÿçœ‹æ¿</h1>
    <h2 style="margin-bottom: 30px; color: #ff4d4d;">{{ store.name }}</h2>
    <button class="start-btn" onclick="initSystem()">é»æ“Šå•Ÿå‹•ç³»çµ±</button>
    <p style="margin-top: 20px; color: #888;">å•Ÿå‹•å¾Œè«‹å‹¿é‡æ•´ç¶²é ï¼ŒèªéŸ³å°‡è‡ªå‹•é‹ä½œ</p>
    <p style="margin-top: 8px; color: #666; font-size: 0.95rem;">
      æç¤ºï¼šiPad æƒ³æ›´åƒå…¨è¢å¹•ï¼Œå»ºè­°ã€ŒåŠ å…¥ä¸»ç•«é¢ã€å¾Œå†é–‹å•Ÿ
    </p>
  </div>

  <div class="container">
    <div class="header">
      <h1 class="title">ğŸ“ ä¸€æŠŠè‘« | ç¾å ´å«è™Ÿ</h1>
      <div class="store-badge">{{ store.name }}åˆ†åº—</div>
    </div>

    <div class="board">
      <div class="column ready">
        <h2>è«‹å–é¤ Ready</h2>
        <div id="ready-list" class="number-list"></div>
      </div>

      <div class="column preparing">
        <h2>è£½ä½œä¸­ Preparing</h2>
        <div id="preparing-list" class="number-list"></div>
      </div>
    </div>
  </div>

  <script>
    // --- åˆ†åº—è­˜åˆ¥é‚è¼¯ ---
    const pathParts = window.location.pathname.split('/').filter(p => p);
    const currentStoreSlug = pathParts[pathParts.length - 1];

    let previousReadyNumbers = new Set();
    let isFirstLoad = true;
    let isSystemStarted = false;
    let audioContext = null;

    // åˆ†é è®Šæ•¸
    let readyPageIndex = 0;
    let preparingPageIndex = 0;

    // ğŸ“¢ å»£æ’­ä½‡åˆ—æ§åˆ¶è®Šæ•¸
    let announcementQueue = []; // å¾…æ’­å ±çš„è™Ÿç¢¼é™£åˆ—
    let isAnnouncing = false;   // æ˜¯å¦æ­£åœ¨æ’­å ±ä¸­

    // ä¿®æ­£è¡Œå‹•ç€è¦½å™¨ 100vh å•é¡Œ
    function setVhUnit() {
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
    }
    setVhUnit();
    window.addEventListener('resize', setVhUnit);
    window.addEventListener('orientationchange', () => setTimeout(setVhUnit, 200));

    async function requestFullScreen() {
      const el = document.documentElement;
      try {
        if (el.requestFullscreen) return await el.requestFullscreen();
        if (el.webkitRequestFullscreen) return await el.webkitRequestFullscreen();
      } catch (e) {}
    }

    // =========================
    // âœ¨ éŸ³æ•ˆå¼•æ“ (æ”¹ç‚º Promise æ¨¡å¼)
    // =========================
    function playChime() {
      return new Promise((resolve) => {
        if (!audioContext) { resolve(); return; }
        if (audioContext.state === 'suspended') audioContext.resume();

        const now = audioContext.currentTime;

        // ç¬¬ä¸€è² "å®" (é«˜éŸ³ E5)
        const osc1 = audioContext.createOscillator();
        const gain1 = audioContext.createGain();
        osc1.type = 'sine'; osc1.frequency.setValueAtTime(659.25, now);
        gain1.gain.setValueAtTime(0.1, now); gain1.gain.exponentialRampToValueAtTime(0.001, now + 1.5);
        osc1.connect(gain1); gain1.connect(audioContext.destination);
        osc1.start(now); osc1.stop(now + 1.5);

        // ç¬¬äºŒè² "å’š" (ä½éŸ³ C5)
        const osc2 = audioContext.createOscillator();
        const gain2 = audioContext.createGain();
        osc2.type = 'sine'; osc2.frequency.setValueAtTime(523.25, now + 0.6);
        gain2.gain.setValueAtTime(0.1, now + 0.6); gain2.gain.exponentialRampToValueAtTime(0.001, now + 2.1);
        osc2.connect(gain2); gain2.connect(audioContext.destination);
        osc2.start(now + 0.6); osc2.stop(now + 2.1);

        // âœ¨ é—œéµï¼šç­‰å¾… 2.2 ç§’è®“è²éŸ³æ’­å®Œæ‰ resolve
        setTimeout(resolve, 2200);
      });
    }

    // =========================
    // âœ… TTS èªéŸ³ (æ”¹ç‚º Promise æ¨¡å¼)
    // =========================
    const synth = window.speechSynthesis;

    async function primeTTS() {
      if (!('speechSynthesis' in window)) return false;
      synth.getVoices();
      
      let resolved = false;
      const wait = new Promise(r => { 
        try { synth.onvoiceschanged = () => { if(!resolved){resolved=true; r(true);} }; } catch(e){r(false);} 
      });
      const timeout = (async () => { await new Promise(r=>setTimeout(r,1200)); if(resolved)return true; resolved=true; return true; })();
      await Promise.race([wait, timeout]);

      try {
        synth.cancel();
        const u = new SpeechSynthesisUtterance('ç³»çµ±å•Ÿå‹•');
        u.lang = 'zh-TW'; u.volume = 1;
        synth.speak(u);
      } catch (e) {}
      return true;
    }

    function speak(text) {
      return new Promise((resolve) => {
        if (!('speechSynthesis' in window)) { resolve(); return; }

        // âœ¨ é€™è£¡ã€ä¸èƒ½ã€‘å†å‘¼å« synth.cancel()ï¼Œå¦å‰‡æœƒåˆ‡æ–·ä¸Šä¸€å¥
        // æˆ‘å€‘ä¾è³´ Promise ä¾†ç¢ºä¿é †åº

        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'zh-TW';
        u.rate = 0.85; 
        u.volume = 1;

        // ç•¶è¬›å®Œè©±æ™‚ï¼Œé€šçŸ¥ Promise å®Œæˆ
        u.onend = () => resolve();
        
        // é˜²å‘†ï¼šå¦‚æœå‡ºéŒ¯æˆ–å¤ªä¹…æ²’å›æ‡‰ï¼Œå¼·åˆ¶å®Œæˆä»¥å…å¡æ­»
        u.onerror = () => resolve();
        setTimeout(resolve, 5000); // æœ€å¤šç­‰5ç§’

        synth.speak(u);
      });
    }

    // =========================
    // ğŸ“¢ å…¨æ–°ï¼šæ’éšŠæ’­å ±ç³»çµ±
    // =========================
    function addToAnnouncementQueue(newNumbers) {
      // 1. æŠŠæ–°è™Ÿç¢¼åŠ å…¥éšŠåˆ—
      announcementQueue.push(...newNumbers);
      
      // 2. è§¸ç™¼è¢å¹•é–ƒçˆ (æœ‰æ–°è™Ÿç¢¼å°±é–ƒ)
      document.body.classList.remove('flashing');
      void document.body.offsetWidth; // å¼·åˆ¶é‡ç¹ª
      document.body.classList.add('flashing');

      // 3. å¦‚æœç›®å‰æ²’æœ‰åœ¨æ’­å ±ï¼Œå°±é–‹å§‹è™•ç†éšŠåˆ—
      if (!isAnnouncing) {
        processQueue();
      }
    }

    async function processQueue() {
      if (announcementQueue.length === 0) {
        isAnnouncing = false;
        return;
      }

      isAnnouncing = true;

      // 1. å…ˆæ’­ã€Œå®å’šã€æç¤ºéŸ³
      await playChime();

      // 2. è¿´åœˆæ’­å ±æ‰€æœ‰åœ¨éšŠåˆ—ä¸­çš„è™Ÿç¢¼
      // (ä½¿ç”¨ while æ˜¯ç‚ºäº†è®“åœ¨æ’­å ±é€”ä¸­æ–°åŠ å…¥çš„è™Ÿç¢¼ä¹Ÿèƒ½æ¥çºŒæ’­å ±)
      while (announcementQueue.length > 0) {
        const num = announcementQueue.shift(); // å–å‡ºç¬¬ä¸€å€‹è™Ÿç¢¼
        
        // è¬›è©±ï¼šè«‹è¨‚å–®ç·¨è™Ÿ X è™Ÿå–é¤
        await speak(`è«‹è¨‚å–®ç·¨è™Ÿ ${num} è™Ÿå–é¤`);
        
        // ç¨å¾®åœé “ 0.5 ç§’å†è¬›ä¸‹ä¸€å¥ï¼Œæ¯”è¼ƒè‡ªç„¶
        await new Promise(r => setTimeout(r, 500));
      }

      isAnnouncing = false;
    }

    // =========================
    // å•Ÿå‹•
    // =========================
    async function initSystem() {
      isSystemStarted = true;
      requestFullScreen();
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      
      const overlay = document.getElementById('audio-unlock-overlay');
      overlay.style.opacity = '0';
      setTimeout(() => { overlay.style.display = 'none'; }, 500);

      await primeTTS();

      updateBoard();
      setInterval(updateBoard, 4000);
    }

    // =========================
    // æ ¸å¿ƒé‚è¼¯
    // =========================
    async function updateBoard() {
      if (!isSystemStarted) return;

      try {
        const response = await fetch(`/api/orders/latest/?store=${currentStoreSlug}&t=${new Date().getTime()}`);
        if (!response.ok) return;

        const orders = await response.json();
        
        let allReadyData = [];
        let allPreparingData = [];
        let currentReadyNumbers = new Set();

        const orderArray = Array.isArray(orders) ? orders : (orders.results || []);

        orderArray.forEach(order => {
          // âœ¨âœ¨âœ¨ ä¿®æ”¹è™•ï¼šå„ªå…ˆé¡¯ç¤ºæµæ°´è™Ÿ (ä¾‹å¦‚ 1, 2)ï¼Œç¢ºä¿èªéŸ³å’Œç•«é¢ä¸€è‡´ âœ¨âœ¨âœ¨
          const orderId = (order.daily_serial || order.id).toString();

          if (order.status === 'completed' || order.status === 'arrived') {
            allReadyData.push(orderId);
            currentReadyNumbers.add(orderId);
          } else if (order.status === 'preparing') {
            allPreparingData.push(orderId);
          }
        });

        // åµæ¸¬æ–°è™Ÿç¢¼ä¸¦åŠ å…¥æ’­å ±éšŠåˆ—
        if (!isFirstLoad) {
          const newNumbers = [...currentReadyNumbers].filter(num => !previousReadyNumbers.has(num));
          if (newNumbers.length > 0) {
            // åŠ å…¥æ’­å ±éšŠåˆ—
            addToAnnouncementQueue(newNumbers);
          }
        }

        // --- åˆ†é é‚è¼¯ (ä¿æŒä¸è®Š) ---
        function processPagination(data, pageIndex, headerSelector, defaultTitle) {
            const PAGE_SIZE = 8;
            const totalPages = Math.ceil(data.length / PAGE_SIZE) || 1;
            
            // å¦‚æœæ­£åœ¨æ’­å ±ä¸­ï¼Œå¼·åˆ¶ã€Œè«‹å–é¤ã€é¡¯ç¤ºç¬¬ä¸€é ï¼Œè®“å‰›å«è™Ÿçš„å®¢äººèƒ½çœ‹åˆ°
            if (isAnnouncing && defaultTitle.includes('Ready')) {
                pageIndex = 0;
            } else if (pageIndex >= totalPages) {
                pageIndex = 0;
            }

            const batch = data.slice(pageIndex * PAGE_SIZE, (pageIndex + 1) * PAGE_SIZE);
            const headerEl = document.querySelector(headerSelector);
            if (headerEl) {
                headerEl.innerText = totalPages > 1 ? `${defaultTitle} (${pageIndex + 1}/${totalPages})` : defaultTitle;
            }

            return {
                batchData: batch,
                nextIndex: (pageIndex + 1) % totalPages
            };
        }

        const readyResult = processPagination(allReadyData, readyPageIndex, '.ready h2', 'è«‹å–é¤ Ready');
        readyPageIndex = readyResult.nextIndex;
        renderList('ready-list', readyResult.batchData);

        const prepResult = processPagination(allPreparingData, preparingPageIndex, '.preparing h2', 'è£½ä½œä¸­ Preparing');
        preparingPageIndex = prepResult.nextIndex;
        renderList('preparing-list', prepResult.batchData);

        previousReadyNumbers = currentReadyNumbers;
        isFirstLoad = false;

      } catch (error) {
        console.error('è³‡æ–™åŒæ­¥å¤±æ•—:', error);
      }
    }

    function renderList(elementId, numbers) {
      const container = document.getElementById(elementId);
      const newHTML = numbers.map(num => `<div class="order-number animate-in">${num}</div>`).join('');
      if (container.innerHTML !== newHTML) {
         container.innerHTML = newHTML;
      }
    }
  </script>
</body>
</html>